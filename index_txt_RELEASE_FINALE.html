<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICILIA EFFICIENTE | Suite Gestionale v4.0 (Perfect)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #15803d; /* Green 700 */
            --bg-body: #f3f4f6;
            --sidebar-w: 280px;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-body); height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; background: #fff; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 20px; background: linear-gradient(135deg, #166534, #15803d); color: white; }
        .nav-link-custom { padding: 12px 20px; color: #4b5563; font-weight: 500; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-link-custom:hover { background: #f0fdf4; color: var(--primary); }
        .nav-link-custom.active { background: #dcfce7; color: #14532d; border-left-color: var(--primary); font-weight: 700; }
        
        /* MAIN */
        #main { margin-left: var(--sidebar-w); height: 100vh; overflow-y: auto; padding: 30px; }

        /* CARDS */
        .card-custom { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .card-header-c { padding: 15px 20px; border-bottom: 1px solid #f3f4f6; font-weight: 700; color: #1f2937; background: #fff; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .card-body-c { padding: 20px; }
        
        /* SECTION TITLES */
        .sec-title { font-size: 0.85rem; text-transform: uppercase; color: #6b7280; font-weight: 700; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; }

        /* TABLES */
        .table-input td { padding: 0; }
        .table-input input { width: 100%; border: none; padding: 8px 12px; background: transparent; }
        .table-input input:focus { background: #f0fdf4; outline: none; box-shadow: inset 0 0 0 2px var(--primary); }
        
        /* UTILS */
        .hidden { display: none !important; }
        .text-xs { font-size: 0.75rem; }
    
        
        /* VIEW SECTIONS - Navigation */
        .view-section { display: none; }
        #view-1 { display: block; }
        
        /* PROGRESS BAR */
        .progress-container { display: none; } /* Nascondi per layout pulito */
        
        /* RESULT BOX */
        .result-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .result-item:last-child { border-bottom: none; }
        .result-label { font-weight: 600; color: #4b5563; }
        .result-value { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
    
            .nav-link-custom i { margin-right: 8px; }
        
        /* NASCONDI PROGRESS/STEP INDICATOR */
        .progress-section,
        .step-indicator,
        .progress-container,
        .step-label { 
            display: none !important; 
        }
    
        /* Pulse animation per auto-save indicator */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    </head>
<body>

<div id="sidebar">
    <div class="brand">
        <h5 class="mb-0 fw-bold"><i class="fa-solid fa-leaf"></i> SICILIA EFFICIENTE</h5>
        <small class="opacity-75">Azione 2.1.2 PR FESR 2021-2027 - Riqualificazione energetica nelle imprese</small>
    </div>
    <div class="flex-grow-1 overflow-auto py-2">
        <div class="nav-link-custom active" onclick="goToStep(1)" id="nav-fase1"><i class="fa-solid fa-address-card me-2"></i> 1. Anagrafica</div>
        <div class="nav-link-custom" onclick="goToStep(2)" id="nav-fase2"><i class="fa-solid fa-calculator me-2"></i> 2. MOL & Asseverazione</div>
        <div class="nav-link-custom" onclick="goToStep(3)" id="nav-fase3"><i class="fa-solid fa-bolt me-2"></i> 3. Diagnosi & Costi</div>
        <div class="nav-link-custom" onclick="goToStep(4)" id="nav-fase4"><i class="fa-regular fa-file-pdf me-2"></i> 4. Istanza 2.1</div>
        <div class="nav-link-custom" onclick="goToStep(5)" id="nav-fase5"><i class="fa-solid fa-book-open me-2"></i> 5. Formulario F</div>
        <div class="nav-link-custom" onclick="goToStep(6)" id="nav-fase6"><i class="fa-solid fa-download me-2"></i> 6. Export</div>
    </div>
    <!-- FOOTER SIDEBAR - GESTIONE PROGETTO
    <div class="border-top" style="background: linear-gradient(135deg, #166534, #15803d); padding: 16px;">
        <div class="d-grid gap-2">
            <button class="btn btn-light btn-sm" onclick="nuovoProgetto()" style="font-weight: 500;">
                <i class="fas fa-file"></i> Nuovo
            </button>
            <button class="btn btn-light btn-sm" onclick="salvaProgettoSuFile()" style="font-weight: 500;">
                <i class="fas fa-save"></i> Salva Progetto
            </button>
            <button class="btn btn-light btn-sm" onclick="caricaProgettoDaFile()" style="font-weight: 500;">
                <i class="fas fa-folder-open"></i> Carica
            </button>
            <button class="btn btn-danger btn-sm" onclick="cancellaTutto()" title="Cancella tutti i dati e reset completo" style="font-weight: 500;">
                <i class="fas fa-trash-alt"></i> Cancella Tutto
            </button>
            <button class="btn btn-light btn-sm" onclick="ripristinaDefault()" style="font-weight: 500;">
                <i class="fas fa-undo"></i> Ripristina
            </button>
            <div class="text-center text-white mt-3" style="font-size: 0.75rem; opacity: 0.9;">
                <i class="fas fa-circle text-success" style="font-size: 0.5rem; animation: pulse 2s infinite;"></i> 
                <span class="ms-1">Auto-save attivo (ogni 30s)</span>
            </div>
        </div>-->
    </div>
</div>



<div id="main">

        <!-- Header
        <div class="header-section">
            <h1><i class="fas fa-leaf"></i> SICILIA EFFICIENTE</h1>
            <p>Assistente Completo per la Compilazione della Domanda</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">Azione 2.1.2 PR FESR 2021-2027 - Riqualificazione energetica nelle imprese</p>
        </div> -->
        
        <!-- Progress Bar -->
        <div class="progress-section" style="display:none !important;">
            <div class="step-indicator" style="display:none !important;">
                <div class="step-item active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Anagrafica</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">MOL</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Diagnosi</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Istanza</div>
                </div>
                <div class="step-item" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Formulario</div>
                </div>
                <div class="step-item" data-step="6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Export</div>
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content-section">
            <!-- Toolbar -->
            <div class="toolbar">
                <button class="btn btn-sm btn-outline-primary" onclick="nuovoProgetto()">
                    <i class="fas fa-file"></i> Nuovo
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="salvaProgettoSuFile()">
                    <i class="fas fa-save"></i> Salva Progetto
                </button>
                <label class="btn btn-sm btn-outline-info mb-0">
                    <i class="fas fa-folder-open"></i> Carica
                    <input type="file" id="fileCaricaProgetto" accept=".json" style="display: none;" onchange="caricaProgettoDaFile(event)">
                </label>
                <button class="btn btn-sm btn-outline-secondary" onclick="ripristinaBackupAutomatico()">
                    <i class="fas fa-history"></i> Ripristina Backup
                </button>
                <span class="ms-auto text-muted small" id="autoSaveStatus">
                    <i class="fas fa-circle text-success"></i> Auto-save attivo
                </span>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 1: DATI ANAGRAFICI E AMMISSIBILITÀ -->
            <!-- ============================================ -->
            <div id="view-1" class="view-section active">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-building"></i> Fase 1: Dati Anagrafici e Ammissibilità</h2>
                <p class="fase-subtitle">Inserimento dati completi dell'impresa e verifica requisiti di ammissibilità</p>
                
                <div class="alert-warning-custom">
                    <strong><i class="fas fa-exclamation-triangle"></i> Requisito Fondamentale:</strong>
                    L'unità produttiva deve essere attiva in Sicilia da almeno 1 anno alla data di presentazione della domanda.
                </div>
                
                <!-- Dati Impresa -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-building"></i> Dati Impresa</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label required">Ragione Sociale</label>
                            <input type="text" class="form-control" id="ragioneSociale" placeholder="Es: Esempio S.r.l.">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required">Partita IVA</label>
                            <input type="text" class="form-control" id="partitaIva" placeholder="IT12345678901" maxlength="13">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="codiceFiscale" placeholder="Codice Fiscale impresa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">PEC</label>
                            <input type="email" class="form-control" id="pec" placeholder="impresa@pec.it">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice ATECO Prevalente</label>
                            <input type="text" class="form-control" id="codiceAteco" placeholder="Es: 25.11.00">
                            <small class="text-muted">Esclusi settori: Agricoltura primaria, Pesca, Tabacco, ecc.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Dimensione Impresa</label>
                            <select class="form-select" id="dimensioneImpresa">
                                <option value="">-- Seleziona --</option>
                                <option value="micro">Microimpresa (< 10 dip., ≤ 2M€)</option>
                                <option value="piccola">Piccola Impresa (< 50 dip., ≤ 10M€)</option>
                                <option value="media">Media Impresa (< 250 dip., ≤ 50M€)</option>
                            </select>
                            <small class="text-muted">Grandi imprese escluse</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Forma Giuridica</label>
                            <select class="form-select" id="formaGiuridica" onchange="aggiornaSezione_DichRedditi()">
                                <option value="">-- Seleziona --</option>
                                <option value="srl">Società a Responsabilità Limitata (S.r.l.)</option>
                                <option value="spa">Società per Azioni (S.p.A.)</option>
                                <option value="snc">Società in Nome Colletivo (S.n.c.)</option>
                                <option value="sas">Società in Accomandita Semplice (S.a.s.)</option>
                                <option value="ditta">Ditta Individuale</option>
                                <option value="coop">Società Cooperativa</option>
                                <option value="saca">Società in Accomandita per Azioni (S.a.C.A.)</option>
                            </select>
                            <small class="text-muted" id="notaFormaGiuridica"></small>
                        </div>
                        <div class="col-md-6">
                            <!-- spazio riserva allineamento -->
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label required">Sede Legale (Indirizzo completo)</label>
                            <input type="text" class="form-control" id="sedeLegale" placeholder="Via, Numero Civico, CAP, Comune (Provincia)">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Anno Costituzione</label>
                            <input type="number" class="form-control" id="annoCostituzione" placeholder="Es: 2020" min="1900" max="2026">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Telefono</label>
                            <input type="tel" class="form-control" id="telefono" placeholder="+39 091 1234567">
                        </div>
                    </div>
                </div>
                
                <!-- Legale Rappresentante -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-user-tie"></i> Legale Rappresentante</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Nome</label>
                            <input type="text" class="form-control" id="lrNome" placeholder="Nome">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Cognome</label>
                            <input type="text" class="form-control" id="lrCognome" placeholder="Cognome">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="lrCF" placeholder="RSSMRA80A01H501X" maxlength="16">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Data di Nascita</label>
                            <input type="date" class="form-control" id="lrDataNascita">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Luogo di Nascita</label>
                            <input type="text" class="form-control" id="lrLuogoNascita" placeholder="Comune (Provincia)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Residenza</label>
                            <input type="text" class="form-control" id="lrResidenza" placeholder="Via, Numero, Comune (Provincia)">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label required">Qualità</label>
                            <select class="form-select" id="lrQualita">
                                <option value="">-- Seleziona --</option>
                                <option value="legale">Legale Rappresentante</option>
                                <option value="procuratore">Procuratore Speciale</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Sede dell'Intervento -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> Unità Produttiva Oggetto dell'Intervento</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Indirizzo Completo Unità Produttiva</label>
                        <input type="text" class="form-control" id="indirizzoIntervento" placeholder="Via, Numero Civico, CAP, Comune (Provincia)">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Coordinate Catastali</label>
                            <input type="text" class="form-control" id="coordinateCatastali" placeholder="Foglio, Particella, Sub">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Titolo di Disponibilità</label>
                            <select class="form-select" id="titoloDisponibilita">
                                <option value="">-- Seleziona --</option>
                                <option value="proprieta">Proprietà</option>
                                <option value="affitto">Affitto/Locazione</option>
                                <option value="impegno">Impegno all'acquisto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Estremi Titoli Autorizzativi Edificazione</label>
                        <textarea class="form-control" id="titoliAutorizzativi" rows="2" placeholder="Specificare titoli autorizzativi per l'edificazione"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Certificato di Agibilità</label>
                        <input type="text" class="form-control" id="certificatoAgibilita" placeholder="Estremi certificato di agibilità">
                    </div>
                </div>
                
                <!-- Checklist Requisiti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-tasks"></i> Verifica Requisiti di Ammissibilità</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_unitaAttiva">
                            <label class="form-check-label" for="req_unitaAttiva">
                                <strong>Unità Produttiva Attiva:</strong> L'unità locale è censita come attiva in visura camerale da almeno 1 anno
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_diagnosiEnergetica">
                            <label class="form-check-label" for="req_diagnosiEnergetica">
                                <strong>Diagnosi Energetica:</strong> È disponibile una Diagnosi Energetica ex-ante (UNI CEI EN 16247) basata sui consumi reali degli ultimi 2 anni
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_durc">
                            <label class="form-check-label" for="req_durc">
                                <strong>DURC Regolare:</strong> In regola con gli obblighi contributivi previdenziali e assistenziali
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_antimafia">
                            <label class="form-check-label" for="req_antimafia">
                                <strong>Normativa Antimafia:</strong> Assenza cause ostative antimafia
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_dnsh">
                            <label class="form-check-label" for="req_dnsh">
                                <strong>Principio DNSH:</strong> L'attività non arreca danno significativo all'ambiente (es. no caldaie a gas fossile)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_capacitaEconomica">
                            <label class="form-check-label" for="req_capacitaEconomica">
                                <strong>Capacità Economico-Finanziaria:</strong> Disponibilità Allegato D.1 o D.2 che copre la quota non agevolata
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_capacitaOperativa">
                            <label class="form-check-label" for="req_capacitaOperativa">
                                <strong>Capacità Operativa:</strong> Possesso delle competenze e qualifiche professionali necessarie
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noSanzioni">
                            <label class="form-check-label" for="req_noSanzioni">
                                <strong>Assenza Sanzioni:</strong> Non destinatario di sanzioni interdittive ex D.Lgs. 231/2001
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noDifficolta">
                            <label class="form-check-label" for="req_noDifficolta">
                                <strong>Non in Difficoltà:</strong> Non in condizioni di difficoltà ex art. 2 Reg. 651/2014
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noRevoche">
                            <label class="form-check-label" for="req_noRevoche">
                                <strong>Assenza Revoche:</strong> Non destinatario di revoche negli ultimi 3 anni
                            </label>
                        </div>
                    </div>
                </div>
                
                
                
                
                
            
                <!-- DNSH - Dichiarazione Caldaie Fossili e Motori Endotermici -->
                <div class="alert alert-danger mt-4">
                    <h5>⚠️ Principio DNSH - Divieti Assoluti</h5>
                    <p>
                        <strong>Principio "Non Nuocere Significativamente" (Do No Significant Harm):</strong><br>
                        Il progetto <strong>NON deve prevedere</strong>:
                    </p>
                    <h6>1. Caldaie alimentate a combustibili fossili:</h6>
                    <ul>
                        <li>Gas naturale (metano)</li>
                        <li>GPL (gas di petrolio liquefatto)</li>
                        <li>Gasolio</li>
                        <li>Olio combustibile</li>
                        <li>Carbone</li>
                    </ul>
                    <h6>2. Motori endotermici alimentati a combustibili fossili (FAQ n. 2, 5):</h6>
                    <ul>
                        <li>Motori diesel, benzina, GPL, gas naturale</li>
                        <li>Gruppi elettrogeni a combustibili fossili</li>
                        <li>Cogeneratori alimentati a gas</li>
                        <li>Sistemi di propulsione a combustione interna</li>
                    </ul>
                    <p class="mb-3">
                        <strong>✅ AMMESSI:</strong><br>
                        • Sostituzione di caldaie fossili con pompe di calore elettriche<br>
                        • Motori elettrici<br>
                        • Sistemi ad alta efficienza energetica non fossili (es. pompe di calore, sistemi geotermici)
                    </p>
                    <p class="mb-2">
                        <strong>⚠️ NOTA:</strong> I motori ibridi (con componente endotermica) NON sono esplicitamente ammessi dalle FAQ n. 2 e 5. 
                        In caso di dubbio, richiedere chiarimento formale all'amministrazione prima di procedere.
                    </p>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="dichiarazione_caldaie_fossili" onchange="verificaCaldaieFossili()">
                        <label class="form-check-label" for="dichiarazione_caldaie_fossili">
                            <strong>DICHIARO CHE:</strong> Il progetto NON prevede:<br>
                            • L'installazione di caldaie a combustibili fossili<br>
                            • L'introduzione o sostituzione di motori endotermici a combustibili fossili
                        </label>
                    </div>
                </div>
                
                <!-- Navigation Buttons Fase 1 -->
                <div class="navigation-buttons">
                    <button class="btn btn-success btn-navigation" onclick="goToStep(2)">
                        <i class="fas fa-arrow-right"></i> Avanti: Calcolo MOL
                    </button>
                </div>


                </div>
            
            <!-- ============================================ -->
            <!-- FASE 2: CALCOLO MOL E DIMENSIONE AZIENDALE -->
            <!-- ============================================ -->
            <div id="view-2" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-calculator"></i> Fase 2: Calcolo MOL e Dimensione Aziendale</h2>
                <p class="fase-subtitle">Dichiarazione sostitutiva MOL e determinazione classe dimensionale (Criterio Ordinatore)</p>
                
                <div class="alert-info-custom">
                    <strong><i class="fas fa-info-circle"></i> Nota Importante:</strong>
                    L'allegato deve essere asseverato da Commercialista/Revisore/CAF e firmato digitalmente.
                </div>
               

                
                

                
                
                 
                <!-- Dati Contabili MOL -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-file-invoice-dollar"></i> Dati Contabili per Calcolo MOL</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Anno di Riferimento</label>
                            <input type="number" class="form-control" id="annoRiferimento" placeholder="Es: 2024" min="2020" max="2026">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Tipo Documento Fonte</label>
                            <select class="form-select" id="tipoDocumento" onchange="aggiornaSezione_DichRedditi()">
                                <option value="">-- Seleziona --</option>
                                <option value="bilancio">Ultimo Bilancio Approvato</option>
                                <option value="dichredditi">Ultima Dichiarazione dei Redditi</option>
                            </select>
                            <small class="text-muted" id="notaTipoDocumento"></small>
                        </div>
                    </div>

                    <!-- ============================================================ -->
                    <!-- SEZIONE PROCEDURA: Dichiarazione dei Redditi (S.n.c./S.a.s./Ditta Ind.) -->
                    <!-- Visibile solo quando tipoDocumento = 'dichredditi' -->
                    <!-- ============================================================ -->
                    <div id="sezioneProceduraDichRedditi" class="mb-3" style="display:none;">
                        <div class="alert alert-warning border-warning" style="border-left: 5px solid #ffc107;">
                            <h5 class="alert-heading"><i class="fas fa-file-alt"></i> Procedura Specifica — Società di Persone / Ditta Individuale</h5>
                            <p class="mb-2">
                                In assenza dell'obbligo di deposito del bilancio, i dati per il calcolo del MOL devono essere estratti 
                                dall'<strong>ultima Dichiarazione dei Redditi</strong> (es. Modello Redditi SP) e riclassificati secondo la mappatura 
                                di raccordo prevista dall'Avviso. Il risultante <strong>Allegato C – DSAN (dati contabili per criterio ordinatore)</strong> 
                                deve essere <strong>obbligatoriamente asseverato</strong> dal professionista indicato nella sezione "Professionista Asseverante".
                            </p>

                            <!-- Selezione Regime Contabile -->
                            <div class="row mb-3 mt-3">
                                <div class="col-md-5">
                                    <label class="form-label fw-bold mb-1">Regime Contabile Adottato</label>
                                    <select class="form-select" id="regimeContabile" onchange="aggiorna_GuidaMappatura()">
                                        <option value="">-- Seleziona il regime --</option>
                                        <option value="ordinaria">Contabilità Ordinaria</option>
                                        <option value="semplificata">Contabilità Semplificata</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Guida Mappatura – stato iniziale (nessun regime selezionato) -->
                            <div id="guidaMappatura_nessun" class="alert alert-secondary mb-3" style="font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Seleziona il <strong>regime contabile</strong> per visualizzare la mappatura dei quadri fiscali da utilizzare.
                            </div>

                            <!-- Guida Mappatura – Contabilità Ordinaria -->
                            <div id="guidaMappatura_ordinaria" style="display:none;" class="mb-3">
                                <div class="alert alert-info border-info" style="border-left: 5px solid #0dcaf0; font-size: 0.9rem;">
                                    <strong><i class="fas fa-map-signs"></i> Mappatura – Contabilità Ordinaria (Modello Redditi SP)</strong>
                                    <table class="table table-sm table-bordered mt-2 mb-1" style="font-size: 0.85rem;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Elemento</th>
                                                <th>Quadro / Riga da utilizzare</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Valore della Produzione</strong></td>
                                                <td><code>Quadro RS – Riga 116</code></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Costi della Produzione</strong></td>
                                                <td><code>Quadro RS – Riga 117</code></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <small class="text-muted"><i class="fas fa-check-circle text-success"></i> <strong>Nota:</strong> I dati vanno verificati in coerenza con quanto riportato nel Modulo ISA allegato alla dichiarazione.</small>
                                </div>
                            </div>

                            <!-- Guida Mappatura – Contabilità Semplificata -->
                            <div id="guidaMappatura_semplificata" style="display:none;" class="mb-3">
                                <div class="alert alert-info border-info" style="border-left: 5px solid #0dcaf0; font-size: 0.9rem;">
                                    <strong><i class="fas fa-map-signs"></i> Mappatura – Contabilità Semplificata (Modello Redditi SP)</strong>
                                    <table class="table table-sm table-bordered mt-2 mb-1" style="font-size: 0.85rem;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Elemento</th>
                                                <th>Quadro / Righe da utilizzare</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Valore della Produzione</strong></td>
                                                <td><code>Quadro RG – Riga 12</code></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Costi della Produzione</strong></td>
                                                <td><code>Quadro RG – Somma delle Righe da 15 a 24</code></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <small class="text-muted"><i class="fas fa-check-circle text-success"></i> <strong>Nota:</strong> Anche in questo caso, verificare la coerenza con il Modulo ISA allegato alla dichiarazione.</small>
                                </div>
                            </div>

                            <!-- Nota calcolo MOL / esclusione ammortamenti -->
                            <div class="alert alert-light border mb-0" style="font-size: 0.88rem;">
                                <strong><i class="fas fa-calculator"></i> Regola di Calcolo del MOL:</strong>
                                Il MOL si ottiene sottraendo ai ricavi i <strong>costi vivi di produzione</strong>. 
                                Il calcolo deve <strong style="color: #dc3545;">escludere ammortamenti e accantonamenti</strong>, come specificato nelle FAQ dell'Avviso e nell'Allegato C stesso. 
                                Sotto inserisci direttamente il <strong>Valore della Produzione</strong> e il <strong>Totale Costi della Produzione</strong> estratti dalla Dichiarazione secondo la mappatura indicata.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">A) Valore della Produzione (€)</label>
                        <input type="number" class="form-control" id="valoreProduzione" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <!-- ── DETTAGLIO COSTI: visibile solo per Ultimo Bilancio ──────── -->
                    <div id="dettaglioCostiBilancio">
                        <h5 class="mt-4 mb-3">B) Costi della Produzione (Voce B Conto Economico)</h5>
                        
                        <div class="mb-3">
                            <label class="form-label required">Materie prime, sussidiarie, di consumo e merci (€)</label>
                            <input type="number" class="form-control" id="materiePrime" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Costi dei servizi (€)</label>
                            <input type="number" class="form-control" id="costiServizi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Costi godimento beni di terzi (€)</label>
                            <input type="number" class="form-control" id="costiBeniTerzi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Spese per il personale (€)</label>
                            <input type="number" class="form-control" id="spesePersonale" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Variazioni delle rimanenze (€)</label>
                            <input type="number" class="form-control" id="variazioniRimanenze" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                            <small class="text-muted">Inserire con segno algebrico (+ se incremento, - se decremento)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Oneri diversi di gestione (€)</label>
                            <input type="number" class="form-control" id="oneriDiversi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        </div>
                    </div>

                    <!-- ── COSTO UNICO: visibile solo per Dichiarazione dei Redditi ── -->
                    <div id="costiTotaleDichRedditi" style="display:none;">
                        <h5 class="mt-4 mb-3">B) Costi della Produzione (€)</h5>
                        <div class="mb-3">
                            <input type="number" class="form-control" id="costiProduzioneTotale" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                            <small class="text-muted">Valore estratto dalla Dichiarazione dei Redditi secondo la mappatura indicata sopra (esclusi ammortamenti e accantonamenti)</small>
                        </div>
                    </div>
                    
                    
                    <div class="result-box">
                        <h4><i class="fas fa-chart-line"></i> MOL (Margine Operativo Lordo) Calcolato</h4>
                        <div class="result-item">
                            <span class="result-label">Formula: Valore Produzione - Costi Produzione</span>
                            <span class="result-value" id="molCalcolato">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Totale Costi Produzione</span>
                            <span class="result-value" id="totaleCosti">€ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Budget Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Budget Progetto</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Costo Totale Investimento (€)</label>
                        <input type="number" class="form-control" id="costoTotaleInvestimento" step="0.01" placeholder="0.00" onchange="calcolaIndicatoreOrdinatore()" readonly title="Calcolato automaticamente dai preventivi">
<!-- Questo campo è readonly perché viene aggiornato automaticamente dalla somma dei preventivi -->
                        <small class="text-muted">Minimo: € 50.000,00 | Massimo: € 500.000,00</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Contributo Richiesto (€)</label>
                        <input type="number" class="form-control" id="contributoRichiesto" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Scelta Regime di Aiuto</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="regimeAiuto" id="regime_deminimis" value="deminimis">
                            <label class="form-check-label" for="regime_deminimis">
                                <strong>De Minimis (Reg. 2023/2831):</strong> Max 60% a fondo perduto (Cap € 300.000 su 3 anni)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="regimeAiuto" id="regime_esenzione" value="esenzione">
                            <label class="form-check-label" for="regime_esenzione">
                                <strong>Esenzione (Reg. 651/2014 Art. 14):</strong> Micro/Piccole: Max 60% | Medie: Max 50%
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Criterio Ordinatore -->
                <div class="punteggio-box">
                    <h4 class="text-center mb-3"><i class="fas fa-trophy"></i> INDICATORE ORDINATORE (Ranking)</h4>
                    <div class="result-item">
                        <span class="result-label">Formula: MOL / Costo Totale Investimento</span>
                        <span class="result-value" id="indicatoreOrdinatore">0,00000</span>
                    </div>
                    <div class="punteggio-totale mt-3" id="punteggioOrdinatore">
                        0,00000
                    </div>
                    <p class="text-center text-muted mb-0">Maggiore è il valore, migliore è la posizione in graduatoria</p>
                </div>
                
                <!-- Dimensione Aziendale -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-chart-bar"></i> Dimensione Aziendale e Parametri Finanziari</h3>
                    
                    <p><strong>Anno di riferimento ultimo bilancio:</strong> <span id="annoRefDimensione">-</span></p>
                    
                    <table class="table table-sm table-bordered table-small">
                        <thead>
                            <tr>
                                <th>Tipologia Impresa</th>
                                <th>N. Occupati (ULA)</th>
                                <th>Fatturato (M€)</th>
                                <th>Totale Bilancio (M€)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Dichiarante</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr>
                                <td><strong>Associate</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr>
                                <td><strong>Collegate</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>TOTALE</strong></td>
                                <td><strong><span id="totale_ula">0.00</span></strong></td>
                                <td><strong><span id="totale_fatturato">0.00</span></strong></td>
                                <td><strong><span id="totale_bilancio">0.00</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-info mt-3">
                        <strong>Tipo di Impresa:</strong>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_autonoma" value="autonoma">
                            <label class="form-check-label" for="tipo_autonoma">Autonoma</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_associata" value="associata">
                            <label class="form-check-label" for="tipo_associata">Associata</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_collegata" value="collegata">
                            <label class="form-check-label" for="tipo_collegata">Collegata</label>
                        </div>
                    </div>
                </div>
                
                <!-- Composizione Sociale -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-users"></i> Composizione Sociale</h3>
                    
                    <button class="btn btn-sm btn-success mb-3" onclick="aggiungiSocio()">
                        <i class="fas fa-plus"></i> Aggiungi Socio
                    </button>
                    
                    <div id="listaSoci">
                        <p class="text-muted">Nessun socio inserito</p>
                    </div>
                </div>
                
                <!-- Aiuti De Minimis (se regime selezionato) -->
                <div class="form-section" id="sezioneDeMinimis" style="display:none;">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Aiuti De Minimis Ricevuti (ultimi 3 anni)</h3>
                    
                    <button class="btn btn-sm btn-primary mb-3" onclick="aggiungiAiuto()">
                        <i class="fas fa-plus"></i> Aggiungi Aiuto
                    </button>
                    
                    <div id="listaAiuti">
                        <p class="text-muted">Nessun aiuto de minimis dichiarato</p>
                    </div>
                    
                    <div class="result-box mt-3">
                        <div class="result-item">
                            <span class="result-label">Totale Aiuti De Minimis Ricevuti (ultimi 3 anni)</span>
                            <span class="result-value" id="totaleDeMinimis">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Contributo Richiesto</span>
                            <span class="result-value" id="contributoRichiestoRiepilogo">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Totale Cumulato</span>
                            <span class="result-value" id="totaleCumulato">€ 0,00</span>
                        </div>
                        <div class="alert alert-warning mt-2 mb-0" id="alertDeMinimis" style="display:none;">
                            <strong>⚠️ ATTENZIONE:</strong> Il totale cumulato supera il massimale de minimis di € 300.000 
                            previsto dal Reg. UE 2023/2831!<br>
                            <small>Nota: Questo limite si applica solo al regime "de minimis". 
                            Il regime "Esenzione (Art. 14)" non ha limite cumulativo ma percentuali diverse (60%/50%).</small>
                        </div>
                    </div>
                </div>
                
                <!-- Professionista Asseverante -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-user-check"></i> Professionista Asseverante</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Tipo Professionista</label>
                            <select class="form-select" id="tipoProfessionista">
                                <option value="">-- Seleziona --</option>
                                <option value="commercialista">Dottore Commercialista</option>
                                <option value="revisore">Revisore Legale</option>
                                <option value="caf">CAF</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Nome e Cognome/Denominazione</label>
                            <input type="text" class="form-control" id="nomeProfessionista" placeholder="Nome completo o denominazione">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="cfProfessionista" placeholder="Codice Fiscale" maxlength="16">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Iscrizione Albo</label>
                            <input type="text" class="form-control" id="iscrizioneAlbo" placeholder="N. iscrizione e sede">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Sede Studio/Ufficio</label>
                        <input type="text" class="form-control" id="sedeProfessionista" placeholder="Indirizzo completo">
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(3)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 3: DIAGNOSI ENERGETICA E PREVENTIVI -->
            <!-- ============================================ -->
            <div id="view-3" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-chart-bar"></i> Fase 3: Diagnosi Energetica & Preventivi</h2>
                <p class="fase-subtitle">Inserimento dati diagnosi energetica e gestione preventivi per categoria</p>
                
                <!-- Dati da Diagnosi -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-thermometer-half"></i> Dati da Diagnosi Energetica (Obbligatori)</h3>
                    
                    <div class="alert-info-custom">
                        <strong><i class="fas fa-info-circle"></i> Importante:</strong>
                        Questi dati derivano dalla Diagnosi Energetica (UNI CEI EN 16247) e sono fondamentali per il calcolo dei punteggi.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">EPgl,nren Ante-operam (kWh/m²a)</label>
                            <input type="number" class="form-control" id="epgl_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">EPgl,nren Post-operam (kWh/m²a)</label>
                            <input type="number" class="form-control" id="epgl_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Emissioni CO2 Ante (t/anno)</label>
                            <input type="number" class="form-control" id="co2_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Emissioni CO2 Post (t/anno)</label>
                            <input type="number" class="form-control" id="co2_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Energia da Rinnovabili (FER) Ante (kWh)</label>
                            <input type="number" class="form-control" id="fer_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Energia da Rinnovabili (FER) Post (kWh)</label>
                            <input type="number" class="form-control" id="fer_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <!-- Risultati Calcoli -->
                    <div class="result-box">
                        <h4><i class="fas fa-chart-pie"></i> Riduzioni Calcolate Automaticamente</h4>
                        <div class="result-item">
                            <span class="result-label">Risparmio Energetico EPgl,nren</span>
                            <span class="result-value" id="risparmioEnergetico">0,00%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Riduzione CO2</span>
                            <span class="result-value" id="riduzioneCO2">0,00%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Incremento FER</span>
                            <span class="result-value" id="incrementoFER">0,00%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gestione Preventivi -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-receipt"></i> Gestione Preventivi</h3>
                    
                    <button class="btn btn-success mb-3" onclick="mostraFormPreventivo()">
                        <i class="fas fa-plus"></i> Aggiungi Preventivo
                    </button>
                    
                    <!-- Form Nuovo Preventivo -->
                    <div id="formPreventivo" style="display:none;" class="mb-4 p-3 border rounded bg-light">
                        <h5>Nuovo Preventivo</h5>
                        
                        <div class="mb-3">
                            <label class="form-label required">Categoria</label>
                            <select class="form-select" id="nuovoPreventivo_categoria" onchange="aggiornaHelpCategoria()">
                                <option value="">-- Seleziona Categoria --</option>
                                <optgroup label="INTERVENTI PRINCIPALI">
                                    <option value="cat_a">CATEGORIA A - Efficientamento Processi Produttivi</option>
                                    <option value="cat_b">CATEGORIA B - Efficientamento Edifici</option>
                                    <option value="cat_c">CATEGORIA C - Sostituzione Macchinari</option>
                                    <option value="cat_d">CATEGORIA D - Energie Rinnovabili (Autoconsumo)</option>
                                </optgroup>
                                <optgroup label="SPESE AMMISSIBILI (All. F Tab. 3)">
                                    <option value="cat_software">Software - Voce b) All. F</option>
                                    <option value="cat_edili">Spese Edili e Impianti Generali - Voce c) All. F (Max 20%)</option>
                                    <option value="cat_tecniche">Spese Tecniche (Progettazione, DL, Diagnosi, Sicurezza) - Voce d) All. F (Max 10%)</option>
                                    <option value="cat_ape">APE Ex-Ante/Ex-Post - Voce e) All. F</option>
                                </optgroup>
                            </select>
                            <small class="text-muted" id="helpCategoria"></small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Descrizione Intervento</label>
                            <textarea class="form-control" id="nuovoPreventivo_descrizione" rows="2" placeholder="Descrizione dettagliata dell'intervento"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Fornitore</label>
                            <input type="text" class="form-control" id="nuovoPreventivo_fornitore" placeholder="Ragione sociale fornitore">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Data Preventivo <small class="text-muted">(opzionale)</small></label>
                            <input type="date" class="form-control" id="nuovoPreventivo_data">
                            <small class="text-info">
                                ℹ️ La data del preventivo (documento di offerta) può essere anteriore alla pubblicazione dell'avviso.
                                <br><strong>IMPORTANTE:</strong> L'avvio lavori (accettazione preventivo/ordine confermato) deve avvenire DOPO la presentazione della domanda (Par. 3.3 Avviso).
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Importo (€)</label>
                            <input type="number" class="form-control" id="nuovoPreventivo_importo" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="aggiungiPreventivo()">
                                <i class="fas fa-check"></i> Conferma
                            </button>
                            <button class="btn btn-secondary" onclick="nascondiFormPreventivo()">
                                <i class="fas fa-times"></i> Annulla
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista Preventivi -->
                    <div id="listaPreventivi">
                        <p class="text-muted">Nessun preventivo inserito</p>
                    </div>
                    
                    <!-- Indicatore DNSH Caldaie Fossili -->
                    <div id="dnsh_caldaie_indicator" class="alert alert-secondary mt-3">
                        <strong>DNSH - Caldaie Fossili:</strong> Verifica in corso...
                    </div>
                    
                    <!-- Totale Preventivi -->
                    <div class="result-box">
                        <h4><i class="fas fa-calculator"></i> Riepilogo Spese per Categoria</h4>
                        <div class="result-item">
                            <span class="result-label">Categoria A - Processi Produttivi</span>
                            <span class="result-value" id="totale_cat_a">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria B - Edifici</span>
                            <span class="result-value" id="totale_cat_b">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria C - Macchinari</span>
                            <span class="result-value" id="totale_cat_c">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria D - Rinnovabili</span>
                            <span class="result-value" id="totale_cat_d">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Software (Voce b)</span>
                            <span class="result-value" id="totale_cat_software">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Spese Edili (Voce c - Max 20%)</span>
                            <span class="result-value" id="totale_cat_edili">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Spese Tecniche (Voce d - Max 10%)</span>
                            <span class="result-value" id="totale_cat_tecniche">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">APE (Voce e)</span>
                            <span class="result-value" id="totale_cat_ape">€ 0,00</span>
                        </div>
                        <hr>
                        <div class="result-item">
                            <span class="result-label"><strong>TOTALE INVESTIMENTI</strong></span>
                            <span class="result-value" id="totaleInvestimenti" style="font-size:1.3rem;">€ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <!-- NOTA: Spese Accessorie (Edili, Tecniche, APE) vanno inserite come preventivi tramite il form "Aggiungi Preventivo" -->
                
                <!-- Validazione Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-check-double"></i> Validazione Automatica Progetto</h3>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_riduzioneCO2" style="color:#6c757d;"></i>
                            <span><strong>Riduzione CO2:</strong> ≥ 30% rispetto all'ex-ante?</span>
                            <span class="ms-auto badge bg-secondary" id="badge_riduzioneCO2">Da verificare</span>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_risparmioEnergetico" style="color:#6c757d;"></i>
                            <span><strong>Risparmio Energetico:</strong> Miglioramento verificato?</span>
                            <span class="ms-auto badge bg-secondary" id="badge_risparmioEnergetico">Da verificare</span>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_caldaieFossili" style="color:#28a745;"></i>
                            <span><strong>Caldaie Fossili:</strong> Assenti nel progetto?</span>
                            <span class="ms-auto badge bg-success" id="badge_caldaieFossili">Conforme</span>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(4)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 4: ISTANZA DI FINANZIAMENTO -->
            <!-- ============================================ -->
            <div id="view-4" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-signature"></i> Fase 4: Istanza di Finanziamento (Allegato 2.1.A)</h2>
                <p class="fase-subtitle">Dichiarazioni obbligatorie ai sensi dell'Art. 47 DPR 445/2000</p>
                
                <div class="alert-danger-custom">
                    <strong><i class="fas fa-exclamation-triangle"></i> Attenzione:</strong>
                    Le dichiarazioni devono essere confermate sotto la propria responsabilità. False dichiarazioni comportano sanzioni penali ex art. 76 DPR 445/2000.
                </div>
                
                <!-- Marca da Bollo -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-stamp"></i> Marca da Bollo</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Numero Marca da Bollo</label>
                            <input type="text" class="form-control" id="numeroMarcaBollo" placeholder="Numero identificativo marca">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Data Annullamento</label>
                            <input type="date" class="form-control" id="dataMarcaBollo">
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Importo:</strong> € 16,00 - La marca da bollo deve essere annullata e allegata
                    </div>
                </div>
                
                <!-- DICHIARAZIONI PRINCIPALI -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-list-check"></i> Dichiarazioni Principali</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_requisiti">
                            <label class="form-check-label" for="dich_requisiti">
                                <strong>1. Requisiti di Ammissibilità:</strong> Disporre dei requisiti di ammissibilità di cui ai parr. 2.1 e 2.2 dell'Avviso
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_durc">
                            <label class="form-check-label" for="dich_durc">
                                <strong>2. DURC:</strong> Essere in regola con gli obblighi relativi al pagamento dei contributi previdenziali e assistenziali (DURC regolare)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_antimafia">
                            <label class="form-check-label" for="dich_antimafia">
                                <strong>3. Antimafia:</strong> Essere in regola con la normativa antimafia
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_capacitaEconomica">
                            <label class="form-check-label" for="dich_capacitaEconomica">
                                <strong>4. Capacità Economico-Finanziaria:</strong> Possedere la capacità economico-finanziaria documentata mediante Allegato D.1 o D.2
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_sostenibilita">
                            <label class="form-check-label" for="dich_sostenibilita">
                                <strong>5. Sostenibilità Finanziaria:</strong> Disporre delle risorse per coprire i costi di gestione e manutenzione (ex art. 73.2, lett. d) Reg. UE 2021/1060)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_capacitaOperativa">
                            <label class="form-check-label" for="dich_capacitaOperativa">
                                <strong>6. Capacità Operativa:</strong> Possedere capacità operativa e amministrativa necessaria alla realizzazione dell'intervento
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noSanzioni">
                            <label class="form-check-label" for="dich_noSanzioni">
                                <strong>7. Assenza Sanzioni:</strong> Possedere la capacità di contrarre con la P.A. (non destinatario di sanzioni interdittive ex art. 9 D.Lgs. 231/2001)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_sedeSicilia">
                            <label class="form-check-label" for="dich_sedeSicilia">
                                <strong>8. Sede in Sicilia:</strong> Avere sede o unità produttiva locale nel territorio regionale (o comunicare l'apertura al primo pagamento)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_ateco">
                            <label class="form-check-label" for="dich_ateco">
                                <strong>9. Codice ATECO:</strong> Esercitare un'attività con codice ATECO ammissibile (non escluso da Reg. 2023/2831 e Reg. 2021/1058)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_iscrizione">
                            <label class="form-check-label" for="dich_iscrizione">
                                <strong>10. Iscrizioni:</strong> Essere regolarmente iscritto a CCIAA/REA/Albo professionale/Gestione INPS (secondo fattispecie)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDifficolta">
                            <label class="form-check-label" for="dich_noDifficolta">
                                <strong>11. Non in Difficoltà:</strong> Non trovarsi in condizioni di difficoltà ex art. 2, punto 18 Reg. 651/2014
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noCollegamento">
                            <label class="form-check-label" for="dich_noCollegamento">
                                <strong>12. Assenza Collegamento:</strong> Non risultare associato o collegato con altra impresa richiedente nell'aggregazione
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noRevoche">
                            <label class="form-check-label" for="dich_noRevoche">
                                <strong>13. Assenza Revoche:</strong> Non destinatario di revoche negli ultimi 3 anni per violazioni gravi
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noCondanne">
                            <label class="form-check-label" for="dich_noCondanne">
                                <strong>14. Assenza Condanne:</strong> Non condannato con sentenza passata in giudicato per reati gravi in danno dello Stato
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_contrattiLavoro">
                            <label class="form-check-label" for="dich_contrattiLavoro">
                                <strong>15. Contratti di Lavoro:</strong> Osservare gli obblighi dei contratti collettivi e rispettare le normative su sicurezza, pari opportunità, tutela ambiente
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_urbanistica">
                            <label class="form-check-label" for="dich_urbanistica">
                                <strong>16. Normativa Urbanistica:</strong> Rispettare le vigenti normative urbanistiche e di tutela paesaggistica
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDoppioFinanziamento">
                            <label class="form-check-label" for="dich_noDoppioFinanziamento">
                                <strong>17. No Doppio Finanziamento:</strong> Non avere usufruito di altri finanziamenti pubblici per le stesse spese
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_impresaAttiva">
                            <label class="form-check-label" for="dich_impresaAttiva">
                                <strong>18. Impresa Attiva:</strong> Essere impresa attiva al momento della presentazione della domanda
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_36mesi">
                            <label class="form-check-label" for="dich_36mesi">
                                <strong>19. Anzianità:</strong> Essere costituita come impresa da almeno 36 mesi
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDelocalizzazione">
                            <label class="form-check-label" for="dich_noDelocalizzazione">
                                <strong>20. No Delocalizzazione:</strong> Non avere delocalizzato nei 2 anni precedenti e impegno a non delocalizzare nei 2 anni successivi
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Dichiarazioni Specifiche De Minimis -->
                <div class="form-section" id="sezioneDeMinimisIstanza" style="display:none;">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Dichiarazioni De Minimis</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_consapevoleDeMinimis">
                            <label class="form-check-label" for="dich_consapevoleDeMinimis">
                                <strong>Consapevolezza Reg. 2023/2831:</strong> Preso atto del Regolamento UE n. 2023/2831 "de minimis"
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_impresaUnica">
                            <label class="form-check-label" for="dich_impresaUnica">
                                <strong>Impresa Unica:</strong> Dichiarazione su imprese collegate a monte e a valle nell'ambito del concetto di "impresa unica"
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Impegni -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-handshake"></i> Impegni</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_cumulo">
                            <label class="form-check-label" for="imp_cumulo">
                                <strong>No Cumulo:</strong> Impegno a non cumulare il presente aiuto con altri aiuti di Stato (es. Credito d'imposta ZES) per le stesse spese
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_dnsh">
                            <label class="form-check-label" for="imp_dnsh">
                                <strong>DNSH:</strong> Impegno al rispetto del principio "Non arrecare danno significativo" (Do No Significant Harm)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_climateProofing">
                            <label class="form-check-label" for="imp_climateProofing">
                                <strong>Climate Proofing:</strong> Verifica di resilienza climatica effettuata per investimenti con vita utile superiore a 5 anni
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Riepilogo Domanda -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-file-alt"></i> Riepilogo Domanda</h3>
                    
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Impresa:</strong></td>
                            <td><span id="recap_ragioneSociale">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>P.IVA:</strong></td>
                            <td><span id="recap_partitaIva">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>Dimensione:</strong></td>
                            <td><span id="recap_dimensione">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>Investimento Totale:</strong></td>
                            <td><span id="recap_investimento">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Contributo Richiesto:</strong></td>
                            <td><span id="recap_contributo">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Regime Aiuto:</strong></td>
                            <td><span id="recap_regime">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>MOL:</strong></td>
                            <td><span id="recap_mol">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Indicatore Ordinatore:</strong></td>
                            <td><span id="recap_ordinatore">0,00000</span></td>
                        </tr>
                    </table>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(3)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(5)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 5: FORMULARIO DI PROGETTO (Allegato F) -->
            <!-- ============================================ -->
            <div id="view-5" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-alt"></i> Fase 5: Formulario di Progetto (Allegato F)</h2>
                <p class="fase-subtitle">Descrizione completa del programma di investimenti e calcolo punteggi tecnici</p>
                
                <!-- SEZIONE A: Informazioni Generali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Sezione A - Informazioni Generali</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label required">1.1 Titolo del Progetto</label>
                            <input type="text" class="form-control" id="titoloProgetto" placeholder="Inserire titolo descrittivo del progetto">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">1.2 Acronimo</label>
                            <input type="text" class="form-control" id="acronimoProgetto" placeholder="Es: EFFI-2025">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">1.3 Durata Progetto (mesi)</label>
                            <input type="number" class="form-control" id="durataProgetto" min="1" max="24" placeholder="Max 24 mesi">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">1.4 Costo Totale Ammissibile (€)</label>
                            <input type="number" class="form-control" id="costoTotaleFormulario" step="0.01" readonly>
                            <small class="text-muted">Calcolato automaticamente dai preventivi</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">1.7 Breve Presentazione Soggetto Proponente (Mission e Attività)</label>
                        <textarea class="form-control" id="missionAttivita" rows="4" placeholder="Descrivere brevemente mission aziendale e principali attività"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE B: Descrizione Soggetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-building"></i> Sezione B - Descrizione Soggetto Proponente</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Descrivere sinteticamente l'attività economica svolta</label>
                        <textarea class="form-control" id="attivitaEconomica" rows="4" placeholder="Settore di attività, prodotti/servizi offerti, mercati di riferimento"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE C: Fabbisogni Energetici -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-fire"></i> Sezione C - Fabbisogni di Efficientamento Energetico</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">C.1 Contestualizzazione dei Fabbisogni</label>
                        <textarea class="form-control" id="contestualizzazioneFabbisogni" rows="5" placeholder="Descrivere: 1) Unità produttiva interessata e titoli autorizzativi; 2) Attuali modalità di approvvigionamento energetico; 3) Stato dell'arte innovazioni tecnologiche nel settore; 4) Principali fabbisogni di efficientamento"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">C.2 Descrizione Obiettivi Perseguiti</label>
                        <textarea class="form-control" id="obiettiviPerseguiti" rows="5" placeholder="Descrivere e quantificare: 1) Contributo alla riduzione emissioni CO2; 2) Riduzione consumi energetici ed eventuale passaggio di classe; 3) Incremento energia da FER; 4) Impatti attesi sull'attività economica; 5) Vantaggio competitivo"></textarea>
                    </div>
                    
                    <h5 class="mt-4">Obiettivi Specifici Interventi</h5>
                    
                    <p class="text-muted mb-3">Selezionare tutti gli obiettivi pertinenti al progetto. Questa sezione deve descrivere in modo chiaro e dettagliato le finalità specifiche degli interventi previsti.</p>
                    
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <strong class="d-block mb-2">a) Riqualificazione energetica impianti produttivi e/o per l'erogazione di servizi:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_rifasamento">
                                <label class="form-check-label" for="obiettivo_rifasamento">
                                    Rifasamento elettrico
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_motori">
                                <label class="form-check-label" for="obiettivo_motori">
                                    Motori, pompe, inverter, compressori ad alta efficienza
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_coibentazioni">
                                <label class="form-check-label" for="obiettivo_coibentazioni">
                                    Coibentazioni compatibili con le esigenze produttive
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_recuperoCalore">
                                <label class="form-check-label" for="obiettivo_recuperoCalore">
                                    Recupero calore da processi produttivi
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_vapore">
                                <label class="form-check-label" for="obiettivo_vapore">
                                    Ottimizzazione ciclo vapore
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_caldaie">
                                <label class="form-check-label" for="obiettivo_caldaie">
                                    Caldaie a gas condensazione / Pompe di calore
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_buildingAutomation">
                                <label class="form-check-label" for="obiettivo_buildingAutomation">
                                    Building automation e sistemi di controllo smart
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <strong class="d-block mb-2">b) Riqualificazione energetica edifici aziendali:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_cappotto">
                                <label class="form-check-label" for="obiettivo_cappotto">
                                    Isolamento involucro (cappotto termico)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_serramenti">
                                <label class="form-check-label" for="obiettivo_serramenti">
                                    Sostituzione serramenti e infissi
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_led">
                                <label class="form-check-label" for="obiettivo_led">
                                    Efficientamento illuminazione (LED)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_climatizzazionePassiva">
                                <label class="form-check-label" for="obiettivo_climatizzazionePassiva">
                                    Sistemi di climatizzazione passiva
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <strong class="d-block mb-2">c) Impianti FER (Fonti Energia Rinnovabile) per autoconsumo:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_fotovoltaico">
                                <label class="form-check-label" for="obiettivo_fotovoltaico">
                                    Fotovoltaico con/senza sistema di accumulo
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_solarTermico">
                                <label class="form-check-label" for="obiettivo_solarTermico">
                                    Solare termico / Solare termodinamico
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_cogenerazione">
                                <label class="form-check-label" for="obiettivo_cogenerazione">
                                    Cogenerazione / Trigenerazione
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- SEZIONE D: Sistemi Monitoraggio Attuali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-chart-line"></i> Sezione D - Attuali Sistemi di Monitoraggio</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">D.1 Strutture e Strumenti Attuali per Monitoraggio Consumi</label>
                        <textarea class="form-control" id="struttureMonitoraggio" rows="3" placeholder="Descrivere eventuali sistemi già disponibili per monitoraggio consumi energetici ed emissioni CO2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">D.2 Figure Professionali (Energy Manager/EGE)</label>
                        <textarea class="form-control" id="figureEnergyManager" rows="3" placeholder="Indicare presenza Energy Manager/EGE con certificazioni e descrivere modalità di monitoraggio/razionalizzazione"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE E: Descrizione Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-tasks"></i> Sezione E - Descrizione Dettagliata Progetto</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">E.1 Descrizione Tecnica Interventi</label>
                        <textarea class="form-control" id="descrizioneTecnica" rows="6" placeholder="Descrivere dettagliatamente il processo di implementazione delle soluzioni tecnologiche per ciascun obiettivo, con evidenza delle fasi principali e risultati attesi"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">E.2 Maturità Progettuale (Cantierabilità)</label>
                        <textarea class="form-control" id="maturitaProgettuale" rows="4" placeholder="Descrivere iter amministrativo necessario, titoli autorizzativi richiesti e tempistiche conseguimento/rilascio"></textarea>
                        
                        <div class="mt-3">
                            <label class="form-label required">Stato Autorizzativo</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_immediata" value="15" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_immediata">
                                    <strong>Cantierabilità Immediata</strong> (SCIA/CILA/Nessuna autorizzazione) - <span class="text-success">15 Punti</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_60gg" value="8" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_60gg">
                                    <strong>Ottenibile in 60 gg</strong> - <span class="text-warning">8 Punti</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_90gg" value="3" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_90gg">
                                    <strong>Ottenibile in 90 gg</strong> - <span class="text-danger">3 Punti</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                                        
                    
                    <!-- SEZIONE E.3: PIANO DI LAVORO E CRONOPROGRAMMA -->
                    <div class="mb-3">
                        <h5><i class="fas fa-tasks"></i> E.3 Piano di Lavoro e Cronoprogramma</h5>
                        <p class="text-muted">Dettagliare il piano di lavoro con obiettivi, work package, deliverable e milestone temporali</p>
                    </div>
                    
                    <!-- <div class="mb-3">
                                    <button type="button" class="btn btn-success" onclick="compilaAutomaticaWP()">
                                        <i class="fas fa-magic"></i> Genera Automaticamente Piano di Lavoro e Cronoprogramma
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-info-circle"></i> Il sistema genererà automaticamente WP e cronoprogramma basandosi sui preventivi inseriti nella Fase 3
                                    </small>
                                </div>
                                
                                <h6 class="fw-bold mb-3 mt-4">TABELLA 1: PIANO DI LAVORO -->
                    <h5 class="mt-4 mb-3">Tabella 1 - Piano di Lavoro</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Ob. Gen.</th>
                                    <th>Ob. Spec.</th>
                                    <th>WP</th>
                                    <th>Azioni/Task</th>
                                    <th>Deliverable</th>
                                    <th>Output/Risultati Attesi</th>
                                    <th>Budget Allocato (€)</th>
                                    <th>Indicatori (KPI)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabellaWP">
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        <em>Nessun work package inserito. Usa il bottone qui sotto per aggiungere.</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="aggiungiRigaWP()">
                            <i class="fas fa-plus"></i> Aggiungi Work Package
                        </button>
                    </div>
                    
                    <!-- TABELLA 2: CRONOPROGRAMMA -->
                    <h5 class="mt-4 mb-3">Tabella 2 - Cronoprogramma</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>WP/Task</th>
                                    <th>M1</th>
                                    <th>M2</th>
                                    <th>M3</th>
                                    <th>M4</th>
                                    <th>M5</th>
                                    <th>M6</th>
                                    <th>M7</th>
                                    <th>M8</th>
                                    <th>M9</th>
                                    <th>M10</th>
                                    <th>M11</th>
                                    <th>M12</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabellaCrono">
                                <tr>
                                    <td colspan="14" class="text-center text-muted">
                                        <em>Nessuna attività inserita. Usa il bottone qui sotto per aggiungere.</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="aggiungiRigaCrono()">
                            <i class="fas fa-plus"></i> Aggiungi Attività
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Legenda Milestones</label>
                        <textarea class="form-control" id="legendaMilestones" rows="3" placeholder="1. Milestone 1: Descrizione&#10;2. Milestone 2: Descrizione&#10;..."></textarea>
                    </div>

<div class="mb-3">
                        <label class="form-label">E.3 Piano di Lavoro e Cronoprogramma</label>
                        <textarea class="form-control" id="cronoprogramma" rows="4" placeholder="Descrivere piano di lavoro con WP/Task e milestones associate"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE F: Monitoraggio Post-Investimento -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-cogs"></i> Sezione F - Gestione Monitoraggio e Manutenzione Post-Investimento</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">F.1 Sistema di Monitoraggio Previsto</label>
                        <textarea class="form-control" id="sistemaMonitoraggio" rows="4" placeholder="Descrivere: 1) Struttura organizzativa responsabile; 2) Sistemi di misurazione consumi da installare; 3) Processi raccolta dati e reporting; 4) Procedure manutenzione impianti"></textarea>
                    </div>
                    
                    <h5 class="mt-4">Sistemi Smart/IoT Previsti (CdV_4 - Max 6 pt)</h5>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema1" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema1">
                            Sistema di monitoraggio base (es. sensori temperatura/umidità) - 1 pt
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema2" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema2">
                            Sistema IoT avanzato (es. building automation, gestione carichi) - +2 pt se combinato
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema3" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema3">
                            Sistema recupero/accumulo energia (es. batterie, accumulo termico) - Totale 6 pt se tutti presenti
                        </label>
                    </div>
                    
                    <div class="result-box mt-3">
                        <div class="result-item">
                            <span class="result-label">Punteggio Monitoraggio (Criterio 4)</span>
                            <span class="result-value" id="p_monitoraggio">0 pt</span>
                        </div>
                    </div>
                </div>
                
                <!-- SEZIONE G: Criteri Premiali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-trophy"></i> Sezione G - Criteri Premiali (Max 6 pt)</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">G.1 Energy Manager/EGE con Certificazioni</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prem_energyManager" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="prem_energyManager">
                                Presenza Energy Manager/EGE certificato (es. SECEM/FIRE, UNI CEI 11339:2023) o ISO 50001 - <strong>+3 pt</strong>
                            </label>
                        </div>
                        <textarea class="form-control mt-2" id="dettagliEnergyManager" rows="2" placeholder="Se sì, riportare estremi identificativi e qualificazioni/certificazioni"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">G.2 Sistemi Avanzati di Misura Consumi</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prem_sistemiMisura" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="prem_sistemiMisura">
                                Sistemi avanzati con sensori intelligenti, IoT, AI per ottimizzazione automatica - <strong>+3 pt</strong>
                            </label>
                        </div>
                        <textarea class="form-control mt-2" id="dettagliSistemiMisura" rows="2" placeholder="Se sì, descrivere i sistemi avanzati da implementare"></textarea>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-item">
                            <span class="result-label">Punteggio Premialità Totale</span>
                            <span class="result-value" id="p_premialita">0 pt</span>
                        </div>
                    </div>
                </div>
                
                <!-- SEZIONE H: Budget e Criteri di Valutazione -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-calculator"></i> Sezione H - Budget e Punteggi Tecnici</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">H.1 Illustrazione Budget per Categorie di Spesa</label>
                        <textarea class="form-control" id="illustrazioneBudget" rows="4" placeholder="Illustrare il budget con puntuale indicazione prospetto analitico costi in coerenza con preventivi allegati"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">H.2 Piano Coperture Finanziarie</label>
                        <textarea class="form-control" id="pianoCoperture" rows="3" placeholder="Dettagliare fonti di finanziamento: contributo richiesto, cofinanziamenti, altre fonti con importi e percentuali"></textarea>
                    </div>
                    
                                        
                    <!-- TABELLA 3: PIANO FINANZIARIO INVESTIMENTI -->
                    <h5 class="mt-4 mb-3">Tabella 3 - Piano Finanziario degli Investimenti</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%;">Tipologia di Spesa</th>
                                    <th>Costo Totale Ammissibile (€)</th>
                                    <th>Contributo Richiesto (€)</th>
                                    <th>Intensità Aiuto (%)</th>
                                    <th>Costo Impresa (€)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>a.</strong> Acquisto attrezzature, impianti, componenti, sistemi, software e macchinari (inclusa messa in opera)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_a_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>b.</strong> Acquisto software dedicato gestione, controllo e programmazione processo produttivo</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_b_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>c.</strong> Spese edili e impianti generali (strettamente necessarie, max 20% del totale)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_c_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>d.</strong> Spese tecniche (diagnosi obbligatoria, progettazione, DL, collaudo, sicurezza - max 10%)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_d_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>e.</strong> APE ex-ante e APE a ultimazione lavori (obbligatorio)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_e_impresa">€ 0,00</span></td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>TOTALE</strong></td>
                                    <td><strong><span id="budget_totale_ammissibile">€ 0,00</span></strong></td>
                                    <td><strong><span id="budget_totale_contributo">€ 0,00</span></strong></td>
                                    <td><strong><span id="budget_intensita_media">0,00%</span></strong></td>
                                    <td><strong><span id="budget_totale_impresa">€ 0,00</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <strong><i class="fas fa-info-circle"></i> Limiti:</strong>
                        <ul class="mb-0">
                            <li>Investimento minimo: € 50.000 | Massimo: € 500.000</li>
                            <li>Spese edili (voce c): Max 20% del totale ammissibile</li>
                            <li>Spese tecniche (voce d): Max 10% del totale voci a+b+c voci a+b+c</li>
                            <li>Intensità aiuto: De Minimis max 60% | Esenzione Micro/Piccole 60%, Medie 50%</li>
                        </ul>
                    </div>

                                        <!-- H.2 PIANO DELLE COPERTURE FINANZIARIE -->
                    <h5 class="mt-4 mb-3"><i class="fas fa-coins"></i> H.2 Piano delle Coperture Finanziarie</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Dettaglio fonti di finanziamento</label>
                        <textarea class="form-control" id="fontiFinanziamento" rows="3" placeholder="Dettagliare le fonti di finanziamento: contributo richiesto, cofinanziamenti bancari, mezzi propri, ecc."></textarea>
                    </div>
                            <div class="mb-4">
                                <button type="button" class="btn btn-info" onclick="precompilaDatiH2()">
                                    <i class="fas fa-magic"></i> Pre-compila con dati del progetto
                                </button>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle"></i> Compila automaticamente Impieghi e Fonti basandosi sui dati inseriti nelle fasi precedenti
                                </small>
                            </div>

                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> <strong>IMPORTANTE:</strong> Il totale delle FONTI deve essere uguale al totale degli IMPIEGHI
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 50%;">Prospetto "Impieghi/Fonti"</th>
                                    <th style="width: 20%;">Anno 1 (€)</th>
                                    <th style="width: 15%;">Totale (€)</th>
                                    <th style="width: 15%;">% sul totale</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- IMPIEGHI -->
                                <tr class="table-secondary">
                                    <td colspan="4"><strong>IMPIEGHI (fabbisogni finanziari)</strong></td>
                                </tr>
                                <tr>
                                    <td>Programma di investimento</td>
                                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Investimenti immateriali</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_immat_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Investimenti materiali</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_mat_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• IVA sugli investimenti</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_iva_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>A - TOTALE PROGRAMMA DI INVESTIMENTO</strong></td>
                                    <td><strong><span id="h2_tot_impieghi_anno1">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_impieghi_tot">€ 0,00</span></strong></td>
                                    <td><strong>100%</strong></td>
                                </tr>
                                
                                <!-- FONTI -->
                                <tr class="table-secondary">
                                    <td colspan="4"><strong>FONTI (coperture finanziarie)</strong></td>
                                </tr>
                                <tr>
                                    <td>Contributo pubblico richiesto</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_contributo_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_tot" readonly style="background:#f8f9fa"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td><strong>Cofinanziamento proprio:</strong></td>
                                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Incremento Capitale Sociale</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_cap_sociale_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento soci</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_soci_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Utilizzo riserve</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_riserve_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento m/l termine</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_ml_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento breve termine</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_breve_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>B - TOTALE FONTI</strong></td>
                                    <td><strong><span id="h2_tot_fonti_anno1">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_fonti_tot">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_fonti_perc">0%</span></strong></td>
                                </tr>
                                
                                <!-- VERIFICA BILANCIAMENTO -->
                                <tr class="table-info">
                                    <td><strong>VERIFICA BILANCIAMENTO (B - A)</strong></td>
                                    <td colspan="3"><strong><span id="h2_sbilanciamento">€ 0,00</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="alertBilanciamento" class="alert alert-danger mt-2" style="display:none;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ATTENZIONE:</strong> FONTI e IMPIEGHI non sono bilanciati!
                    </div>

                    
                    <!-- H.3 STRATEGIA DI SOSTENIBILITÀ ECONOMICO-FINANZIARIA -->
                    <div class="card-custom">
                        <div class="card-header-c">
                            <span><i class="fas fa-chart-line"></i> H.3 Strategia di Sostenibilità Economico-Finanziaria</span>
                        </div>
                        <div class="card-body-c">
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Descrizione strategia di sostenibilità</label>
                                <textarea class="form-control" id="strategiaSostenibilita" rows="3" placeholder="Descrivere le modalità con cui l'impresa intende assicurare la sostenibilità economico-finanziaria nel medio-lungo termine post-investimento"></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                                <h6 class="mb-0 fw-bold">Proiezioni Triennali (Conto Economico Previsionale)</h6>
                                <button class="btn btn-success btn-sm" onclick="proiettaEserciziPrevisionali()">
                                    <i class="fas fa-magic"></i> Proietta Auto n+1, n+2, n+3
                                </button>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> <strong>Proiezione Automatica:</strong> Analizza i dati storici 2023-2024, calcola tassi di crescita, aggiunge l'impatto dell'efficientamento energetico e proietta i 3 anni futuri con effetti crescenti.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" style="font-size:0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width:28%;">Voce Conto Economico</th>
                                            <th style="width:14%;" class="text-center">2023 (€)</th>
                                            <th style="width:14%;" class="text-center">2024 (€)</th>
                                            <th style="width:14%; background:#d1fae5;" class="text-center">Anno n+1</th>
                                            <th style="width:14%; background:#d1fae5;" class="text-center">Anno n+2</th>
                                            <th style="width:16%; background:#d1fae5;" class="text-center">Anno n+3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="fw-bold">Fatturato/Ricavi vendite</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Altri ricavi/entrate</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td class="fw-bold">Valore della Produzione</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_2023" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_2024" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n1" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n2" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n3" readonly style="background:#dcfce7;"></td>
                                        </tr>
                                        <tr>
                                            <td>Consumo MP (acquisti ± Var. rimanenze)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Servizi</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Godimento beni di terzi</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Personale</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td class="fw-bold">MOL (EBITDA)</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_2023" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_2024" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n1" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n2" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n3" readonly style="background:#bfdbfe;"></td>
                                        </tr>
                                        <tr>
                                            <td>Ammortamenti</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td class="fw-bold">Risultato Operativo (EBIT)</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_2023" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_2024" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n1" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n2" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n3" readonly style="background:#fef3c7;"></td>
                                        </tr>
                                        <tr>
                                            <td>(±) Gestione Finanziaria</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>(±) Gestione Straordinaria</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-light">
                                            <td class="fw-bold">Risultato Lordo</td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_2023" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_2024" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n1" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n2" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n3" readonly style="background:#f9fafb;"></td>
                                        </tr>
                                        <tr>
                                            <td>Imposte e tasse (-)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td class="fw-bold">Risultato Netto</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_2023" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_2024" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n1" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n2" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n3" readonly style="background:#d1fae5;"></td>
                                        </tr>
                                        <tr class="table-info">
                                            <td class="fw-bold">Totale Attivo (Capitale Investito)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_2023" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_2024" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n1" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n2" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n3" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Totale Attivo:</strong> Inserire il valore totale dell'attivo patrimoniale per ciascun anno. Questo valore è necessario per il calcolo del ROI (Return on Investment = EBIT / Totale Attivo × 100).
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- H.4 ANALISI PER INDICI -->
                    <div class="card-custom mt-4">
                        <div class="card-header-c">
                            <span><i class="fas fa-chart-bar"></i> H.4 Analisi per Indici (Calcolati Automaticamente)</span>
                        </div>
                        <div class="card-body-c">
                            
                            <div class="alert alert-success">
                                <i class="fas fa-magic"></i> <strong>Calcolo Automatico:</strong> Gli indici vengono calcolati automaticamente dai dati inseriti in H.3. Il sistema aggiorna i valori ad ogni modifica.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" style="font-size:0.9rem;">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width:32%;">Indicatore</th>
                                            <th class="text-center">2023</th>
                                            <th class="text-center">2024</th>
                                            <th class="text-center">Anno n+1</th>
                                            <th class="text-center">Anno n+2</th>
                                            <th class="text-center">Anno n+3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ROI (Return on Investment)</strong><br><small class="text-muted">Formula: EBIT / Totale Attivo × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_2023" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_2024" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n1" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n2" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n3" readonly style="background:#dbeafe;"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>ROS (Return on Sales)</strong><br><small class="text-muted">Formula: EBIT / Fatturato × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_2023" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_2024" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n1" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n2" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n3" readonly style="background:#dbeafe;"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>EBITDA Margin %</strong><br><small class="text-muted">Formula: MOL / Fatturato × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_2023" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_2024" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n1" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n2" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n3" readonly style="background:#f3f4f6;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="alert alert-light border">
                                        <h6 class="fw-bold">💡 Interpretazione ROI</h6>
                                        <ul class="small mb-0">
                                            <li><strong>&gt; 10%:</strong> Ottimo rendimento del capitale</li>
                                            <li><strong>5-10%:</strong> Buon rendimento</li>
                                            <li><strong>&lt; 5%:</strong> Rendimento da migliorare</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-light border">
                                        <h6 class="fw-bold">💡 Interpretazione ROS</h6>
                                        <ul class="small mb-0">
                                            <li><strong>&gt; 15%:</strong> Marginalità elevata</li>
                                            <li><strong>5-15%:</strong> Marginalità media</li>
                                            <li><strong>&lt; 5%:</strong> Marginalità bassa</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
<!-- CALCOLO PUNTEGGI AUTOMATICO -->
                    <h5 class="mt-4 mb-3">Punteggi Tecnici Calcolati Automaticamente</h5>
                    
                    <!-- Criterio 1: Fabbisogni Energetici (Max 50 pt) -->
                    <div class="punteggio-box">
                        <h5>Criterio 1 - Fabbisogni Energetici (Max 50 pt)</h5>
                        
                        <div class="result-item">
                            <span class="result-label">P1 - Risparmio EPgl,nren (<span id="p1_riduzione_val">0%</span>)</span>
                            <span class="result-value" id="p1_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">0 pt se <30%; 5 pt se 30-35%; 10 pt se 35-40%; 15 pt se >40%</small>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P2 - Materiali CAM</span>
                            <span class="result-value" id="p2_punteggio">0 pt</span>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="checkbox" id="p2_cam" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="p2_cam">
                                Uso materiali conformi Criteri Ambientali Minimi (5 pt)
                            </label>
                        </div>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P3 - Riduzione CO2 (<span id="p3_riduzione_val">0%</span>)</span>
                            <span class="result-value" id="p3_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">0 pt se <30%; 10 pt se 30-40%; 20 pt se >40%</small>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P4 - Incremento FER (<span id="p4_incremento_val">0%</span>)</span>
                            <span class="result-value" id="p4_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">Max 10 pt se >40%</small>
                        
                        <hr>
                        <div class="result-item">
                            <span class="result-label"><strong>Totale Criterio 1</strong></span>
                            <span class="result-value" id="totale_criterio1">0 pt / 50 pt</span>
                        </div>
                    </div>
                    
                    <!-- Criterio 2: Costi/Benefici (Max 29 pt) -->
                    <div class="punteggio-box">
                        <h5>Criterio 2 - Rapporto Costi/Benefici (Max 29 pt)</h5>
                        
                        <div class="result-item">
                            <span class="result-label">P5 - Indice Costo Efficacia (<span id="p5_indice_val">0</span>)</span>
                            <span class="result-value" id="p5_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">Formula: (Costo Intervento in k€) / (EPgl ante - EPgl post) - Riferimento FAQ n. 32</small>
                        <small class="text-muted d-block"><strong>Scaglioni:</strong> 29 pt se P5&lt;3 | 25 pt se 3≤P5&lt;4 | 15 pt se 4≤P5&lt;5 | 10 pt se 5≤P5&lt;8 (Appendice 1 aggiornata)</small>
                    </div>
                    
                    <!-- Criterio 3: già calcolato sopra (Cantierabilità Max 15 pt) -->
                    
                    <!-- Criterio 4: già calcolato sopra (Monitoraggio Max 6 pt) -->
                    
                    <!-- Premialità: già calcolata sopra (Max 6 pt) -->
                </div>
                
                <!-- PUNTEGGIO TOTALE - CARD PROFESSIONALE COMPATTA -->
                <div class="card shadow-sm mb-4" style="max-width: 550px; margin: 0 auto; border-left: 4px solid #3498db;">
                    <div class="card-body p-4">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1 text-secondary" style="font-weight: 600;">
                                    <i class="fas fa-chart-line"></i> Valutazione Tecnica
                                </h6>
                                <small class="text-muted">Compila i criteri per calcolare il punteggio</small>
                            </div>
                            <span class="badge bg-light text-dark border px-3 py-2" id="badgeAmmissibilita" style="font-size: 0.85rem;">
                                In compilazione
                            </span>
                        </div>
                        
                        <!-- Punteggio principale -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-baseline mb-2">
                                <span class="text-muted" style="font-size: 0.95rem;">Punteggio attuale</span>
                                <span class="fw-bold" style="font-size: 2rem; color: #3498db;" id="punteggioTotale">0/100</span>
                            </div>
                            
                            <!-- Progress bar elegante -->
                            <div class="progress" style="height: 8px; background-color: #e9ecef; border-radius: 10px;">
                                <div class="progress-bar" id="progressBarPunteggio" 
                                     role="progressbar" 
                                     style="width: 0%; background: linear-gradient(90deg, #3498db, #2980b9); border-radius: 10px;" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" style="font-size: 0.75rem;">0</small>
                                <small class="fw-bold" style="font-size: 0.8rem; color: #e67e22;">Soglia: 50</small>
                                <small class="text-muted" style="font-size: 0.75rem;">100</small>
                            </div>
                        </div>
                        
                        <!-- Stato e info -->
                        <div class="d-flex align-items-center gap-2 p-2" style="background-color: #f8f9fa; border-radius: 6px;">
                            <i class="fas fa-info-circle text-primary" style="font-size: 0.95rem;"></i>
                            <small class="text-muted mb-0" style="font-size: 0.85rem;">
                                Soglia minima richiesta: <strong>50 punti</strong>
                            </small>
                        </div>
                    </div>
                </div></div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(4)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(6)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
                        </div>
            
<!-- ============================================ -->
            <!-- FASE 6: EXPORT E CHECKLIST DOCUMENTALE -->
            <!-- ============================================ -->
            <div id="view-6" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-export"></i> Fase 6: Checklist Documentale ed Export</h2>
                <p class="fase-subtitle">Controllo finale e generazione automatica documenti prima dell'invio</p>
                
                <!-- Checklist Documenti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-folder-open"></i> Documenti Obbligatori da Caricare su Piattaforma</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_domanda">
                            <label class="form-check-label" for="doc_domanda">
                                <strong>1. Domanda (Allegato 2.1.A)</strong> firmata digitalmente dal legale rappresentante
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_mol">
                            <label class="form-check-label" for="doc_mol">
                                <strong>2. Allegato C (DSAN MOL)</strong> asseverato da Commercialista/Revisore/CAF e firmato digitalmente
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_capacita">
                            <label class="form-check-label" for="doc_capacita">
                                <strong>3. Allegato D.1 o D.2 (Capacità Finanziaria)</strong> attestazione banca o dichiarazione revisore
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_diagnosi">
                            <label class="form-check-label" for="doc_diagnosi">
                                <strong>4. Diagnosi Energetica</strong> (UNI CEI EN 16247) firmata da EGE/ESCO + Ricevuta trasmissione ENEA
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_ape">
                            <label class="form-check-label" for="doc_ape">
                                <strong>5. APE Ex-Ante e Simulazione Ex-Post</strong> (per interventi su edifici)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_preventivi">
                            <label class="form-check-label" for="doc_preventivi">
                                <strong>6. Preventivi e Computi Metrici</strong> firmati da tecnico abilitato
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_formulario">
                            <label class="form-check-label" for="doc_formulario">
                                <strong>7. Formulario (Allegato F)</strong> descrittivo del programma investimenti
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_dnsh">
                            <label class="form-check-label" for="doc_dnsh">
                                <strong>8. Allegato G (DNSH)</strong> Dichiarazione + Checklist climatiche
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_perizia">
                            <label class="form-check-label" for="doc_perizia">
                                <strong>9. Perizia Asseverata</strong> conformità immobile e titolo disponibilità
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_bollo">
                            <label class="form-check-label" for="doc_bollo">
                                <strong>10. Marca da Bollo</strong> € 16,00 annullata
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Riepilogo Finale Completo -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-clipboard-check"></i> Riepilogo Finale Domanda</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary">Dati Impresa</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Ragione Sociale:</strong></td><td><span id="final_ragioneSociale">-</span></td></tr>
                                <tr><td><strong>P.IVA:</strong></td><td><span id="final_partitaIva">-</span></td></tr>
                                <tr><td><strong>Dimensione:</strong></td><td><span id="final_dimensione">-</span></td></tr>
                                <tr><td><strong>ATECO:</strong></td><td><span id="final_ateco">-</span></td></tr>
                                <tr><td><strong>Sede Intervento:</strong></td><td><span id="final_sedIntervento">-</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary">Dati Economici</h5>
                            <table class="table table-sm">
                                <tr><td><strong>MOL:</strong></td><td><span id="final_mol">€ 0,00</span></td></tr>
                                <tr><td><strong>Investimento:</strong></td><td><span id="final_investimento">€ 0,00</span></td></tr>
                                <tr><td><strong>Contributo:</strong></td><td><span id="final_contributo">€ 0,00</span></td></tr>
                                <tr><td><strong>Regime Aiuto:</strong></td><td><span id="final_regime">-</span></td></tr>
                                <tr><td><strong>Indicatore Ordinatore:</strong></td><td><span id="final_ordinatore">0,00000</span></td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-success">Performance Energetiche</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Risparmio Energetico:</strong></td><td class="text-success"><strong><span id="final_risparmio">0,00%</span></strong></td></tr>
                                <tr><td><strong>Riduzione CO2:</strong></td><td class="text-success"><strong><span id="final_co2">0,00%</span></strong></td></tr>
                                <tr><td><strong>Incremento FER:</strong></td><td class="text-success"><strong><span id="final_fer">0,00%</span></strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-success">Punteggio Tecnico</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Punteggio Totale:</strong></td><td><span id="final_punteggio" class="text-primary fs-4">0 / 100</span></td></tr>
                                <tr><td><strong>Ammissibilità:</strong></td><td><span id="final_ammissibilita">-</span></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Export Documenti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-download"></i> Generazione Automatica Documenti</h3>
                    
                    <div class="alert-success-custom">
                        <strong><i class="fas fa-magic"></i> Documenti Generati Automaticamente:</strong>
                        L'applicazione compilerà automaticamente tutti i documenti ufficiali con i dati inseriti.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    <h5 class="card-title">Allegato 2.1.A</h5>
                                    <p class="card-text">Domanda di Finanziamento con tutte le dichiarazioni</p>
                                    <button class="btn btn-danger" onclick="esportaDomandaPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Allegato F</h5>
                                    <p class="card-text">Formulario Completo del Progetto</p>
                                    <button class="btn btn-primary" onclick="esportaFormularioPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Allegato C (DSAN)</h5>
                                    <p class="card-text">Dichiarazione MOL per Criterio Ordinatore</p>
                                    <button class="btn btn-warning" onclick="esportaDSANPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Budget Excel</h5>
                                    <p class="card-text">Quadro economico dettagliato</p>
                                    <button class="btn btn-success" onclick="esportaExcel()">
                                        <i class="fas fa-file-excel"></i> Genera Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-alt fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Riepilogo Completo</h5>
                                    <p class="card-text">Documento riepilogativo PDF</p>
                                    <button class="btn btn-info" onclick="esportaRiepilogoPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert-success-custom mt-4">
                    <h5><i class="fas fa-check-circle"></i> Domanda Completata!</h5>
                    <p class="mb-0">
                        Verifica che tutti i documenti siano pronti e procedi con il caricamento sulla piattaforma ufficiale della Regione Siciliana.
                        Ricordati di salvare il progetto per conservare tutti i dati inseriti.
                    </p>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(5)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-success btn-navigation" onclick="finalizza()">
                        <i class="fas fa-flag-checkered"></i> Finalizza
                    </button>
                </div>
            </div>
            
        </div>
    
</div>


</div>

    <script>
        // ============================================
        // STATO GLOBALE APPLICAZIONE
        // ============================================
        // Variabile per gestire modifica preventivi
        let preventivoInModifica = null;
        const DATA_PUBBLICAZIONE_AVVISO = new Date('2025-10-15');

        let datiDomanda = {
            anagrafica: {},
            legaleRappresentante: {},
            unitaProduttiva: {},
            mol: {},
            dimensioneAziendale: {},
            soci: [],
            aiutiDeMinimis: [],
            professionista: {},
            diagnosi: {},
            preventivi: [],
            istanza: {},
            formulario: {},
            export: {}
        };
        
        let currentStep = 1;
        
        // ============================================
        // NAVIGAZIONE TRA LE FASI
      function goToStep(step) {
    // FIX: Salva la fase corrente (currentStep) invece della fase target (step)
    if (typeof salvaDatiFase === 'function') {
        try { 
            // Se è la prima esecuzione, currentStep potrebbe essere undefined/null
            if(currentStep) salvaDatiFase(currentStep); 
        } catch(e) { 
            console.error("Errore salvataggio fase " + currentStep, e); 
        }
    }
    
    // Logica esistente per nascondere/mostrare views
    document.querySelectorAll('.view-section').forEach(view => view.style.display = 'none');
    document.querySelectorAll('.nav-link-custom').forEach(nav => nav.classList.remove('active'));
    
    var viewTarget = document.getElementById('view-' + step);
    if (viewTarget) viewTarget.style.display = 'block';
    
    var navTarget = document.getElementById('nav-fase' + step);
    if (navTarget) navTarget.classList.add('active');
    
    window.scrollTo(0, 0);
    
    // Aggiorna lo stato globale
    currentStep = step;
    
    // Carica i dati della nuova fase
    if (typeof caricaDatiFase === 'function') {
        try { caricaDatiFase(step); } catch(e) { console.error(e); }
    }
}
        
        // ============================================
        // SALVATAGGIO E CARICAMENTO DATI
        // ============================================
        function salvaDatiFase(fase) {
            try {
                switch(fase) {
                    case 1: // Anagrafica
                        datiDomanda.anagrafica = {
                            ragioneSociale: getValue('ragioneSociale'),
                            partitaIva: getValue('partitaIva'),
                            codiceFiscale: getValue('codiceFiscale'),
                            pec: getValue('pec'),
                            codiceAteco: getValue('codiceAteco'),
                            dimensioneImpresa: getValue('dimensioneImpresa'),
                            formaGiuridica: getValue('formaGiuridica'),
                            sedeLegale: getValue('sedeLegale'),
                            annoCostituzione: getValue('annoCostituzione'),
                            telefono: getValue('telefono')
                        };
                        
                        datiDomanda.legaleRappresentante = {
                            nome: getValue('lrNome'),
                            cognome: getValue('lrCognome'),
                            cf: getValue('lrCF'),
                            dataNascita: getValue('lrDataNascita'),
                            luogoNascita: getValue('lrLuogoNascita'),
                            residenza: getValue('lrResidenza'),
                            qualita: getValue('lrQualita')
                        };
                        
                        datiDomanda.unitaProduttiva = {
                            indirizzo: getValue('indirizzoIntervento'),
                            coordinate: getValue('coordinateCatastali'),
                            titolo: getValue('titoloDisponibilita'),
                            titoliAutorizzativi: getValue('titoliAutorizzativi'),
                            agibilita: getValue('certificatoAgibilita')
                        };
                        break;
                        
                        case 2: // MOL
                        // Calcola i totali prima di salvare (sorgente condizionale)
                        const vProd = getNumericValue('valoreProduzione');
                        const cMat = getNumericValue('materiePrime');
                        const cServ = getNumericValue('costiServizi');
                        const cBeni = getNumericValue('costiBeniTerzi');
                        const cPers = getNumericValue('spesePersonale');
                        const cVar = getNumericValue('variazioniRimanenze');
                        const cOneri = getNumericValue('oneriDiversi');
                        
                        const totCosti = _getTotaleCosti();   // ← condizionale: dettaglio o singolo
                        const valMOL = vProd - totCosti;
                        
                        // Recupera indicatori dal DOM se già calcolati
                        const indOrdEl = document.getElementById('indicatoreOrdinatore');
                        const indOrd = indOrdEl ? parseFloat(indOrdEl.textContent.replace(',', '.')) : 0;
                        
                        // Recupera totali dimensione aziendale
                        const totULA = getNumericValue('totale_ula') || 
                                      (getNumericValue('ula_dichiarante') + 
                                       getNumericValue('ula_associate') + 
                                       getNumericValue('ula_collegate'));
                        const totFatt = getNumericValue('totale_fatturato') || 
                                       (getNumericValue('fatturato_dichiarante') + 
                                        getNumericValue('fatturato_associate') + 
                                        getNumericValue('fatturato_collegate'));
                        const totBil = getNumericValue('totale_bilancio') || 
                                      (getNumericValue('bilancio_dichiarante') + 
                                       getNumericValue('bilancio_associate') + 
                                       getNumericValue('bilancio_collegate'));
                        
                        // Determina categoria impresa
                        let categoria = 'Grande Impresa';
                        if (totULA < 50 && totFatt < 10 && totBil < 10) {
                            categoria = 'Piccola Impresa';
                        } else if (totULA < 250 && totFatt < 50 && totBil < 43) {
                            categoria = 'Media Impresa';
                        }
                        
                        datiDomanda.mol = {
                            annoRiferimento: getValue('annoRiferimento'),
                            tipoDocumento: getValue('tipoDocumento'),
                            regimeContabile: getValue('regimeContabile'),
                            valoreProduzione: vProd,
                            materiePrime: cMat,
                            costiServizi: cServ,
                            costiBeniTerzi: cBeni,
                            spesePersonale: cPers,
                            variazioniRimanenze: cVar,
                            oneriDiversi: cOneri,
                            costiProduzioneTotale: getNumericValue('costiProduzioneTotale'),
                            // VALORI CALCOLATI AGGIUNTI:
                            costiProduzione: totCosti,
                            valoreMOL: valMOL,
                            indicatoreOrdinatore: indOrd,
                            ammortamenti: getNumericValue('ammortamenti') || 0,
                            altriCosti: getNumericValue('altriCosti') || 0,
                            costoTotaleInvestimento: getNumericValue('costoTotaleInvestimento'),
                            contributoRichiesto: getNumericValue('contributoRichiesto'),
                            regimeAiuto: getRadioValue('regimeAiuto')
                        };
                        
                        datiDomanda.dimensioneAziendale = {
                            ula_dichiarante: getNumericValue('ula_dichiarante'),
                            fatturato_dichiarante: getNumericValue('fatturato_dichiarante'),
                            bilancio_dichiarante: getNumericValue('bilancio_dichiarante'),
                            ula_associate: getNumericValue('ula_associate'),
                            fatturato_associate: getNumericValue('fatturato_associate'),
                            bilancio_associate: getNumericValue('bilancio_associate'),
                            ula_collegate: getNumericValue('ula_collegate'),
                            fatturato_collegate: getNumericValue('fatturato_collegate'),
                            bilancio_collegate: getNumericValue('bilancio_collegate'),
                            // TOTALI CALCOLATI AGGIUNTI:
                            dipendenti: totULA,
                            fatturato: totFatt,
                            attivo: totBil,
                            categoria: categoria,
                            tipoImpresa: getRadioValue('tipoImpresa')
                        };
                        
                        datiDomanda.professionista = {
                            tipo: getValue('tipoProfessionista'),
                            nome: getValue('nomeProfessionista'),
                            cf: getValue('cfProfessionista'),
                            iscrizione: getValue('iscrizioneAlbo'),
                            sede: getValue('sedeProfessionista')
                        };
                        break;
                        
                    case 3: // Diagnosi
                        datiDomanda.diagnosi = {
                            epgl_ante: getNumericValue('epgl_ante'),
                            epgl_post: getNumericValue('epgl_post'),
                            co2_ante: getNumericValue('co2_ante'),
                            co2_post: getNumericValue('co2_post'),
                            fer_ante: getNumericValue('fer_ante'),
                            fer_post: getNumericValue('fer_post'),
                            opereMurarie: getNumericValue('opereMurarie'),
                            speseTecniche: getNumericValue('speseTecniche')
                        };
                        break;
                        
                    case 4: // Istanza
                        datiDomanda.istanza = {
                            numeroMarcaBollo: getValue('numeroMarcaBollo'),
                            dataMarcaBollo: getValue('dataMarcaBollo')
                        };
                        break;
                        
                    case 5: // Formulario
                        // Salva array WP e Cronoprogramma se esistono in memoria
                        if (!datiDomanda.workPackages) datiDomanda.workPackages = [];
                        if (!datiDomanda.cronoprogramma) datiDomanda.cronoprogramma = [];
                        
                        datiDomanda.formulario = {
                            titoloProgetto: getValue('titoloProgetto'),
                            acronimoProgetto: getValue('acronimoProgetto'),
                            durataProgetto: getValue('durataProgetto'),
                            missionAttivita: getValue('missionAttivita'),
                            attivitaEconomica: getValue('attivitaEconomica'),
                            contestualizzazioneFabbisogni: getValue('contestualizzazioneFabbisogni'),
                            obiettiviPerseguiti: getValue('obiettiviPerseguiti'),
                            struttureMonitoraggio: getValue('struttureMonitoraggio'),
                            figureEnergyManager: getValue('figureEnergyManager'),
                            descrizioneTecnica: getValue('descrizioneTecnica'),
                            maturitaProgettuale: getValue('maturitaProgettuale'),
                            cronoprogramma: getValue('cronoprogramma'),
                            sistemaMonitoraggio: getValue('sistemaMonitoraggio'),
                            illustrazioneBudget: getValue('illustrazioneBudget'),
                            pianoCoperture: getValue('pianoCoperture'),
                            dettagliEnergyManager: getValue('dettagliEnergyManager'),
                            dettagliSistemiMisura: getValue('dettagliSistemiMisura'),
                            cantierabilita: getRadioValue('cantierabilita')
                        };
                        
                        // *** FIX CRITICO: Salva tabelle finanziarie H2, H3, Budget ***
                        
                        // Salva Piano H.2 (Impieghi e Fonti)
                        datiDomanda.formulario.h2 = {
                            // Impieghi
                            inv_immat_anno1: getNumericValue('h2_inv_immat_anno1'),
                            inv_immat_tot: getNumericValue('h2_inv_immat_tot'),
                            inv_mat_anno1: getNumericValue('h2_inv_mat_anno1'),
                            inv_mat_tot: getNumericValue('h2_inv_mat_tot'),
                            iva_anno1: getNumericValue('h2_iva_anno1'),
                            iva_tot: getNumericValue('h2_iva_tot'),
                            // Fonti
                            contributo_anno1: getNumericValue('h2_contributo_anno1'),
                            contributo_tot: getNumericValue('h2_contributo_tot'),
                            riserve_anno1: getNumericValue('h2_riserve_anno1'),
                            riserve_tot: getNumericValue('h2_riserve_tot'),
                            cap_sociale_anno1: getNumericValue('h2_cap_sociale_anno1'),
                            cap_sociale_tot: getNumericValue('h2_cap_sociale_tot'),
                            finanz_soci_anno1: getNumericValue('h2_finanz_soci_anno1'),
                            finanz_soci_tot: getNumericValue('h2_finanz_soci_tot'),
                            finanz_ml_anno1: getNumericValue('h2_finanz_ml_anno1'),
                            finanz_ml_tot: getNumericValue('h2_finanz_ml_tot'),
                            finanz_breve_anno1: getNumericValue('h2_finanz_breve_anno1'),
                            finanz_breve_tot: getNumericValue('h2_finanz_breve_tot')
                        };
                        
                        // Salva Piano H.3 (Conto Economico Previsionale)
                        datiDomanda.formulario.h3 = {};
                        const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
                        const voci = ['fatt', 'altri', 'vp', 'mp', 'serv', 'god', 'pers', 'mol', 'amm', 'ro', 'fin', 'straord', 'rl', 'imp', 'rn', 'attivo'];
                        voci.forEach(function(v) {
                            anni.forEach(function(a) {
                                const id = 'h3_' + v + '_' + a;
                                datiDomanda.formulario.h3[id] = getNumericValue(id);
                            });
                        });
                        
                        // Salva indici H.4
                        const anniH4 = ['2023', '2024', 'n1', 'n2', 'n3'];
                        const indici = ['roi', 'ros', 'marg'];
                        indici.forEach(function(ind) {
                            anniH4.forEach(function(a) {
                                const id = 'h4_' + ind + '_' + a;
                                const elem = document.getElementById(id);
                                datiDomanda.formulario.h3[id] = elem ? elem.value : '';
                            });
                        });
                        
                        // Salva Tabella 3 (Budget)
                        // CORRETTO
                    datiDomanda.formulario.budget = {
                        cat_a: getNumericValue('budget_a_totale'), // Era 'budget_a'
                        cat_b: getNumericValue('budget_b_totale'), // Era 'budget_b'
                        cat_c: getNumericValue('budget_c_totale'), // Era 'budget_c'
                        cat_d: getNumericValue('budget_d_totale'), // Era 'budget_d'
                        cat_e: getNumericValue('budget_e_totale'), // Era 'budget_e' (Mancava proprio)
                        
                        // ... lascia invariati gli altri campi (murarie, tecniche e contributi) ...
                        murarie: getNumericValue('opereMurarie'),
                        tecniche: getNumericValue('speseTecniche'),
                        cat_a_contributo: getNumericValue('budget_a_contributo'),
                        cat_b_contributo: getNumericValue('budget_b_contributo'),
                        cat_c_contributo: getNumericValue('budget_c_contributo'),
                        cat_d_contributo: getNumericValue('budget_d_contributo'),
                        cat_e_contributo: getNumericValue('budget_e_contributo'), // Aggiungi anche questo per sicurezza
                        murarie_contributo: getNumericValue('opereMurarie_contributo'),
                        tecniche_contributo: getNumericValue('speseTecniche_contributo')
                    };
                        
                        break;
                }
            } catch (error) {
                console.error('Errore salvataggio fase:', error);
            }
        }
        
        function caricaDatiFase(fase) {
            try {
                switch(fase) {
                    case 1:
                        if (datiDomanda.anagrafica) {
                            setValue('ragioneSociale', datiDomanda.anagrafica.ragioneSociale);
                            setValue('partitaIva', datiDomanda.anagrafica.partitaIva);
                            setValue('codiceFiscale', datiDomanda.anagrafica.codiceFiscale);
                            setValue('pec', datiDomanda.anagrafica.pec);
                            setValue('codiceAteco', datiDomanda.anagrafica.codiceAteco);
                            setValue('dimensioneImpresa', datiDomanda.anagrafica.dimensioneImpresa);
                            setValue('formaGiuridica', datiDomanda.anagrafica.formaGiuridica);
                            setValue('sedeLegale', datiDomanda.anagrafica.sedeLegale);
                            setValue('annoCostituzione', datiDomanda.anagrafica.annoCostituzione);
                            setValue('telefono', datiDomanda.anagrafica.telefono);
                        }
                        
                        if (datiDomanda.legaleRappresentante) {
                            setValue('lrNome', datiDomanda.legaleRappresentante.nome);
                            setValue('lrCognome', datiDomanda.legaleRappresentante.cognome);
                            setValue('lrCF', datiDomanda.legaleRappresentante.cf);
                            setValue('lrDataNascita', datiDomanda.legaleRappresentante.dataNascita);
                            setValue('lrLuogoNascita', datiDomanda.legaleRappresentante.luogoNascita);
                            setValue('lrResidenza', datiDomanda.legaleRappresentante.residenza);
                            setValue('lrQualita', datiDomanda.legaleRappresentante.qualita);
                        }
                        
                        if (datiDomanda.unitaProduttiva) {
                            setValue('indirizzoIntervento', datiDomanda.unitaProduttiva.indirizzo);
                            setValue('coordinateCatastali', datiDomanda.unitaProduttiva.coordinate);
                            setValue('titoloDisponibilita', datiDomanda.unitaProduttiva.titolo);
                            setValue('titoliAutorizzativi', datiDomanda.unitaProduttiva.titoliAutorizzativi);
                            setValue('certificatoAgibilita', datiDomanda.unitaProduttiva.agibilita);
                        }
                        break;
                        
                    case 2:
                        if (datiDomanda.mol) {
                            setValue('annoRiferimento', datiDomanda.mol.annoRiferimento);
                            setValue('tipoDocumento', datiDomanda.mol.tipoDocumento);
                            setValue('regimeContabile', datiDomanda.mol.regimeContabile);
                            setValue('valoreProduzione', datiDomanda.mol.valoreProduzione);
                            setValue('materiePrime', datiDomanda.mol.materiePrime);
                            setValue('costiServizi', datiDomanda.mol.costiServizi);
                            setValue('costiBeniTerzi', datiDomanda.mol.costiBeniTerzi);
                            setValue('spesePersonale', datiDomanda.mol.spesePersonale);
                            setValue('variazioniRimanenze', datiDomanda.mol.variazioniRimanenze);
                            setValue('oneriDiversi', datiDomanda.mol.oneriDiversi);
                            setValue('costiProduzioneTotale', datiDomanda.mol.costiProduzioneTotale);
                            setValue('costoTotaleInvestimento', datiDomanda.mol.costoTotaleInvestimento);
                            setValue('contributoRichiesto', datiDomanda.mol.contributoRichiesto);
                            setRadioValue('regimeAiuto', datiDomanda.mol.regimeAiuto);
                        }
                        // Sync sempre: determina tipoDocumento da formaGiuridica (step 1),
                        // mostra/nasconde i wrapper costi e ricalcola MOL
                        aggiornaSezione_DichRedditi();
                        
                        // FIX: Trigger manuale visibilità sezione De Minimis
                        if (datiDomanda.mol) {
                            const regime = datiDomanda.mol.regimeAiuto;
                            const sezioneDeMinimis = document.getElementById('sezioneDeMinimis');
                            const sezioneDeMinimisIstanza = document.getElementById('sezioneDeMinimisIstanza');
                            
                            if (regime === 'deminimis') {
                                if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'block';
                                if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'block';
                            } else {
                                if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'none';
                                if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'none';
                            }
                        }
                        
                        if (datiDomanda.dimensioneAziendale) {
                            setValue('ula_dichiarante', datiDomanda.dimensioneAziendale.ula_dichiarante);
                            setValue('fatturato_dichiarante', datiDomanda.dimensioneAziendale.fatturato_dichiarante);
                            setValue('bilancio_dichiarante', datiDomanda.dimensioneAziendale.bilancio_dichiarante);
                            setValue('ula_associate', datiDomanda.dimensioneAziendale.ula_associate);
                            setValue('fatturato_associate', datiDomanda.dimensioneAziendale.fatturato_associate);
                            setValue('bilancio_associate', datiDomanda.dimensioneAziendale.bilancio_associate);
                            setValue('ula_collegate', datiDomanda.dimensioneAziendale.ula_collegate);
                            setValue('fatturato_collegate', datiDomanda.dimensioneAziendale.fatturato_collegate);
                            setValue('bilancio_collegate', datiDomanda.dimensioneAziendale.bilancio_collegate);
                            setRadioValue('tipoImpresa', datiDomanda.dimensioneAziendale.tipoImpresa);
                            calcolaTotaliDimensione();
                        }
                        break;
                        
                    case 3:
                        if (datiDomanda.diagnosi) {
                            setValue('epgl_ante', datiDomanda.diagnosi.epgl_ante);
                            setValue('epgl_post', datiDomanda.diagnosi.epgl_post);
                            setValue('co2_ante', datiDomanda.diagnosi.co2_ante);
                            setValue('co2_post', datiDomanda.diagnosi.co2_post);
                            setValue('fer_ante', datiDomanda.diagnosi.fer_ante);
                            setValue('fer_post', datiDomanda.diagnosi.fer_post);
                            setValue('opereMurarie', datiDomanda.diagnosi.opereMurarie);
                            setValue('speseTecniche', datiDomanda.diagnosi.speseTecniche);
                            calcolaRiduzioniEnergetiche();
                        }
                        aggiornaListaPreventivi();
                        // Aggiorna contatore preventivi
                        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                            preventivoCounter = Math.max(...datiDomanda.preventivi.map(p => p.id));
                        } else {
                            preventivoCounter = 0;
                        }
                        break;
                        
                    case 4:
                        if (datiDomanda.istanza) {
                            setValue('numeroMarcaBollo', datiDomanda.istanza.numeroMarcaBollo);
                            setValue('dataMarcaBollo', datiDomanda.istanza.dataMarcaBollo);
                        }
                        aggiornaRiepilogoFase4();
                        break;
                        
                    case 5:
                        if (datiDomanda.formulario) {
                            setValue('titoloProgetto', datiDomanda.formulario.titoloProgetto);
                            setValue('acronimoProgetto', datiDomanda.formulario.acronimoProgetto);
                            setValue('durataProgetto', datiDomanda.formulario.durataProgetto);
                            setValue('missionAttivita', datiDomanda.formulario.missionAttivita);
                            setValue('attivitaEconomica', datiDomanda.formulario.attivitaEconomica);
                            setValue('contestualizzazioneFabbisogni', datiDomanda.formulario.contestualizzazioneFabbisogni);
                            setValue('obiettiviPerseguiti', datiDomanda.formulario.obiettiviPerseguiti);
                            setValue('struttureMonitoraggio', datiDomanda.formulario.struttureMonitoraggio);
                            setValue('figureEnergyManager', datiDomanda.formulario.figureEnergyManager);
                            setValue('descrizioneTecnica', datiDomanda.formulario.descrizioneTecnica);
                            setValue('maturitaProgettuale', datiDomanda.formulario.maturitaProgettuale);
                            setValue('cronoprogramma', datiDomanda.formulario.cronoprogramma);
                            setValue('sistemaMonitoraggio', datiDomanda.formulario.sistemaMonitoraggio);
                            setValue('illustrazioneBudget', datiDomanda.formulario.illustrazioneBudget);
                            setValue('pianoCoperture', datiDomanda.formulario.pianoCoperture);
                            setValue('dettagliEnergyManager', datiDomanda.formulario.dettagliEnergyManager);
                            setValue('dettagliSistemiMisura', datiDomanda.formulario.dettagliSistemiMisura);
                            setRadioValue('cantierabilita', datiDomanda.formulario.cantierabilita);
                        }
                        
                        // Aggiorna anche costo totale dal riepilogo preventivi
                        const totaleInv = datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0);
                        setValue('costoTotaleFormulario', totaleInv.toFixed(2));
                        
                        // *** FIX CRITICO: Carica tabelle finanziarie H2, H3, Budget ***
                        
                        // Carica Piano H.2
                        if (datiDomanda.formulario.h2) {
                            const h2 = datiDomanda.formulario.h2;
                            setValue('h2_inv_immat_anno1', h2.inv_immat_anno1);
                            setValue('h2_inv_immat_tot', h2.inv_immat_tot);
                            setValue('h2_inv_mat_anno1', h2.inv_mat_anno1);
                            setValue('h2_inv_mat_tot', h2.inv_mat_tot);
                            setValue('h2_iva_anno1', h2.iva_anno1);
                            setValue('h2_iva_tot', h2.iva_tot);
                            setValue('h2_contributo_anno1', h2.contributo_anno1);
                            setValue('h2_contributo_tot', h2.contributo_tot);
                            setValue('h2_riserve_anno1', h2.riserve_anno1);
                            setValue('h2_riserve_tot', h2.riserve_tot);
                            setValue('h2_cap_sociale_anno1', h2.cap_sociale_anno1);
                            setValue('h2_cap_sociale_tot', h2.cap_sociale_tot);
                            setValue('h2_finanz_soci_anno1', h2.finanz_soci_anno1);
                            setValue('h2_finanz_soci_tot', h2.finanz_soci_tot);
                            setValue('h2_finanz_ml_anno1', h2.finanz_ml_anno1);
                            setValue('h2_finanz_ml_tot', h2.finanz_ml_tot);
                            setValue('h2_finanz_breve_anno1', h2.finanz_breve_anno1);
                            setValue('h2_finanz_breve_tot', h2.finanz_breve_tot);
                            // Ricalcola H.2
                            calcolaH2();
                        }
                        
                        // Carica Piano H.3
                        if (datiDomanda.formulario.h3) {
                            const h3 = datiDomanda.formulario.h3;
                            Object.keys(h3).forEach(function(key) {
                                const elem = document.getElementById(key);
                                if (elem) {
                                    elem.value = h3[key];
                                }
                            });
                            // Ricalcola H.3
                            calcolaH3();
                        }
                        
                        // Carica Budget
                        if (datiDomanda.formulario.budget) {
                            const budget = datiDomanda.formulario.budget;
                            setValue('budget_a_totale', budget.cat_a); // Era 'budget_a'
                            setValue('budget_b_totale', budget.cat_b); // Era 'budget_b'
                            setValue('budget_c_totale', budget.cat_c); // Era 'budget_c'
                            setValue('budget_d_totale', budget.cat_d); // Era 'budget_d'
                            setValue('budget_e_totale', budget.cat_e); // Aggiungi questo
                            setValue('opereMurarie', budget.murarie);
                            setValue('speseTecniche', budget.tecniche);
                            setValue('budget_a_contributo', budget.cat_a_contributo);
                            setValue('budget_b_contributo', budget.cat_b_contributo);
                            setValue('budget_c_contributo', budget.cat_c_contributo);
                            setValue('budget_d_contributo', budget.cat_d_contributo);
                            setValue('opereMurarie_contributo', budget.murarie_contributo);
                            setValue('speseTecniche_contributo', budget.tecniche_contributo);
                            // Ricalcola Budget
                            calcolaBudgetTotale();
                        } else {
                            // Se non ci sono dati budget salvati, popola da preventivi
                            popolaBudgetDaPreventivi();
                        }
                        
                        // Renderizza tabelle WP e Cronoprogramma
                        renderizzaTabellaWP();
                        renderizzaTabellaCrono();
                        
                        // FIX CRITICO: Aggiorna contatori per evitare collisione ID
                        if (datiDomanda.workPackages && datiDomanda.workPackages.length > 0) {
                            wpCounter = Math.max(...datiDomanda.workPackages.map(wp => wp.id));
                        }
                        if (datiDomanda.cronoprogramma && datiDomanda.cronoprogramma.length > 0) {
                            cronoCounter = Math.max(...datiDomanda.cronoprogramma.map(c => c.id));
                        }
                        
                        calcolaPunteggi();
                        break;
                        
                    case 6:
                        aggiornaRiepilogoFinale();
                        break;
                }
            } catch (error) {
                console.error('Errore caricamento fase:', error);
            }
        }
        
        // Helper functions
        function getValue(id) {
            const elem = document.getElementById(id);
            return elem ? elem.value : '';
        }
        
        function getNumericValue(id) {
            const elem = document.getElementById(id);
            return elem ? (parseFloat(elem.value) || 0) : 0;
        }
        
        function getCheckValue(id) {
            const elem = document.getElementById(id);
            return elem ? elem.checked : false;
        }
        
        function getRadioValue(name) {
            const elem = document.querySelector(`input[name="${name}"]:checked`);
            return elem ? elem.value : '';
        }
        
        function setValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.value = value || '';
        }
        
        function setCheckValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.checked = !!value;
        }
        
        function setRadioValue(name, value) {
            const elem = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (elem) elem.checked = true;
        }
        
        function setTextValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = value || '';
        }
        
        // ============================================
        // CALCOLI AUTOMATICI
        // ============================================

        /** Restituisce il totale costi dalla sorgente corretta in base al tipoDocumento attivo */
        function _getTotaleCosti() {
            const tipoDoc = document.getElementById('tipoDocumento');
            if (tipoDoc && tipoDoc.value === 'dichredditi') {
                return getNumericValue('costiProduzioneTotale');
            }
            return getNumericValue('materiePrime') +
                   getNumericValue('costiServizi') +
                   getNumericValue('costiBeniTerzi') +
                   getNumericValue('spesePersonale') +
                   getNumericValue('variazioniRimanenze') +
                   getNumericValue('oneriDiversi');
        }

        function calcolaMOL() {
            const valore      = getNumericValue('valoreProduzione');
            const totaleCosti = _getTotaleCosti();
            const mol         = valore - totaleCosti;
            
            setTextValue('molCalcolato', formatEuro(mol));
            setTextValue('totaleCosti', formatEuro(totaleCosti));
            
            calcolaIndicatoreOrdinatore();
        }
        
        function calcolaIndicatoreOrdinatore() {
            const valore      = getNumericValue('valoreProduzione');
            const totaleCosti = _getTotaleCosti();
            const mol         = valore - totaleCosti;
            const costo       = getNumericValue('costoTotaleInvestimento');
            
            if (costo === 0) {
                setTextValue('indicatoreOrdinatore', '0,00000');
                setTextValue('punteggioOrdinatore', '0,00000');
                return;
            }
            
            const indicatore = mol / costo;
            const formattato = indicatore.toFixed(5).replace('.', ',');
            
            setTextValue('indicatoreOrdinatore', formattato);
            setTextValue('punteggioOrdinatore', formattato);
        }

        // ============================================
        // PROCEDURA DICHIARAZIONE REDDITI (S.n.c./S.a.s./Ditta Ind.)
        // ============================================

        /**
         * Orchestratore principale della Fase 2 condizionale.
         * Determina automaticamente il tipoDocumento dalla formaGiuridica,
         * abilita/disabilita il dropdown, mostra/nasconde:
         *   - sezione procedura con mappatura quadri fiscali
         *   - dettaglio costi (6 voci) per bilancio
         *   - campo singolo "Costi della Produzione" per dichiarazione dei redditi
         * Chiamata da: onchange formaGiuridica, onchange tipoDocumento, restore case 2.
         */
        function aggiornaSezione_DichRedditi() {
            const formaEl   = document.getElementById('formaGiuridica');
            const tipoDocEl = document.getElementById('tipoDocumento');
            const notaForma = document.getElementById('notaFormaGiuridica');
            const notaTipo  = document.getElementById('notaTipoDocumento');

            const forma = formaEl ? formaEl.value : '';

            // Forme con obbligo di deposito bilancio
            const isBilancioObblig    = ['srl', 'spa', 'coop', 'saca'].includes(forma);
            // Forme con obbligo di dichiarazione dei redditi
            const isDichRedditiObblig = ['snc', 'sas', 'ditta'].includes(forma);

            // ── 1) Auto-set e lock/unlock del dropdown tipoDocumento ──────────
            if (tipoDocEl) {
                if (isBilancioObblig) {
                    tipoDocEl.value    = 'bilancio';
                    tipoDocEl.disabled = true;
                } else if (isDichRedditiObblig) {
                    tipoDocEl.value    = 'dichredditi';
                    tipoDocEl.disabled = true;
                } else {
                    // forma giuridica non ancora selezionata → lascia libero
                    tipoDocEl.disabled = false;
                }
            }

            // ── 2) Note informative sotto i dropdown ─────────────────────────
            if (notaForma) {
                if (isBilancioObblig) {
                    notaForma.innerHTML = '<i class="fas fa-check-circle text-success"></i> Forma giuridica con obbligo di deposito del bilancio.';
                } else if (isDichRedditiObblig) {
                    notaForma.innerHTML = '<i class="fas fa-info-circle text-warning"></i> Società di persone / Ditta Individuale: i dati MOL vengono estratti dalla Dichiarazione dei Redditi.';
                } else {
                    notaForma.innerHTML = '';
                }
            }
            if (notaTipo) {
                if (forma) {
                    notaTipo.innerHTML = '<i class="fas fa-lock text-muted"></i> Auto-determinato dalla forma giuridica.';
                } else {
                    notaTipo.innerHTML = '';
                }
            }

            // ── 3) Leggi il valore effettivo di tipoDocumento ───────────────
            const tipoDocVal  = tipoDocEl ? tipoDocEl.value : '';
            const isDichRedditi = (tipoDocVal === 'dichredditi');

            // ── 4) Sezione procedura (guida mappatura quadri fiscali) ────────
            const sezProcedura = document.getElementById('sezioneProceduraDichRedditi');
            if (sezProcedura) {
                sezProcedura.style.display = isDichRedditi ? 'block' : 'none';
                if (isDichRedditi) aggiorna_GuidaMappatura();
            }

            // ── 5) Campi costi: dettaglio ↔ singolo ─────────────────────────
            const wrapBilancio     = document.getElementById('dettaglioCostiBilancio');
            const wrapDichRedditi  = document.getElementById('costiTotaleDichRedditi');
            if (wrapBilancio)    wrapBilancio.style.display    = isDichRedditi ? 'none'  : 'block';
            if (wrapDichRedditi) wrapDichRedditi.style.display = isDichRedditi ? 'block' : 'none';

            // ── 6) Ricalcola MOL con la sorgente corretta ────────────────────
            calcolaMOL();
        }

        /**
         * Scambia i pannelli di guida dei quadri fiscali in base al
         * regime contabile selezionato (ordinaria / semplificata).
         * Chiamata da onchange di #regimeContabile.
         */
        function aggiorna_GuidaMappatura() {
            const regime = document.getElementById('regimeContabile')
                         ? document.getElementById('regimeContabile').value : '';

            const pNessun        = document.getElementById('guidaMappatura_nessun');
            const pOrdinaria     = document.getElementById('guidaMappatura_ordinaria');
            const pSemplificata  = document.getElementById('guidaMappatura_semplificata');

            if (pNessun)       pNessun.style.display       = regime ? 'none'  : 'block';
            if (pOrdinaria)    pOrdinaria.style.display    = (regime === 'ordinaria')    ? 'block' : 'none';
            if (pSemplificata) pSemplificata.style.display = (regime === 'semplificata') ? 'block' : 'none';
        }

        /** Mappa codice forma giuridica → etichetta leggibile (usata nel PDF export) */
        function getFormaGiuridicaLabel(codice) {
            const mappa = {
                srl:  'Società a Responsabilità Limitata (S.r.l.)',
                spa:  'Società per Azioni (S.p.A.)',
                snc:  'Società in Nome Colletivo (S.n.c.)',
                sas:  'Società in Accomandita Semplice (S.a.s.)',
                ditta:'Ditta Individuale',
                coop: 'Società Cooperativa',
                saca: 'Società in Accomandita per Azioni (S.a.C.A.)'
            };
            return mappa[codice] || codice || '-';
        }

        /** Mappa codice tipoDocumento → etichetta leggibile */
        function getTipoDocumentoLabel(codice) {
            const mappa = {
                bilancio:    'Ultimo Bilancio Approvato',
                dichredditi: 'Ultima Dichiarazione dei Redditi'
            };
            return mappa[codice] || codice || '-';
        }

        /** Mappa codice regimeContabile → etichetta leggibile */
        function getRegimeContabileLabel(codice) {
            if (!codice) return '-';
            const mappa = {
                ordinaria:    'Contabilità Ordinaria',
                semplificata: 'Contabilità Semplificata'
            };
            return mappa[codice] || codice;
        }
        
        function calcolaTotaliDimensione() {
            const ula_dich = getNumericValue('ula_dichiarante');
            const ula_ass = getNumericValue('ula_associate');
            const ula_coll = getNumericValue('ula_collegate');
            
            const fatt_dich = getNumericValue('fatturato_dichiarante');
            const fatt_ass = getNumericValue('fatturato_associate');
            const fatt_coll = getNumericValue('fatturato_collegate');
            
            const bil_dich = getNumericValue('bilancio_dichiarante');
            const bil_ass = getNumericValue('bilancio_associate');
            const bil_coll = getNumericValue('bilancio_collegate');
            
            setTextValue('totale_ula', (ula_dich + ula_ass + ula_coll).toFixed(2));
            setTextValue('totale_fatturato', (fatt_dich + fatt_ass + fatt_coll).toFixed(2));
            setTextValue('totale_bilancio', (bil_dich + bil_ass + bil_coll).toFixed(2));
            
            // Aggiorna anche anno di riferimento
            const anno = getValue('annoRiferimento');
            if (anno) {
                setTextValue('annoRefDimensione', '31/12/' + anno);
            }
        }
        
        function calcolaRiduzioniEnergetiche() {
            const epgl_ante = getNumericValue('epgl_ante');
            const epgl_post = getNumericValue('epgl_post');
            const co2_ante = getNumericValue('co2_ante');
            const co2_post = getNumericValue('co2_post');
            const fer_ante = getNumericValue('fer_ante');
            const fer_post = getNumericValue('fer_post');
            
            // Risparmio energetico
            let risparmioEnergetico = 0;
            if (epgl_ante > 0) {
                risparmioEnergetico = ((epgl_ante - epgl_post) / epgl_ante) * 100;
            }
            
            // Riduzione CO2
            let riduzioneCO2 = 0;
            if (co2_ante > 0) {
                riduzioneCO2 = ((co2_ante - co2_post) / co2_ante) * 100;
            }
            
            // Incremento FER
            let incrementoFER = 0;
            if (fer_ante > 0) {
                incrementoFER = ((fer_post - fer_ante) / fer_ante) * 100;
            } else if (fer_post > 0) {
                incrementoFER = 100;
            }
            
            setTextValue('risparmioEnergetico', risparmioEnergetico.toFixed(2) + '%');
            setTextValue('riduzioneCO2', riduzioneCO2.toFixed(2) + '%');
            setTextValue('incrementoFER', incrementoFER.toFixed(2) + '%');
            
            // Validazione
            validaProgetto(risparmioEnergetico, riduzioneCO2);
            
            // Aggiorna punteggi se in fase 5
            if (currentStep >= 5) {
                calcolaPunteggi();
            }
        }
        
        function validaProgetto(risparmio, riduzioneCO2) {
            // Validazione riduzione CO2
            const iconCO2 = document.getElementById('icon_riduzioneCO2');
            const badgeCO2 = document.getElementById('badge_riduzioneCO2');
            
            if (riduzioneCO2 >= 30) {
                iconCO2.style.color = '#28a745';
                badgeCO2.className = 'ms-auto badge bg-success';
                badgeCO2.textContent = '✓ Conforme';
            } else {
                iconCO2.style.color = '#dc3545';
                badgeCO2.className = 'ms-auto badge bg-danger';
                badgeCO2.textContent = '✗ Non conforme (<30%)';
            }
            
            // Validazione risparmio energetico
            const iconResp = document.getElementById('icon_risparmioEnergetico');
            const badgeResp = document.getElementById('badge_risparmioEnergetico');
            
            if (risparmio > 0) {
                iconResp.style.color = '#28a745';
                badgeResp.className = 'ms-auto badge bg-success';
                badgeResp.textContent = '✓ Verificato';
            } else {
                iconResp.style.color = '#dc3545';
                badgeResp.className = 'ms-auto badge bg-danger';
                badgeResp.textContent = '✗ Non verificato';
            }
        }
        
        
        function calcolaPunteggi() {
            const epgl_ante = getNumericValue('epgl_ante');
            const epgl_post = getNumericValue('epgl_post');
            const co2_ante = getNumericValue('co2_ante');
            const co2_post = getNumericValue('co2_post');
            const fer_ante = getNumericValue('fer_ante');
            const fer_post = getNumericValue('fer_post');
            
            // Calcolo riduzioni
            const risparmioEPgl = epgl_ante > 0 ? ((epgl_ante - epgl_post) / epgl_ante) * 100 : 0;
            const riduzioneCO2 = co2_ante > 0 ? ((co2_ante - co2_post) / co2_ante) * 100 : 0;
            const incrementoFER = fer_ante > 0 ? ((fer_post - fer_ante) / fer_ante) * 100 : (fer_post > 0 ? 100 : 0);
            
            // P1 - Risparmio EPgl
            let p1 = 0;
            if (risparmioEPgl >= 40) p1 = 15;
            else if (risparmioEPgl >= 35) p1 = 10;
            else if (risparmioEPgl >= 30) p1 = 5;
            
            setTextValue('p1_riduzione_val', risparmioEPgl.toFixed(2) + '%');
            setTextValue('p1_punteggio', p1 + ' pt');
            
            // P3 - Riduzione CO2
            let p3 = 0;
            if (riduzioneCO2 >= 40) p3 = 20;
            else if (riduzioneCO2 >= 30) p3 = 10;
            
            setTextValue('p3_riduzione_val', riduzioneCO2.toFixed(2) + '%');
            setTextValue('p3_punteggio', p3 + ' pt');
            
            // P4 - Incremento FER
            let p4 = 0;
            if (incrementoFER >= 40) p4 = 10;
            
            setTextValue('p4_incremento_val', incrementoFER.toFixed(2) + '%');
            setTextValue('p4_punteggio', p4 + ' pt');
            
            // P2 - CAM
            const p2 = getCheckValue('p2_cam') ? 5 : 0;
            setTextValue('p2_punteggio', p2 + ' pt');
            
            // Totale Criterio 1
            const totCrit1 = p1 + p2 + p3 + p4;
            setTextValue('totale_criterio1', totCrit1 + ' pt / 50 pt');
            
            // P5 - Costo Efficacia
            const costoIntervento = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            const risparmioAssoluto = epgl_ante - epgl_post;
            
            // CORREZIONE CRITICA: Costo in k€ (FAQ n. 32)
            // Formula corretta: (Costo in k€) / (EPgl ante - EPgl post)
            const costoInKEuro = costoIntervento / 1000;
            const indiceCosto = risparmioAssoluto > 0 ? costoInKEuro / risparmioAssoluto : 9999;
            
            // SCAGLIONI AGGIORNATI (Appendice 1 + FAQ n. 32)
            let p5 = 0;
            if (indiceCosto < 3) p5 = 29;           // P5 < 3 → 29 punti
            else if (indiceCosto < 4) p5 = 25;      // 3 ≤ P5 < 4 → 25 punti
            else if (indiceCosto < 5) p5 = 15;      // 4 ≤ P5 < 5 → 15 punti
            else if (indiceCosto < 8) p5 = 10;      // 5 ≤ P5 < 8 → 10 punti
            // P5 ≥ 8 → 0 punti
            
            setTextValue('p5_indice_val', indiceCosto.toFixed(2));
            setTextValue('p5_punteggio', p5 + ' pt');
            
            // Cantierabilità
            const cant = parseInt(getRadioValue('cantierabilita')) || 0;
            
            // Monitoraggio
            const mon1 = getCheckValue('mon_sistema1');
            const mon2 = getCheckValue('mon_sistema2');
            const mon3 = getCheckValue('mon_sistema3');
            const numSistemi = [mon1, mon2, mon3].filter(Boolean).length;
            const pMon = numSistemi === 3 ? 6 : (numSistemi === 2 ? 3 : (numSistemi === 1 ? 1 : 0));
            setTextValue('p_monitoraggio', pMon + ' pt');
            
            // Premialità
            const premEM = getCheckValue('prem_energyManager') ? 3 : 0;
            const premSM = getCheckValue('prem_sistemiMisura') ? 3 : 0;
            const pPrem = premEM + premSM;
            setTextValue('p_premialita', pPrem + ' pt');
            
            // TOTALE
            const totale = totCrit1 + p5 + cant + pMon + pPrem;
            setTextValue('punteggioTotale', totale + ' / 100');
            
            // Badge ammissibilità
            const badgeAmm = document.getElementById('badgeAmmissibilita');
            if (totale >= 50) {
                badgeAmm.style.background = '#28a745';
                badgeAmm.style.color = 'white';
                badgeAmm.textContent = '✓ Ammissibile';
            } else {
                badgeAmm.style.background = '#dc3545';
                badgeAmm.style.color = 'white';
                badgeAmm.textContent = '⚠️ Sotto soglia';
            }
            
            // Aggiorna progress bar
            const progressBar = document.getElementById('progressBarPunteggio');
            if (progressBar) {
                progressBar.style.width = totale + '%';
                progressBar.setAttribute('aria-valuenow', totale);
                
                // Cambia colore in base al punteggio
                if (totale >= 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #27ae60, #229954)';
                } else if (totale >= 30) {
                    progressBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #95a5a6, #7f8c8d)';
                }
            }
        }
        
        // ============================================
        // GESTIONE PREVENTIVI
        // ============================================
        function mostraFormPreventivo() {
            document.getElementById('formPreventivo').style.display = 'block';
        }
        
        function nascondiFormPreventivo() {
            document.getElementById('formPreventivo').style.display = 'none';
            setValue('nuovoPreventivo_categoria', '');
            setValue('nuovoPreventivo_descrizione', '');
            setValue('nuovoPreventivo_fornitore', '');
            setValue('nuovoPreventivo_importo', '');
            setTextValue('helpCategoria', '');
        }
        
        function aggiornaHelpCategoria() {
            const categoria = getValue('nuovoPreventivo_categoria');
            const help = {
                'cat_a': 'Es: Motori alta efficienza, inverter, recupero calore, building automation',
                'cat_b': 'Es: Cappotto termico, infissi, relamping LED, schermature solari',
                'cat_c': 'Deve essere "nuovo e più efficiente", NO mera sostituzione tecnologica',
                'cat_d': 'Es: Fotovoltaico, Solare termico - SOLO se combinato con Cat. A, B o C',
                'cat_software': 'Software per gestione energetica, monitoraggio consumi, BMS (Voce b All. F)',
                'cat_edili': 'Opere edili e impianti generali necessari - Max 20% del totale (Voce c All. F)',
                'cat_tecniche': 'Progettazione, DL, CSP/CSE, Diagnosi Energetica - Max 10% voci a+b+c (Voce d All. F)',
                'cat_ape': 'Attestato Prestazione Energetica ex-ante e ex-post (Voce e All. F)'
            };
            setTextValue('helpCategoria', help[categoria] || '');
        }
        
        function aggiungiPreventivo() {
            console.log('[PREVENTIVO] Inizio inserimento preventivo');
            
            const categoria = getValue('nuovoPreventivo_categoria');
            const descrizione = getValue('nuovoPreventivo_descrizione');
            const fornitore = getValue('nuovoPreventivo_fornitore');
            const data = getValue('nuovoPreventivo_data');
            const importo = getNumericValue('nuovoPreventivo_importo');
            
            console.log('[PREVENTIVO] Valori:', { categoria, descrizione, fornitore, data, importo });
            
            // Validazioni base
            if (!categoria || !descrizione || !fornitore || importo <= 0) {
                alert('⚠️ Compilare tutti i campi obbligatori del preventivo!');
                return;
            }
            
            // Validazione data (se presente e non vuota)
            if (data && data.trim() !== '') {
                console.log('[PREVENTIVO] Validazione data:', data);
                const validazione = validaDataPreventivo(data);
                if (!validazione.valid) {
                    alert('❌ Errore Data Preventivo:\n\n' + validazione.error);
                    const dataField = document.getElementById('nuovoPreventivo_data');
                    if (dataField) dataField.focus();
                    return;
                }
                console.log('[PREVENTIVO] Data valida');
            } else {
                console.log('[PREVENTIVO] Data non fornita, skip validazione');
            }
            
            // Validazione DNSH caldaie fossili
            console.log('[PREVENTIVO] Validazione DNSH...');
            if (!validaCaldaieFossiliPreventivo(descrizione)) {
                console.log('[PREVENTIVO] Validazione DNSH fallita, uscita');
                return;
            }
            console.log('[PREVENTIVO] Validazione DNSH OK');
            
            // Validazione Categoria D
            if (categoria === 'cat_d') {
                const hasEfficientamento = datiDomanda.preventivi && datiDomanda.preventivi.some(p => 
                    p.categoria === 'cat_a' || p.categoria === 'cat_b' || p.categoria === 'cat_c'
                );
                
                if (!hasEfficientamento) {
                    alert('⚠️ ATTENZIONE Categoria D\n\nLa Categoria D (Energie Rinnovabili) è ammissibile SOLO se combinata con interventi di efficientamento energetico.\n\nInserisci prima almeno un preventivo di:\n• Categoria A (Efficientamento Processi Produttivi)\n• Categoria B (Efficientamento Edifici)\n• Categoria C (Sostituzione Macchinari)\n\nRiferimento: Par. 3.1 comma 12 Avviso, FAQ n. 15, 16, 27');
                    return;
                }
            }
            
            // Inizializza array se necessario
            if (!datiDomanda.preventivi) datiDomanda.preventivi = [];
            
            // MODALITÀ: Edit o Add
            if (preventivoInModifica) {
                // EDIT MODE: Aggiorna esistente
                const index = datiDomanda.preventivi.findIndex(p => p.id === preventivoInModifica);
                if (index >= 0) {
                    datiDomanda.preventivi[index] = {
                        id: preventivoInModifica,
                        categoria: categoria,
                        descrizione: descrizione,
                        fornitore: fornitore,
                        data: data || null,
                        importo: importo
                    };
                }
                preventivoInModifica = null;
            } else {
                // ADD MODE: Nuovo preventivo
                datiDomanda.preventivi.push({
                    id: ++preventivoCounter,
                    categoria: categoria,
                    descrizione: descrizione,
                    fornitore: fornitore,
                    data: data || null,
                    importo: importo
                });
            }
            
            // Aggiorna interfaccia
            console.log('[PREVENTIVO] Aggiornamento interfaccia...');
            aggiornaListaPreventivi();
            aggiornaTotaliPreventivi();
            
            // Verifica DNSH
            if (typeof verificaCaldaieFossili === 'function') {
                verificaCaldaieFossili();
            }
            
            console.log('[PREVENTIVO] ✅ Preventivo inserito con successo!');
            
            // Reset form
            setValue('nuovoPreventivo_categoria', '');
            setValue('nuovoPreventivo_descrizione', '');
            setValue('nuovoPreventivo_fornitore', '');
            setValue('nuovoPreventivo_data', '');
            setValue('nuovoPreventivo_importo', '');
            
            // Nascondi form e reset UI
            document.getElementById('formPreventivo').style.display = 'none';
            const formTitle = document.querySelector('#formPreventivo h5');
            if (formTitle) formTitle.textContent = 'Nuovo Preventivo';
            const formBtn = document.querySelector('#formPreventivo .btn-primary');
            if (formBtn) formBtn.innerHTML = '<i class="fas fa-check"></i> Conferma';
            
            // Auto-save attivo in background
        }
        
        function rimuoviPreventivo(id) {
            if (confirm('Rimuovere questo preventivo?')) {
                datiDomanda.preventivi = datiDomanda.preventivi.filter(p => p.id !== id);
                
                // Aggiornamento sicuro del contatore
                if (datiDomanda.preventivi.length > 0) {
                    preventivoCounter = Math.max(...datiDomanda.preventivi.map(p => p.id));
                } else {
                    preventivoCounter = 0;
                }
                
                aggiornaListaPreventivi();
                salvaAutomaticamente();
            }
        }
        
        function aggiornaListaPreventivi() {
            const container = document.getElementById('listaPreventivi');
            
            if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun preventivo inserito</p>';
                aggiornaTotaliPreventivi();
                return;
            }
            
            let html = '';
            datiDomanda.preventivi.forEach(prev => {
                const categoriaNome = {
                    'cat_a': 'CATEGORIA A - Processi Produttivi',
                    'cat_b': 'CATEGORIA B - Edifici',
                    'cat_c': 'CATEGORIA C - Macchinari',
                    'cat_d': 'CATEGORIA D - Rinnovabili',
                    'cat_software': 'SOFTWARE - Voce b',
                    'cat_edili': 'SPESE EDILI - Voce c',
                    'cat_tecniche': 'SPESE TECNICHE - Voce d',
                    'cat_ape': 'APE - Voce e'
                }[prev.categoria] || prev.categoria;
                
                const categoriaColor = {
                    'cat_a': 'primary',
                    'cat_b': 'success',
                    'cat_c': 'warning',
                    'cat_d': 'info',
                    'cat_software': 'secondary',
                    'cat_edili': 'dark',
                    'cat_tecniche': 'danger',
                    'cat_ape': 'success'
                }[prev.categoria] || 'secondary';
                
                html += `
                    <div class="preventivo-item">
                        <div class="preventivo-header">
                            <span class="badge badge-categoria bg-${categoriaColor}">${categoriaNome}</span>
                            <button class="btn btn-primary btn-sm me-1" onclick="modificaPreventivo(${prev.id})" title="Modifica preventivo">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="rimuoviPreventivo(${prev.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="mb-1"><strong>${prev.descrizione}</strong></p>
                        <p class="mb-1"><small>Fornitore: ${prev.fornitore}</small></p>
                        <p class="mb-0 text-primary"><strong>${formatEuro(prev.importo)}</strong></p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            aggiornaTotaliPreventivi();
        }
        
        
        // ============================================
        // MODIFICA PREVENTIVI
        // ============================================
        
        function modificaPreventivo(id) {
            const preventivo = datiDomanda.preventivi.find(p => p.id === id);
            if (!preventivo) {
                console.error('Preventivo non trovato:', id);
                return;
            }
            
            // Imposta modalità modifica
            preventivoInModifica = id;
            
            // Mostra form
            document.getElementById('formPreventivo').style.display = 'block';
            
            // Carica dati nel form
            setValue('nuovoPreventivo_categoria', preventivo.categoria);
            setValue('nuovoPreventivo_descrizione', preventivo.descrizione);
            setValue('nuovoPreventivo_fornitore', preventivo.fornitore);
            if (preventivo.data) {
                setValue('nuovoPreventivo_data', preventivo.data);
            }
            setValue('nuovoPreventivo_importo', preventivo.importo);
            
            // Cambia UI del form
            const formTitle = document.querySelector('#formPreventivo h5');
            if (formTitle) formTitle.textContent = 'Modifica Preventivo';
            
            const formBtn = document.querySelector('#formPreventivo .btn-primary');
            if (formBtn) formBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
            
            // Scroll to form
            document.getElementById('formPreventivo').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ============================================
        // VALIDAZIONE DATE PREVENTIVI
        // ============================================
        
        function validaDataPreventivo(data) {
            if (!data) {
                // Data è opzionale, se non fornita è valido
                return { valid: true };
            }
            
            const dataPreventivo = new Date(data);
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            
            // IMPORTANTE: Non validare la data del DOCUMENTO preventivo rispetto alla pubblicazione avviso
            // Il preventivo è un documento preparatorio e può essere emesso in qualsiasi momento
            // Il vincolo temporale (Par. 3.3 Avviso) si applica all'AVVIO LAVORI (accettazione preventivo/ordine),
            // che deve avvenire DOPO la presentazione della domanda
            
            // Verifica solo data non futura
            if (dataPreventivo > oggi) {
                return { 
                    valid: false, 
                    error: 'Data preventivo non può essere futura' 
                };
            }
            
            return { valid: true };
        }
        
        // ============================================
        // VERIFICA CALDAIE FOSSILI (DNSH)
        // ============================================
        
        function verificaCaldaieFossili() {
            // Verifica checkbox dichiarazione
            const checkbox = document.getElementById('dichiarazione_caldaie_fossili');
            if (!checkbox) {
                console.warn('Checkbox dichiarazione caldaie non trovato');
                return;
            }
            
            const dichiarazioneOk = checkbox.checked;
            
            // Keywords caldaie fossili da cercare nei preventivi
            const keywordsFossili = [
                'caldaia gas', 'caldaia metano', 'caldaia gpl', 'caldaia gasolio',
                'caldaia olio', 'bruciatore gas', 'bruciatore gasolio', 
                'combustibile fossile', 'gas naturale', 'metano', 'gpl', 
                'gasolio', 'olio combustibile', 'caldaia condensazione gas', 
                'generatore gas'
            ];
            
            // Scansiona tutti i preventivi
            const keywordTrovate = [];
            if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                datiDomanda.preventivi.forEach(prev => {
                    const desc = (prev.descrizione || '').toLowerCase();
                    keywordsFossili.forEach(kw => {
                        if (desc.includes(kw) && !keywordTrovate.includes(kw)) {
                            keywordTrovate.push(kw);
                        }
                    });
                });
            }
            
            // Aggiorna indicatore
            const indicator = document.getElementById('dnsh_caldaie_indicator');
            if (!indicator) {
                console.warn('Indicatore DNSH non trovato');
                return;
            }
            
            if (!dichiarazioneOk) {
                // ROSSO - Non conforme
                indicator.className = 'alert alert-danger mt-3';
                indicator.innerHTML = '<strong>❌ NON CONFORME</strong><br>Dichiarazione NON confermata in Fase 1. Tornare alla Fase 1 e confermare l\'assenza di caldaie fossili.';
            } else if (keywordTrovate.length > 0) {
                // GIALLO - Warning
                indicator.className = 'alert alert-warning mt-3';
                indicator.innerHTML = '<strong>⚠️ WARNING</strong><br>Dichiarazione confermata MA rilevate keyword sospette nei preventivi: <strong>' + 
                    keywordTrovate.join(', ') + 
                    '</strong>.<br><small>Verificare la coerenza. ATTENZIONE: Se il preventivo riguarda la SOSTITUZIONE di una vecchia caldaia fossile con pompa di calore, l\'intervento è ammissibile.</small>';
            } else {
                // VERDE - Conforme
                indicator.className = 'alert alert-success mt-3';
                indicator.innerHTML = '<strong>✅ CONFORME</strong><br>Dichiarazione confermata. Nessuna keyword relativa a caldaie fossili rilevata nei preventivi.';
            }
        }
        
        // ============================================
        // VALIDAZIONE PRE-INSERT CALDAIE FOSSILI
        // ============================================
        
        function validaCaldaieFossiliPreventivo(descrizione) {
            console.log('[DNSH] Validazione preventivo:', descrizione);
            
            // Verifica che la dichiarazione sia stata confermata
            const checkbox = document.getElementById('dichiarazione_caldaie_fossili');
            
            // Se checkbox non esiste o non è spuntato, dai solo un warning
            if (!checkbox || !checkbox.checked) {
                console.warn('[DNSH] Checkbox non spuntato');
                const conferma = confirm(
                    '⚠️ ATTENZIONE: Dichiarazione DNSH\n\n' +
                    'Non hai ancora confermato la dichiarazione sull\'assenza di caldaie fossili nella Fase 1.\n\n' +
                    'È OBBLIGATORIO confermare prima dell\'invio finale della domanda.\n\n' +
                    'Vuoi procedere comunque con l\'inserimento del preventivo?'
                );
                
                if (!conferma) {
                    return false;
                }
                
                // Procedi senza ulteriori controlli se non ha spuntato
                return true;
            }
            
            // Keywords caldaie fossili
            const keywordsFossili = [
                'caldaia gas', 'caldaia metano', 'caldaia gpl', 'caldaia gasolio',
                'caldaia olio', 'bruciatore gas', 'bruciatore gasolio', 
                'combustibile fossile', 'gas naturale', 'metano', 'gpl', 
                'gasolio', 'olio combustibile', 'caldaia condensazione gas', 
                'generatore gas'
            ];
            
            // Keywords motori endotermici (FAQ n. 2, 5)
            const keywordsMotori = [
                'motore diesel', 'motore benzina', 'motore gasolio', 'motore gas',
                'motore endotermico', 'motore combustione', 'gruppo elettrogeno diesel',
                'gruppo elettrogeno benzina', 'generatore diesel', 'propulsione diesel',
                'propulsione benzina', 'motore termico', 'cogeneratore gas'
            ];
            
            // Scansiona descrizione
            const desc = (descrizione || '').toLowerCase();
            const keywordCaldaieTrovate = keywordsFossili.filter(kw => desc.includes(kw));
            const keywordMotoriTrovate = keywordsMotori.filter(kw => desc.includes(kw));
            
            // CONTROLLO MOTORI ENDOTERMICI (DIVIETO ASSOLUTO - FAQ n. 2, 5)
            if (keywordMotoriTrovate.length > 0) {
                alert(
                    '❌ VIOLAZIONE PRINCIPIO DNSH - MOTORI ENDOTERMICI\n\n' +
                    '⚠️ DIVIETO ASSOLUTO (FAQ n. 2 e 5):\n\n' +
                    'Gli interventi che prevedono l\'introduzione o la sostituzione di motori endotermici ' +
                    'alimentati a combustibili fossili NON sono ammissibili.\n\n' +
                    'Keyword rilevate:\n• ' + keywordMotoriTrovate.join('\n• ') + '\n\n' +
                    '✅ AMMISSIBILI:\n' +
                    '• Motori elettrici\n' +
                    '• Pompe di calore elettriche\n' +
                    '• Sistemi ad alta efficienza non fossili\n\n' +
                    '⚠️ ATTENZIONE: Motori ibridi (con componente endotermica) NON sono esplicitamente ' +
                    'ammessi dalle FAQ. Richiedere chiarimento formale se necessario.\n\n' +
                    '❌ NON AMMISSIBILI:\n' +
                    '• Motori diesel, benzina, GPL, gas naturale\n' +
                    '• Gruppi elettrogeni a combustibili fossili\n' +
                    '• Cogeneratori alimentati a gas\n\n' +
                    'Modifica la descrizione del preventivo per risultare conforme.'
                );
                return false;
            }
            
            // CONTROLLO CALDAIE FOSSILI
            if (keywordCaldaieTrovate.length > 0) {
                const conferma = confirm(
                    '⚠️ POSSIBILE INCOERENZA CON PRINCIPIO DNSH\n\n' +
                    'Hai dichiarato l\'assenza di caldaie fossili, ma la descrizione del preventivo contiene le seguenti keyword:\n\n' +
                    '• ' + keywordCaldaieTrovate.join('\n• ') + '\n\n' +
                    'VERIFICA ATTENTAMENTE:\n\n' +
                    '✅ AMMISSIBILE: Sostituzione di una vecchia caldaia fossile CON pompa di calore o altro sistema ad alta efficienza\n\n' +
                    '❌ NON AMMISSIBILE: Installazione o mantenimento di caldaie alimentate a combustibili fossili\n\n' +
                    'Confermi di voler procedere con l\'inserimento?'
                );
                
                return conferma;
            }
            
            return true;
        }
        
        // ============================================
        // IMPATTO EFFICIENZA SU PIANO H.3
        // ============================================
        
        function calcolaImpattoPiano() {
            // Calcola impatto percentuale efficienza energetica su consumi
            const risparmioEnergetico = getNumericValue('risparmioEnergeticoPerc') || 0;
            
            if (risparmioEnergetico <= 0) {
                console.log('Nessun risparmio energetico, impatto = 0');
                return 0;
            }
            
            // Impatto su costi energetici (riduzione percentuale)
            // Assume che i costi energetici siano circa 8-12% dei costi operativi totali
            const impattoPercentuale = risparmioEnergetico * 0.10; // 10% dei costi è energia
            
            console.log('Impatto efficienza su piano:', impattoPercentuale + '%');
            return impattoPercentuale;
        }
        

        function aggiornaTotaliPreventivi() {
            // Aggiorna anche il budget se siamo in Fase 5
            if (currentStep === 5) {
                popolaBudgetDaPreventivi();
            }
            
            let totali = { 
                cat_a: 0, 
                cat_b: 0, 
                cat_c: 0, 
                cat_d: 0,
                cat_software: 0,
                cat_edili: 0,
                cat_tecniche: 0,
                cat_ape: 0
            };
            
            if (datiDomanda.preventivi) {
                datiDomanda.preventivi.forEach(prev => {
                    totali[prev.categoria] = (totali[prev.categoria] || 0) + prev.importo;
                });
            }
            
            // Aggiorna visualizzazione totali
            setTextValue('totale_cat_a', formatEuro(totali.cat_a));
            setTextValue('totale_cat_b', formatEuro(totali.cat_b));
            setTextValue('totale_cat_c', formatEuro(totali.cat_c));
            setTextValue('totale_cat_d', formatEuro(totali.cat_d));
            setTextValue('totale_cat_software', formatEuro(totali.cat_software));
            setTextValue('totale_cat_edili', formatEuro(totali.cat_edili));
            setTextValue('totale_cat_tecniche', formatEuro(totali.cat_tecniche));
            setTextValue('totale_cat_ape', formatEuro(totali.cat_ape));
            
            // CALCOLO TOTALE GENERALE
            const totale = totali.cat_a + totali.cat_b + totali.cat_c + totali.cat_d + 
                          totali.cat_software + totali.cat_edili + totali.cat_tecniche + totali.cat_ape;
            
            setTextValue('totaleInvestimenti', formatEuro(totale));
            
            // Aggiorna anche il costo totale in Fase 2
            setValue('costoTotaleInvestimento', totale.toFixed(2));
            
            // VALIDAZIONE MASSIMALI
            validaMassimaliSpeseAccessorie(totali, totale);
            
            // IMPORTANTE: Salva anche in datiDomanda per evitare loop
            if (!datiDomanda.mol) datiDomanda.mol = {};
            datiDomanda.mol.costoTotaleInvestimento = totale;
            
            calcolaIndicatoreOrdinatore();
        }
        
        /**
         * VALIDAZIONE MASSIMALI SPESE ACCESSORIE
         * Secondo Avviso Par. 4.4.1 e Allegato F Tab. 3:
         * - Spese Edili (c): Max 20% del totale generale progetto
         * - Spese Tecniche (d): Max 10% di (a+b+c), cioè Cat A/B/C/D + Software + Edili
         * - APE (e): Senza massimale percentuale (solo congruità)
         */
        function validaMassimaliSpeseAccessorie(totali, totaleGenerale) {
            let messaggi = [];
            
            // VALIDAZIONE SPESE EDILI - Max 20% totale generale
            const maxEdili = totaleGenerale * 0.20;
            if (totali.cat_edili > maxEdili) {
                messaggi.push(
                    `⚠️ SUPERAMENTO MASSIMALE SPESE EDILI\n\n` +
                    `Importo Spese Edili: ${formatEuro(totali.cat_edili)}\n` +
                    `Massimo ammesso (20% progetto): ${formatEuro(maxEdili)}\n\n` +
                    `Ridurre le spese edili di: ${formatEuro(totali.cat_edili - maxEdili)}\n\n` +
                    `Riferimento: Avviso Par. 4.4.1 lett. i`
                );
            }
            
            // VALIDAZIONE SPESE TECNICHE - Max 10% di (a+b+c)
            // Base calcolo: Cat A+B+C+D + Software + Edili (escluse Tecniche e APE)
            const baseCalcoloTecniche = totali.cat_a + totali.cat_b + totali.cat_c + totali.cat_d + 
                                       totali.cat_software + totali.cat_edili;
            const maxTecniche = baseCalcoloTecniche * 0.10;
            
            if (totali.cat_tecniche > maxTecniche) {
                messaggi.push(
                    `⚠️ SUPERAMENTO MASSIMALE SPESE TECNICHE\n\n` +
                    `Importo Spese Tecniche: ${formatEuro(totali.cat_tecniche)}\n` +
                    `Massimo ammesso (10% voci a+b+c): ${formatEuro(maxTecniche)}\n` +
                    `Base calcolo: ${formatEuro(baseCalcoloTecniche)}\n\n` +
                    `Ridurre le spese tecniche di: ${formatEuro(totali.cat_tecniche - maxTecniche)}\n\n` +
                    `Riferimento: Avviso Par. 4.4.1 lett. i - Allegato F Voce d)`
                );
            }
            
            // Mostra alert se ci sono violazioni
            if (messaggi.length > 0) {
                console.warn('Violazione massimali spese accessorie');
                // Non bloccare, ma avvisa l'utente
                // L'utente può comunque procedere, verrà segnalato in fase di validazione finale
            }
            
            return messaggi.length === 0;
        }
        
        // Manteniamo la vecchia firma per retro-compatibilità (ora deprecata)
        function validaSpeseAccessorie() {
            console.log('[DEPRECATO] validaSpeseAccessorie() - Ora gestito da validaMassimaliSpeseAccessorie()');
        }
        
        // ============================================
        // GESTIONE SOCI E AIUTI DE MINIMIS
        // ============================================
        function aggiungiSocio() {
            const id = Date.now();
            if (!datiDomanda.soci) datiDomanda.soci = [];
            
            datiDomanda.soci.push({
                id: id,
                nome: '',
                sede: '',
                cf: '',
                quotaPartecipazione: 0,
                quotaVoto: 0
            });
            
            aggiornaListaSoci();
        }
        
        function rimuoviSocio(id) {
            datiDomanda.soci = datiDomanda.soci.filter(s => s.id !== id);
            aggiornaListaSoci();
        }
        
        function aggiornaListaSoci() {
            const container = document.getElementById('listaSoci');
            
            if (!datiDomanda.soci || datiDomanda.soci.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun socio inserito</p>';
                return;
            }
            
            let html = '<table class="table table-sm table-bordered">';
            html += '<thead><tr><th>Nome/Denominazione</th><th>Sede</th><th>CF/P.IVA</th><th>%Part.</th><th>%Voto</th><th></th></tr></thead><tbody>';
            
            datiDomanda.soci.forEach((socio, index) => {
                html += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.nome}" onchange="datiDomanda.soci[${index}].nome=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.sede}" onchange="datiDomanda.soci[${index}].sede=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.cf}" onchange="datiDomanda.soci[${index}].cf=this.value"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${socio.quotaPartecipazione}" onchange="datiDomanda.soci[${index}].quotaPartecipazione=parseFloat(this.value)"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${socio.quotaVoto}" onchange="datiDomanda.soci[${index}].quotaVoto=parseFloat(this.value)"></td>
                        <td><button class="btn btn-sm btn-danger" onclick="rimuoviSocio(${socio.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function aggiungiAiuto() {
            const id = Date.now();
            if (!datiDomanda.aiutiDeMinimis) datiDomanda.aiutiDeMinimis = [];
            
            datiDomanda.aiutiDeMinimis.push({
                id: id,
                ente: '',
                normativa: '',
                data: '',
                importo: 0
            });
            
            aggiornaListaAiuti();
        }
        
        function rimuoviAiuto(id) {
            datiDomanda.aiutiDeMinimis = datiDomanda.aiutiDeMinimis.filter(a => a.id !== id);
            aggiornaListaAiuti();
        }
        
        function aggiornaListaAiuti() {
            const container = document.getElementById('listaAiuti');
            
            if (!datiDomanda.aiutiDeMinimis || datiDomanda.aiutiDeMinimis.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun aiuto de minimis dichiarato</p>';
                aggiornaTotaleDeMinimis();
                return;
            }
            
            let html = '<table class="table table-sm table-bordered">';
            html += '<thead><tr><th>Ente Erogante</th><th>Normativa</th><th>Data</th><th>Importo €</th><th></th></tr></thead><tbody>';
            
            datiDomanda.aiutiDeMinimis.forEach((aiuto, index) => {
                html += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" value="${aiuto.ente}" onchange="datiDomanda.aiutiDeMinimis[${index}].ente=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${aiuto.normativa}" onchange="datiDomanda.aiutiDeMinimis[${index}].normativa=this.value"></td>
                        <td><input type="date" class="form-control form-control-sm" value="${aiuto.data}" onchange="datiDomanda.aiutiDeMinimis[${index}].data=this.value"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${aiuto.importo}" onchange="datiDomanda.aiutiDeMinimis[${index}].importo=parseFloat(this.value);aggiornaTotaleDeMinimis()"></td>
                        <td><button class="btn btn-sm btn-danger" onclick="rimuoviAiuto(${aiuto.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            aggiornaTotaleDeMinimis();
        }
        
        function aggiornaTotaleDeMinimis() {
            const totale = datiDomanda.aiutiDeMinimis ? datiDomanda.aiutiDeMinimis.reduce((sum, a) => sum + (a.importo || 0), 0) : 0;
            const contributo = getNumericValue('contributoRichiesto');
            const cumulato = totale + contributo;
            
            setTextValue('totaleDeMinimis', formatEuro(totale));
            setTextValue('contributoRichiestoRiepilogo', formatEuro(contributo));
            setTextValue('totaleCumulato', formatEuro(cumulato));
            
            const alertDiv = document.getElementById('alertDeMinimis');
            // Mostra solo se:
            // 1. Supera 300k€
            // 2. È un valore valido
            // 3. Il regime è DE MINIMIS (NON esenzione!)
            if (alertDiv) {
                const isValid = !isNaN(cumulato) && isFinite(cumulato) && cumulato > 0;
                const regimeAiuto = datiDomanda.mol?.regimeAiuto || 'deminimis';
                
                // Warning 300k€ si applica SOLO al regime de minimis
                // Il regime Esenzione (Art. 14) NON ha limite cumulativo
                if (isValid && cumulato > 300000 && regimeAiuto === 'deminimis') {
                    alertDiv.style.display = 'block';
                } else {
                    alertDiv.style.display = 'none';
                }
            }
        }
        
        // ============================================
        // RIEPILOGO FASI
        // ============================================
        function aggiornaRiepilogoFase4() {
            setTextValue('recap_ragioneSociale', datiDomanda.anagrafica?.ragioneSociale || '-');
            setTextValue('recap_partitaIva', datiDomanda.anagrafica?.partitaIva || '-');
            
            const dim = datiDomanda.anagrafica?.dimensioneImpresa || '';
            const dimNome = {
                'micro': 'Microimpresa',
                'piccola': 'Piccola Impresa',
                'media': 'Media Impresa'
            }[dim] || '-';
            setTextValue('recap_dimensione', dimNome);
            
            const totInv = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            setTextValue('recap_investimento', formatEuro(totInv));
            
            const contributo = getNumericValue('contributoRichiesto');
            setTextValue('recap_contributo', formatEuro(contributo));
            
            const regime = datiDomanda.mol?.regimeAiuto || '';
            const regimeNome = {
                'deminimis': 'De Minimis (Max 60%)',
                'esenzione': 'Esenzione (Art. 14)'
            }[regime] || '-';
            setTextValue('recap_regime', regimeNome);
            
            const valore = datiDomanda.mol?.valoreProduzione || 0;
            const costi  = datiDomanda.mol?.costiProduzione || 0;   // già calcolato condizionalmente al salvataggio
            const mol    = valore - costi;
            setTextValue('recap_mol', formatEuro(mol));
            
            const ordinatore = totInv > 0 ? (mol / totInv).toFixed(5).replace('.', ',') : '0,00000';
            setTextValue('recap_ordinatore', ordinatore);
        }
        
        function aggiornaRiepilogoFinale() {
            // Dati impresa
            setTextValue('final_ragioneSociale', datiDomanda.anagrafica?.ragioneSociale || '-');
            setTextValue('final_partitaIva', datiDomanda.anagrafica?.partitaIva || '-');
            
            const dim = datiDomanda.anagrafica?.dimensioneImpresa || '';
            const dimNome = {
                'micro': 'Microimpresa',
                'piccola': 'Piccola',
                'media': 'Media'
            }[dim] || '-';
            setTextValue('final_dimensione', dimNome);
            
            setTextValue('final_ateco', datiDomanda.anagrafica?.codiceAteco || '-');
            setTextValue('final_sedIntervento', datiDomanda.unitaProduttiva?.indirizzo || '-');
            
            // Dati economici
            const valore = datiDomanda.mol?.valoreProduzione || 0;
            const costi  = datiDomanda.mol?.costiProduzione || 0;   // condizionale: dettaglio o singolo
            const mol    = valore - costi;
            setTextValue('final_mol', formatEuro(mol));
            
            const totInv = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            setTextValue('final_investimento', formatEuro(totInv));
            
            const contributo = datiDomanda.mol?.contributoRichiesto || 0;
            setTextValue('final_contributo', formatEuro(contributo));
            
            const regime = datiDomanda.mol?.regimeAiuto || '';
            const regimeNome = {
                'deminimis': 'De Minimis',
                'esenzione': 'Esenzione'
            }[regime] || '-';
            setTextValue('final_regime', regimeNome);
            
            const ordinatore = totInv > 0 ? (mol / totInv).toFixed(5).replace('.', ',') : '0,00000';
            setTextValue('final_ordinatore', ordinatore);
            
            // Performance
            const epgl_ante = datiDomanda.diagnosi?.epgl_ante || 0;
            const epgl_post = datiDomanda.diagnosi?.epgl_post || 0;
            const risparmio = epgl_ante > 0 ? ((epgl_ante - epgl_post) / epgl_ante) * 100 : 0;
            setTextValue('final_risparmio', risparmio.toFixed(2) + '%');
            
            const co2_ante = datiDomanda.diagnosi?.co2_ante || 0;
            const co2_post = datiDomanda.diagnosi?.co2_post || 0;
            const ridCO2 = co2_ante > 0 ? ((co2_ante - co2_post) / co2_ante) * 100 : 0;
            setTextValue('final_co2', ridCO2.toFixed(2) + '%');
            
            const fer_ante = datiDomanda.diagnosi?.fer_ante || 0;
            const fer_post = datiDomanda.diagnosi?.fer_post || 0;
            const incFER = fer_ante > 0 ? ((fer_post - fer_ante) / fer_ante) * 100 : (fer_post > 0 ? 100 : 0);
            setTextValue('final_fer', incFER.toFixed(2) + '%');
            
            // Punteggio
            calcolaPunteggi();
            const punteggioText = document.getElementById('punteggioTotale').textContent;
            setTextValue('final_punteggio', punteggioText);
            
            const punteggio = parseInt(punteggioText) || 0;
            const ammText = punteggio >= 50 ? 
                '<span class="badge bg-success">✓ AMMISSIBILE</span>' :
                '<span class="badge bg-danger">✗ NON AMMISSIBILE</span>';
            document.getElementById('final_ammissibilita').innerHTML = ammText;
        }
        
        
        // ============================================
        // EXPORT EXCEL COMPLETO - Professionale
        // ============================================
function esportaExcel() {
            console.log('[EXPORT EXCEL] Inizio generazione...');

            try {
                if (typeof XLSX === 'undefined') {
                    alert('❌ Libreria SheetJS non caricata!\n\nRicarica la pagina.');
                    return;
                }

                const wb = XLSX.utils.book_new();

                // ----------------------------------------
                // SHEET 1: RIEPILOGO GENERALE
                // ----------------------------------------
                const riepilogoData = [
                    ['SICILIA EFFICIENTE - Azione 2.1.2-PR FESR 2021-2027'],
                    ['Riqualificazione energetica nelle imprese'],
                    [],
                    ['DATI ANAGRAFICI'],
                    ['Denominazione', datiDomanda.anagrafica.ragioneSociale || ''],
                    ['Partita IVA', datiDomanda.anagrafica.partitaIva || ''],
                    ['Codice Fiscale', datiDomanda.anagrafica.codiceFiscale || ''],
                    ['Sede Legale', (datiDomanda.anagrafica.sedeLegale || '')],
                    ['PEC', datiDomanda.anagrafica.pec || ''],
                    ['Telefono', datiDomanda.anagrafica.telefono || ''],
                    [],
                    ['DATI ECONOMICI'],
                    ['MOL (Margine Operativo Lordo)', datiDomanda.mol.valoreMOL || 0],
                    ['Dimensione Aziendale', datiDomanda.dimensioneAziendale.categoria || 'Non calcolata'],
                    ['Indicatore Ordinatore', (datiDomanda.mol.indicatoreOrdinatore || 0).toFixed(4)],
                    [],
                    ['INVESTIMENTO PROGRAMMATO'],
                    ['Categoria A - Processi', calcolaTotalePreventiviPerCategoria('cat_a')],
                    ['Categoria B - Edifici', calcolaTotalePreventiviPerCategoria('cat_b')],
                    ['Categoria C - Macchinari', calcolaTotalePreventiviPerCategoria('cat_c')],
                    ['Categoria D - Rinnovabili', calcolaTotalePreventiviPerCategoria('cat_d')],
                    ['Software (Voce b)', calcolaTotalePreventiviPerCategoria('cat_software')],
                    ['Spese Edili (Voce c)', calcolaTotalePreventiviPerCategoria('cat_edili')],
                    ['Spese Tecniche (Voce d)', calcolaTotalePreventiviPerCategoria('cat_tecniche')],
                    ['APE (Voce e)', calcolaTotalePreventiviPerCategoria('cat_ape')],
                    ['TOTALE INVESTIMENTO', calcolaTotalePreventivi()],
                ];

                const ws1 = XLSX.utils.aoa_to_sheet(riepilogoData);
                ws1['!cols'] = [{ wch: 40 }, { wch: 35 }];
                XLSX.utils.book_append_sheet(wb, ws1, 'Riepilogo');

                // ----------------------------------------
                // SHEET 2: PREVENTIVI
                // ----------------------------------------
                const preventiviData = [
                    ['PREVENTIVI DETTAGLIATI'],
                    [],
                    ['ID', 'Categoria', 'Descrizione Intervento', 'Fornitore', 'Data', 'Importo €']
                ];

                if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                    datiDomanda.preventivi.forEach((prev, idx) => {
                        preventiviData.push([
                            idx + 1,
                            prev.categoria,
                            prev.descrizione,
                            prev.fornitore,
                            prev.data || '',
                            parseFloat(prev.importo) || 0
                        ]);
                    });
                    preventiviData.push([]);
                    preventiviData.push(['', '', '', '', 'TOTALE', calcolaTotalePreventivi()]);
                }

                const ws2 = XLSX.utils.aoa_to_sheet(preventiviData);
                ws2['!cols'] = [{ wch: 5 }, { wch: 15 }, { wch: 50 }, { wch: 30 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Preventivi');

                // ----------------------------------------
                // SHEET 3: PIANO DI LAVORO E CRONOPROGRAMMA (NUOVO!)
                // ----------------------------------------
                const wpData = [
                    ['PIANO DI LAVORO (Work Packages)'],
                    ['OG', 'OS', 'WP', 'Task', 'Deliverable', 'Output', 'Budget (€)', 'KPI']
                ];

                if (datiDomanda.workPackages && datiDomanda.workPackages.length > 0) {
                    datiDomanda.workPackages.forEach(wp => {
                        wpData.push([
                            wp.og, wp.os, wp.wp, wp.task, wp.deliverable, wp.output, wp.budget, wp.kpi
                        ]);
                    });
                } else {
                    wpData.push(['Nessun WP inserito']);
                }

                wpData.push([]);
                wpData.push([]);
                wpData.push(['CRONOPROGRAMMA']);
                wpData.push(['WP', 'Descrizione', 'M1', 'M2', 'M3', 'M4', 'M5', 'M6', 'M7', 'M8', 'M9', 'M10', 'M11', 'M12']);

                if (datiDomanda.cronoprogramma && datiDomanda.cronoprogramma.length > 0) {
                    datiDomanda.cronoprogramma.forEach(c => {
                        const row = [c.wp, c.descrizione];
                        // Aggiunge X se il mese è selezionato
                        if (c.mesi) {
                            c.mesi.forEach(m => row.push(m ? 'X' : ''));
                        } else {
                            // Fallback se array vuoto
                            for(let i=0; i<12; i++) row.push('');
                        }
                        wpData.push(row);
                    });
                }

                const wsWP = XLSX.utils.aoa_to_sheet(wpData);
                wsWP['!cols'] = [{wch:10}, {wch:10}, {wch:10}, {wch:30}, {wch:20}, {wch:20}, {wch:15}, {wch:15}];
                XLSX.utils.book_append_sheet(wb, wsWP, 'Piano Lavoro');

                // ----------------------------------------
                // SHEET 4: H.3 CONTO ECONOMICO
                // ----------------------------------------
                const h3Data = [['PIANO H.3'], ['Voce', '2023', '2024', 'n+1', 'n+2', 'n+3']];
                
                // Helper interno per leggere valori sicuri
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? (parseFloat(el.value) || 0) : 0;
                };

                const voci = ['vp', 'mol', 'ro', 'rl', 'rn']; // Voci principali
                voci.forEach(id => {
                    const row = [id.toUpperCase()];
                    ['2023', '2024', 'n1', 'n2', 'n3'].forEach(anno => {
                        row.push(getVal('h3_' + id + '_' + anno));
                    });
                    h3Data.push(row);
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(h3Data);
                XLSX.utils.book_append_sheet(wb, ws3, 'Piano H.3');

                // GENERAZIONE FILE
                const filename = 'Sicilia_Efficiente_' + (datiDomanda.anagrafica.partitaIva || 'export') + '.xlsx';
                XLSX.writeFile(wb, filename);

            } catch (error) {
                console.error('[EXPORT EXCEL] Errore:', error);
                alert('❌ Errore Excel: ' + error.message);
            }
        }

        // ========================================
        // HELPER FUNCTIONS PER EXPORT
        // ========================================

        function calcolaTotalePreventiviPerCategoria(categoria) {
            if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) return 0;
            return datiDomanda.preventivi
                .filter(p => p.categoria === categoria)
                .reduce((sum, p) => sum + (parseFloat(p.importo) || 0), 0);
        }

        function calcolaTotalePreventivi() {
            if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) return 0;
            return datiDomanda.preventivi
                .reduce((sum, p) => sum + (parseFloat(p.importo) || 0), 0);
        }
     // Funzione per popolare automaticamente il budget dalla somma preventivi
        // FIX LOGICO: Mappatura corretta tra Categorie Preventivi e Righe di Bilancio (Allegato F Tab. 3)
        function popolaBudgetDaPreventivi() {
            // 1. Calcola totali per categoria dai preventivi
            const totPrevA = calcolaTotalePreventiviPerCategoria('cat_a');        // Processi
            const totPrevB = calcolaTotalePreventiviPerCategoria('cat_b');        // Edifici
            const totPrevC = calcolaTotalePreventiviPerCategoria('cat_c');        // Macchinari
            const totPrevD = calcolaTotalePreventiviPerCategoria('cat_d');        // Rinnovabili
            const totSoftware = calcolaTotalePreventiviPerCategoria('cat_software');  // Software
            const totEdili = calcolaTotalePreventiviPerCategoria('cat_edili');        // Spese Edili
            const totTecniche = calcolaTotalePreventiviPerCategoria('cat_tecniche');  // Spese Tecniche
            const totAPE = calcolaTotalePreventiviPerCategoria('cat_ape');            // APE
            
            // 2. Mappatura verso le voci di Budget (Tabella 3 Allegato F)
            
            // Riga A: Impianti e Macchinari (voce a) 
            // Include: Cat A (Processi), Cat C (Macchinari), Cat D (Rinnovabili)
            const budgetA = totPrevA + totPrevC + totPrevD;
            
            // Riga B: Software (voce b)
            const budgetB = totSoftware; 
            
            // Riga C: Spese Edili e Impianti Generali (voce c)
            // Include: Cat B (Edifici) + Spese Edili
            const budgetC = totPrevB + totEdili; 
            
            // Riga D: Spese Tecniche (voce d)
            // Include: Progettazione, DL, CSP/CSE, Diagnosi
            const budgetD = totTecniche;
            
            // Riga E: APE (voce e)
            const budgetE = totAPE;

            // 3. Scrivi i valori nei campi (Totale Ammissibile)
            setValue('budget_a_totale', budgetA.toFixed(2));
            setValue('budget_b_totale', budgetB.toFixed(2));
            setValue('budget_c_totale', budgetC.toFixed(2));
            setValue('budget_d_totale', budgetD.toFixed(2));
            
            // Se esiste il campo budget_e per APE, popolalo
            const budgetEField = document.getElementById('budget_e_totale');
            if (budgetEField) {
                setValue('budget_e_totale', budgetE.toFixed(2));
            }
            
            // 4. Calcola i contributi automaticamente in base alle intensità
            const percContributo = calcolaPercentualeContributo();
            
            // Applica percentuali (verifica se i campi intensità sono vuoti, usa default)
            const setIntensita = (id) => {
                const el = document.getElementById(id);
                if(el && (el.value === '' || el.value == 0)) el.value = percContributo;
            };
            
            setIntensita('budget_a_intensita');
            setIntensita('budget_b_intensita');
            setIntensita('budget_c_intensita');
            setIntensita('budget_d_intensita');
            
            const budgetEIntensitaField = document.getElementById('budget_e_intensita');
            if (budgetEIntensitaField && (budgetEIntensitaField.value === '' || budgetEIntensitaField.value == 0)) {
                budgetEIntensitaField.value = percContributo;
            }
            
            // Ricalcola tutti i totali (contributo, spesa impresa, ecc.)
            calcolaBudgetTotale();
        }
        

        // ============================================
        // EXPORT PDF - PLACEHOLDER AVANZATI
        // ============================================
        // Nota: Implementazione PDF completa richiede jsPDF-AutoTable
        // Per ora placeholder professionali


        // ============================================
        // EXPORT PDF COMPLETO - TUTTI I DOCUMENTI
        // ============================================

        function esportaDomandaPDF() {
            console.log('[PDF] Generazione Allegato 2.1.A - Domanda');
            
            // Verifica libreria jsPDF
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert('❌ Libreria PDF non caricata!\n\nRicarica la pagina o verifica la connessione internet.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let yPos = 20;

                // HEADER
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('SICILIA EFFICIENTE - Azione 2.1.2-PR FESR 2021-2027', 105, yPos, { align: 'center' });
                yPos += 10;

                doc.setFontSize(14);
                doc.text('Allegato 2.1.A - Domanda di Finanziamento', 105, yPos, { align: 'center' });
                yPos += 15;

                // SEZIONE 1: DATI ANAGRAFICI
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('1. DATI ANAGRAFICI IMPRESA', 20, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                const anagrafica = [
                    ['Denominazione', datiDomanda.anagrafica.ragioneSociale || '-'],
                    ['Partita IVA', datiDomanda.anagrafica.partitaIva || '-'],
                    ['Codice Fiscale', datiDomanda.anagrafica.codiceFiscale || '-'],
                    ['Forma Giuridica', getFormaGiuridicaLabel(datiDomanda.anagrafica.formaGiuridica) || '-'],
                    ['Sede Legale', (datiDomanda.anagrafica.sedeLegale || '') + ', ' + 
                                   ('' || '') + ' (' + 
                                   ('' || '') + ')'],
                    ['PEC', datiDomanda.anagrafica.pec || '-'],
                    ['Telefono', datiDomanda.anagrafica.telefono || '-'],
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Campo', 'Valore']],
                    body: anagrafica,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: 9 }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // SEZIONE 2: LEGALE RAPPRESENTANTE
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('2. LEGALE RAPPRESENTANTE', 20, yPos);
                yPos += 8;

                const legale = [
                    ['Nome e Cognome', (datiDomanda.legaleRappresentante.nome || '') + ' ' + 
                                      (datiDomanda.legaleRappresentante.cognome || '')],
                    ['Codice Fiscale', datiDomanda.legaleRappresentante.codiceFiscale || '-'],
                    ['Data di Nascita', datiDomanda.legaleRappresentante.dataNascita || '-'],
                    ['Luogo di Nascita', datiDomanda.legaleRappresentante.luogoNascita || '-'],
                    ['Qualità', datiDomanda.legaleRappresentante.qualita || '-'],
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Campo', 'Valore']],
                    body: legale,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: 9 }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // NUOVA PAGINA se necessario
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                // SEZIONE 3: INVESTIMENTO
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('3. INVESTIMENTO PROGRAMMATO', 20, yPos);
                yPos += 8;

                const totaleInv = calcolaTotalePreventivi();
                const contributo = totaleInv * (calcolaPercentualeContributo()) / 100;

                const investimento = [
                    ['Categoria A - Processi Produttivi', formatEuro(calcolaTotalePreventiviPerCategoria('cat_a'))],
                    ['Categoria B - Edifici', formatEuro(calcolaTotalePreventiviPerCategoria('cat_b'))],
                    ['Categoria C - Macchinari', formatEuro(calcolaTotalePreventiviPerCategoria('cat_c'))],
                    ['Categoria D - Rinnovabili', formatEuro(calcolaTotalePreventiviPerCategoria('cat_d'))],
                    ['Software (Voce b)', formatEuro(calcolaTotalePreventiviPerCategoria('cat_software'))],
                    ['Spese Edili (Voce c)', formatEuro(calcolaTotalePreventiviPerCategoria('cat_edili'))],
                    ['Spese Tecniche (Voce d)', formatEuro(calcolaTotalePreventiviPerCategoria('cat_tecniche'))],
                    ['APE (Voce e)', formatEuro(calcolaTotalePreventiviPerCategoria('cat_ape'))],
                    ['TOTALE INVESTIMENTO', formatEuro(totaleInv)],
                    ['Percentuale Contributo', (calcolaPercentualeContributo()) + '%'],
                    ['CONTRIBUTO RICHIESTO', formatEuro(contributo)],
                ];

                doc.autoTable({
                    startY: yPos,
                    body: investimento,
                    theme: 'striped',
                    headStyles: { fillColor: [39, 174, 96] },
                    styles: { fontSize: 10 },
                    columnStyles: { 1: { halign: 'right', fontStyle: 'bold' } }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // SEZIONE 4: DATI ECONOMICI
                if (yPos > 230) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('4. DATI ECONOMICI', 20, yPos);
                yPos += 8;

                const economici = [
                    ['Fonte Dati', getTipoDocumentoLabel(datiDomanda.mol.tipoDocumento) || '-'],
                    ['Regime Contabile', getRegimeContabileLabel(datiDomanda.mol.regimeContabile) || '-'],
                    ['MOL (Margine Operativo Lordo)', formatEuro(datiDomanda.mol.valoreMOL || 0)],
                    ['Dimensione Aziendale', datiDomanda.dimensioneAziendale.categoria || '-'],
                    ['Indicatore Ordinatore', (datiDomanda.mol.indicatoreOrdinatore || 0).toFixed(4)],
                ];

                doc.autoTable({
                    startY: yPos,
                    body: economici,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                // FOOTER
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text('Allegato 2.1.A - Domanda di Finanziamento', 105, 285, { align: 'center' });
                    doc.text('Pagina ' + i + ' di ' + pageCount, 105, 290, { align: 'center' });
                }

                // SALVA
                const filename = 'Allegato_2.1.A_Domanda_' + (datiDomanda.anagrafica.partitaIva || 'draft') + '.pdf';
                doc.save(filename);

                console.log('[PDF] ✅ Allegato 2.1.A generato:', filename);
                alert('✅ PDF Domanda generato!\n\n' + filename);

            } catch (error) {
                console.error('[PDF] Errore:', error);
                alert('❌ Errore generazione PDF:\n\n' + error.message);
            }
        }

         function esportaFormularioPDF() {
            console.log('[PDF] Generazione Allegato F - Formulario Completo');
            
            const { jsPDF } = window.jspdf;
            if (!jsPDF) { alert('❌ Errore caricamento PDF.'); return; }

            try {
                const doc = new jsPDF();
                let yPos = 20;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;

                // HEADER
                doc.setFontSize(16); doc.setFont(undefined, 'bold');
                doc.text('SICILIA EFFICIENTE - Azione 2.1.2', pageWidth/2, yPos, { align: 'center' });
                yPos += 8;
                doc.setFontSize(14);
                doc.text('Allegato F - Formulario del Progetto', pageWidth/2, yPos, { align: 'center' });
                yPos += 15;

                // A. DATI IDENTIFICATIVI
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('A. DATI IDENTIFICATIVI', margin, yPos);
                yPos += 6;
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                doc.text(`Impresa: ${datiDomanda.anagrafica.ragioneSociale || '-'}`, margin, yPos);
                yPos += 5;
                doc.text(`P.IVA: ${datiDomanda.anagrafica.partitaIva || '-'}`, margin, yPos);
                yPos += 10;

                // B. PREVENTIVI
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('B. PREVENTIVI', margin, yPos);
                yPos += 6;

                const prevData = (datiDomanda.preventivi || []).map((p, i) => [
                    i+1, p.categoria, p.descrizione, p.fornitore, formatEuro(p.importo)
                ]);

                if (prevData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['#', 'Cat', 'Descrizione', 'Fornitore', 'Importo']],
                        body: prevData,
                        theme: 'striped',
                        headStyles: { fillColor: [41, 128, 185] },
                        styles: { fontSize: 8 },
                        columnStyles: { 4: { halign: 'right' } }
                    });
                    yPos = doc.lastAutoTable.finalY + 10;
                } else {
                    doc.setFontSize(10); doc.setFont(undefined, 'normal');
                    doc.text('Nessun preventivo inserito.', margin, yPos);
                    yPos += 10;
                }

                // E.3 PIANO DI LAVORO (NUOVO!)
                if (yPos > 250) { doc.addPage(); yPos = 20; }
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('E.3 PIANO DI LAVORO', margin, yPos);
                yPos += 6;

                const wpData = (datiDomanda.workPackages || []).map(wp => [
                    wp.wp, wp.task, wp.output, formatEuro(wp.budget), wp.kpi
                ]);

                if (wpData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['WP', 'Task', 'Output', 'Budget', 'KPI']],
                        body: wpData,
                        theme: 'grid',
                        headStyles: { fillColor: [46, 204, 113] },
                        styles: { fontSize: 8 }
                    });
                    yPos = doc.lastAutoTable.finalY + 10;
                } else {
                    doc.setFontSize(10); doc.setFont(undefined, 'normal');
                    doc.text('Nessun Work Package inserito.', margin, yPos);
                    yPos += 10;
                }

                // CRONOPROGRAMMA (NUOVO!)
                if (yPos > 250) { doc.addPage(); yPos = 20; }
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('CRONOPROGRAMMA', margin, yPos);
                yPos += 6;

                const cronoData = (datiDomanda.cronoprogramma || []).map(c => {
                    const row = [c.wp, c.descrizione];
                    // Mapping mesi boolean -> "X"
                    if(c.mesi) {
                        c.mesi.forEach(m => row.push(m ? 'X' : ''));
                    } else {
                        for(let i=0; i<12; i++) row.push('');
                    }
                    return row;
                });

                if (cronoData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['WP', 'Attività', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']],
                        body: cronoData,
                        theme: 'grid',
                        styles: { fontSize: 7, cellPadding: 1 },
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 50 }
                            // Le colonne dei mesi sono automatiche
                        }
                    });
                    yPos = doc.lastAutoTable.finalY + 10;
                } else {
                    doc.text('Nessuna attività inserita.', margin, yPos);
                    yPos += 10;
                }

                // D. DNSH & H.3 (Breve riepilogo)
                if (yPos > 240) { doc.addPage(); yPos = 20; }
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('ALTRI DATI', margin, yPos);
                yPos += 6;
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                
                // DNSH
                const hasCaldaie = datiDomanda.preventivi?.some(p => (p.descrizione || '').toLowerCase().includes('caldaia'));
                doc.text(hasCaldaie ? '⚠️ Verifica DNSH richiesta (possibili caldaie)' : '✓ DNSH: Nessuna caldaia rilevata', margin, yPos);
                yPos += 8;

                // MOL
                doc.text(`MOL Calcolato: ${formatEuro(datiDomanda.mol.valoreMOL || 0)}`, margin, yPos);

                // FOOTER
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Pagina ${i} di ${pageCount}`, pageWidth/2, 290, { align: 'center' });
                }

                doc.save('Allegato_F_Completo.pdf');
                alert('✅ PDF generato con Tabelle WP e Cronoprogramma!');

            } catch (error) {
                console.error('[PDF] Errore:', error);
                alert('❌ Errore generazione PDF: ' + error.message);
            }
        }
        
        function esportaDSANPDF() {
            console.log('[PDF] Generazione Allegato C - DSAN MOL');
            
            // Verifica libreria jsPDF
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert('❌ Libreria PDF non caricata!\n\nRicarica la pagina o verifica la connessione internet.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let yPos = 20;

                // HEADER
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('ALLEGATO C - DSAN', 105, yPos, { align: 'center' });
                yPos += 8;
                doc.setFontSize(12);
                doc.text('Dichiarazione Sostitutiva Atto Notorio - Calcolo MOL', 105, yPos, { align: 'center' });
                yPos += 15;

                // DATI IMPRESA
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('DATI IMPRESA', 20, yPos);
                yPos += 8;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('Denominazione: ' + (datiDomanda.anagrafica.ragioneSociale || '-'), 20, yPos);
                yPos += 6;
                doc.text('P.IVA: ' + (datiDomanda.anagrafica.partitaIva || '-'), 20, yPos);
                yPos += 10;

                // CALCOLO MOL
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('CALCOLO MARGINE OPERATIVO LORDO (MOL)', 20, yPos);
                yPos += 8;

                // Tabella MOL: dettaglio se bilancio, sintetico se dichiarazione redditi
                let molData;
                if (datiDomanda.mol.tipoDocumento === 'dichredditi') {
                    molData = [
                        ['Fonte dati', 'Ultima Dichiarazione dei Redditi'],
                        ['Regime contabile', getRegimeContabileLabel(datiDomanda.mol.regimeContabile) || '-'],
                        ['', ''],
                        ['A) Valore della Produzione', formatEuro(datiDomanda.mol.valoreProduzione || 0)],
                        ['B) Costi della Produzione', formatEuro(datiDomanda.mol.costiProduzione || 0)],
                        ['', ''],
                        ['MOL (A − B)', formatEuro(datiDomanda.mol.valoreMOL || 0)]
                    ];
                } else {
                    molData = [
                        ['A) Valore della Produzione', formatEuro(datiDomanda.mol.valoreProduzione || 0)],
                        ['B) Costi della Produzione', ''],
                        ['  - Materie prime', formatEuro(datiDomanda.mol.materiePrime || 0)],
                        ['  - Servizi', formatEuro(datiDomanda.mol.costiServizi || 0)],
                        ['  - Godimento beni di terzi', formatEuro(datiDomanda.mol.costiBeniTerzi || 0)],
                        ['  - Personale', formatEuro(datiDomanda.mol.spesePersonale || 0)],
                        ['  - Ammortamenti', formatEuro(datiDomanda.mol.ammortamenti || 0)],
                        ['  - Altri costi', formatEuro(datiDomanda.mol.altriCosti || 0)],
                        ['Totale Costi (B)', formatEuro(datiDomanda.mol.costiProduzione || 0)],
                        ['', ''],
                        ['MOL (A − B)', formatEuro(datiDomanda.mol.valoreMOL || 0)]
                    ];
                }

                doc.autoTable({
                    startY: yPos,
                    body: molData,
                    theme: 'striped',
                    styles: { fontSize: 10 },
                    columnStyles: { 1: { halign: 'right', fontStyle: 'bold' } }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // DIMENSIONE AZIENDALE
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('DIMENSIONE AZIENDALE', 20, yPos);
                yPos += 8;

                const dimensioneData = [
                    ['Dipendenti (ULA)', (datiDomanda.dimensioneAziendale.dipendenti || 0).toString()],
                    ['Fatturato Annuo', formatEuro(datiDomanda.dimensioneAziendale.fatturato || 0)],
                    ['Totale Attivo Bilancio', formatEuro(datiDomanda.dimensioneAziendale.attivo || 0)],
                    ['Categoria Impresa', datiDomanda.dimensioneAziendale.categoria || 'Non calcolata']
                ];

                doc.autoTable({
                    startY: yPos,
                    body: dimensioneData,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // INDICATORE ORDINATORE
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('CRITERIO ORDINATORE', 20, yPos);
                yPos += 8;

                const ordinatoreData = [
                    ['Investimento Programmato', formatEuro(calcolaTotalePreventivi())],
                    ['MOL', formatEuro(datiDomanda.mol.valoreMOL || 0)],
                    ['Rapporto Investimento/MOL', (datiDomanda.mol.indicatoreOrdinatore || 0).toFixed(4)]
                ];

                doc.autoTable({
                    startY: yPos,
                    body: ordinatoreData,
                    theme: 'grid',
                    headStyles: { fillColor: [39, 174, 96] },
                    styles: { fontSize: 10 },
                    columnStyles: { 1: { halign: 'right', fontStyle: 'bold' } }
                });

                // FOOTER
                doc.setFontSize(8);
                doc.text('Allegato C - DSAN per Criterio Ordinatore', 105, 285, { align: 'center' });
                doc.text('Pagina 1 di 1', 105, 290, { align: 'center' });

                const filename = 'Allegato_C_DSAN_MOL_' + (datiDomanda.anagrafica.partitaIva || 'draft') + '.pdf';
                doc.save(filename);

                console.log('[PDF] ✅ Allegato C generato:', filename);
                alert('✅ PDF DSAN MOL generato!\n\n' + filename);

            } catch (error) {
                console.error('[PDF] Errore:', error);
                alert('❌ Errore generazione PDF:\n\n' + error.message);
            }
        }

        // Helper per formattare euro
        function formatEuro(value) {
            if (!value || value === 0) return '€ 0,00';
            return '€ ' + parseFloat(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Funzione helper per calcolare percentuale contributo corretta
        function calcolaPercentualeContributo() {
            // Default: 60% (De Minimis o Micro/Piccola in Esenzione)
            let perc = 60;
            
            // Eccezione: Media Impresa in Esenzione = 50%
            if (datiDomanda.mol && datiDomanda.mol.regimeAiuto === 'esenzione') {
                if (datiDomanda.dimensioneAziendale && 
                    datiDomanda.dimensioneAziendale.categoria === 'Media Impresa') {
                    perc = 50;
                }
            }
            
            return perc;
        }
        

        
        function salvaProgettoSuFile() {
            salvaDatiFase(currentStep);
            
            const nomeProgetto = datiDomanda.anagrafica?.ragioneSociale || 'Progetto_SiciliaEfficiente';
            
            const progetto = {
                metadata: {
                    applicazione: 'Sicilia Efficiente',
                    versione: '1.0',
                    nomeProgetto: nomeProgetto,
                    dataSalvataggio: new Date().toISOString(),
                    faseCorrente: currentStep
                },
                datiDomanda: datiDomanda
            };
            
            const json = JSON.stringify(progetto, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nomeProgetto.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            alert('✅ Progetto salvato con successo!');
        }
        
function caricaProgettoDaFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const progetto = JSON.parse(e.target.result);
                    
                    if (!progetto.metadata || progetto.metadata.applicazione !== 'Sicilia Efficiente') {
                        alert('❌ File non valido!\n\nQuesto non sembra essere un progetto Sicilia Efficiente.');
                        return;
                    }
                    
                    const conferma = confirm(
                        '📂 CARICAMENTO PROGETTO\n\n' +
                        'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                        'Data salvataggio: ' + new Date(progetto.metadata.dataSalvataggio).toLocaleString('it-IT') + '\n' +
                        'Fase salvata: ' + (progetto.metadata.faseCorrente || 1) + '\n\n' +
                        'ATTENZIONE: Tutti i dati correnti verranno sovrascritti.\n\nContinuare?'
                    );
                    
                    if (!conferma) return;
                    
                    // 1. Carica i dati in memoria
                    datiDomanda = progetto.datiDomanda;
                    
                    // 2. Determina la fase da caricare
                    const faseTarget = progetto.metadata.faseCorrente || 1;
                    
                    // IMPORTANTE: Aggiorna currentStep SENZA chiamare goToStep (che salverebbe dati vuoti)
                    currentStep = faseTarget;
                    
                    // 3. Aggiorna l'interfaccia manualmente
                    document.querySelectorAll('.view-section').forEach(view => view.style.display = 'none');
                    document.querySelectorAll('.nav-link-custom').forEach(nav => nav.classList.remove('active'));
                    
                    const viewTarget = document.getElementById('view-' + currentStep);
                    if (viewTarget) viewTarget.style.display = 'block';
                    
                    const navTarget = document.getElementById('nav-fase' + currentStep);
                    if (navTarget) navTarget.classList.add('active');
                    
                    // 4. Popola i campi con i dati appena caricati
                    caricaDatiFase(currentStep);
                    
                    // 5. Aggiorna eventuali contatori globali per evitare bug sugli ID
                    if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                        preventivoCounter = Math.max(...datiDomanda.preventivi.map(p => p.id));
                    }
                    if (datiDomanda.workPackages && datiDomanda.workPackages.length > 0) {
                        wpCounter = Math.max(...datiDomanda.workPackages.map(wp => wp.id));
                    }
                    if (datiDomanda.cronoprogramma && datiDomanda.cronoprogramma.length > 0) {
                        cronoCounter = Math.max(...datiDomanda.cronoprogramma.map(c => c.id));
                    }
                    
                    alert('✅ Progetto caricato con successo!');
                    
                } catch (error) {
                    console.error(error);
                    alert('❌ Errore nel caricamento del file:\n\n' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input file per permettere di ricaricare lo stesso file
        }
        
        function nuovoProgetto() {
            if (confirm('⚠️ ATTENZIONE\n\nCreare un nuovo progetto cancellerà tutti i dati correnti.\n\nContinuare?')) {
                datiDomanda = {
                    anagrafica: {},
                    legaleRappresentante: {},
                    unitaProduttiva: {},
                    mol: {},
                    dimensioneAziendale: {},
                    soci: [],
                    aiutiDeMinimis: [],
                    professionista: {},
                    diagnosi: {},
                    preventivi: [],
                    istanza: {},
                    formulario: {},
                    export: {}
                };
                
                localStorage.removeItem('siciliaEfficienteDomanda');
                goToStep(1);
                
                alert('✅ Nuovo progetto creato');
            }
        }
        
        function ripristinaBackupAutomatico() {
            const backup = localStorage.getItem('siciliaEfficienteDomanda');
            
            if (!backup) {
                alert('ℹ️ Nessun backup automatico trovato');
                return;
            }
            
            try {
                const lastSave = localStorage.getItem('siciliaEfficienteLastSave');
                const dataMsg = lastSave ? 
                    '\n\nUltimo salvataggio: ' + new Date(lastSave).toLocaleString('it-IT') : '';
                
                const conferma = confirm(
                    '💾 RIPRISTINO BACKUP AUTOMATICO' + dataMsg + '\n\n' +
                    'Tutti i dati correnti verranno sovrascritti.\n\nContinuare?'
                );
                
                if (!conferma) return;
                
                datiDomanda = JSON.parse(backup);
                goToStep(currentStep);
                
                alert('✅ Backup ripristinato con successo!');
                
            } catch (error) {
                alert('❌ Errore nel ripristino del backup:\n\n' + error.message);
            }
        }
        
        
        // ============================================
        // CANCELLA TUTTO E RESET COMPLETO
        // ============================================
        
        function cancellaTutto() {
            const conferma = confirm(
                '⚠️ ATTENZIONE\n\n' +
                'Questa operazione cancellerà TUTTI i dati salvati:\n\n' +
                '• Tutti i preventivi\n' +
                '• Tutti i dati anagrafici\n' +
                '• Calcoli MOL\n' +
                '• Backup automatici\n\n' +
                'Questa azione NON può essere annullata.\n\n' +
                'Sei sicuro di voler procedere?'
            );
            
            if (conferma) {
                const conferma2 = confirm(
                    'ULTIMA CONFERMA\n\n' +
                    'Stai per cancellare DEFINITIVAMENTE tutti i dati.\n\n' +
                    'Confermi?'
                );
                
                if (conferma2) {
                    try {
                        // Cancella localStorage
                        localStorage.clear();
                        console.log('✅ localStorage cancellato');
                        
                        // Cancella sessionStorage
                        sessionStorage.clear();
                        console.log('✅ sessionStorage cancellato');
                        
                        // Mostra messaggio
                        alert('✅ Tutti i dati sono stati cancellati.\n\nLa pagina verrà ricaricata.');
                        
                        // Ricarica la pagina
                        window.location.reload();
                        
                    } catch (error) {
                        console.error('Errore durante la cancellazione:', error);
                        alert('❌ Errore durante la cancellazione dei dati.');
                    }
                }
            }
        }

        function salvaAutomaticamente() {
            try {
                salvaDatiFase(currentStep);
                localStorage.setItem('siciliaEfficienteDomanda', JSON.stringify(datiDomanda));
                localStorage.setItem('siciliaEfficienteLastSave', new Date().toISOString());
                console.log('💾 Auto-save:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('❌ Errore auto-save:', error);
            }
        }
        
        function finalizza() {
            salvaDatiFase(6);
            
            const completezza = verificaCompletezza();
            
            let msg = '🎉 PROGETTO FINALIZZATO\n\n';
            msg += 'Impresa: ' + (datiDomanda.anagrafica?.ragioneSociale || 'N/D') + '\n';
            msg += 'P.IVA: ' + (datiDomanda.anagrafica?.partitaIva || 'N/D') + '\n';
            msg += 'Investimento: ' + formatEuro(datiDomanda.preventivi ? datiDomanda.preventivi.reduce((s,p) => s + p.importo, 0) : 0) + '\n\n';
            msg += 'Completezza: ' + completezza.percentuale + '%\n';
            
            if (completezza.campiMancanti.length > 0) {
                msg += '\n⚠️ Campi mancanti:\n' + completezza.campiMancanti.slice(0,5).join('\n');
                if (completezza.campiMancanti.length > 5) {
                    msg += '\n... e altri ' + (completezza.campiMancanti.length - 5) + ' campi';
                }
            }
            
            msg += '\n\n✅ Ricordati di:\n';
            msg += '1. Salvare il progetto\n';
            msg += '2. Esportare PDF e Excel\n';
            msg += '3. Preparare i documenti richiesti\n';
            msg += '4. Caricare sulla piattaforma ufficiale';
            
            alert(msg);
        }
        
        function verificaCompletezza() {
            const campiMancanti = [];
            let totCampi = 0;
            let campiCompilati = 0;
            
            // Verifica Fase 1
            const f1Fields = ['ragioneSociale', 'partitaIva', 'codiceAteco', 'dimensioneImpresa'];
            totCampi += f1Fields.length;
            f1Fields.forEach(field => {
                if (datiDomanda.anagrafica?.[field]) campiCompilati++;
                else campiMancanti.push('Fase 1: ' + field);
            });
            
            // Verifica Fase 2
            totCampi += 2;
            if (datiDomanda.mol?.valoreProduzione !== undefined && datiDomanda.mol?.valoreProduzione !== '') campiCompilati++;
            else campiMancanti.push('Fase 2: MOL');
            
            if (datiDomanda.mol?.costoTotaleInvestimento) campiCompilati++;
            else campiMancanti.push('Fase 2: Costo investimento');
            
            // Verifica Fase 3
            totCampi += 2;
            if (datiDomanda.diagnosi?.epgl_ante) campiCompilati++;
            else campiMancanti.push('Fase 3: Diagnosi energetica');
            
            if (datiDomanda.preventivi?.length > 0) campiCompilati++;
            else campiMancanti.push('Fase 3: Preventivi');
            
            const percentuale = Math.round((campiCompilati / totCampi) * 100);
            
            return {
                percentuale: percentuale,
                campiMancanti: campiMancanti
            };
        }
        

        // ============================================
        // FUNZIONI H2 - PIANO COPERTURE FINANZIARIE
        // ============================================
        function calcolaH2() {
            // IMPIEGHI
            const inv_immat_anno1 = getNumericValue('h2_inv_immat_anno1');
            const inv_immat_tot = getNumericValue('h2_inv_immat_tot');
            const inv_mat_anno1 = getNumericValue('h2_inv_mat_anno1');
            const inv_mat_tot = getNumericValue('h2_inv_mat_tot');
            const iva_anno1 = getNumericValue('h2_iva_anno1');
            const iva_tot = getNumericValue('h2_iva_tot');
            
            const tot_impieghi_anno1 = inv_immat_anno1 + inv_mat_anno1 + iva_anno1;
            const tot_impieghi_tot = inv_immat_tot + inv_mat_tot + iva_tot;
            
            setTextValue('h2_tot_impieghi_anno1', formatEuro(tot_impieghi_anno1));
            setTextValue('h2_tot_impieghi_tot', formatEuro(tot_impieghi_tot));
            
            // Percentuali impieghi
            if (tot_impieghi_tot > 0) {
                setValue('h2_inv_immat_perc', ((inv_immat_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_inv_mat_perc', ((inv_mat_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_iva_perc', ((iva_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
            }
            
            // FONTI
            const contributo_anno1 = getNumericValue('h2_contributo_anno1');
            const contributo_tot = contributo_anno1; // Di solito uguale
            setValue('h2_contributo_tot', contributo_tot.toFixed(2));
            
            const cap_sociale_anno1 = getNumericValue('h2_cap_sociale_anno1');
            const cap_sociale_tot = getNumericValue('h2_cap_sociale_tot');
            const finanz_soci_anno1 = getNumericValue('h2_finanz_soci_anno1');
            const finanz_soci_tot = getNumericValue('h2_finanz_soci_tot');
            const riserve_anno1 = getNumericValue('h2_riserve_anno1');
            const riserve_tot = getNumericValue('h2_riserve_tot');
            const finanz_ml_anno1 = getNumericValue('h2_finanz_ml_anno1');
            const finanz_ml_tot = getNumericValue('h2_finanz_ml_tot');
            const finanz_breve_anno1 = getNumericValue('h2_finanz_breve_anno1');
            const finanz_breve_tot = getNumericValue('h2_finanz_breve_tot');
            
            const tot_fonti_anno1 = contributo_anno1 + cap_sociale_anno1 + finanz_soci_anno1 + 
                                    riserve_anno1 + finanz_ml_anno1 + finanz_breve_anno1;
            const tot_fonti_tot = contributo_tot + cap_sociale_tot + finanz_soci_tot + 
                                  riserve_tot + finanz_ml_tot + finanz_breve_tot;
            
            setTextValue('h2_tot_fonti_anno1', formatEuro(tot_fonti_anno1));
            setTextValue('h2_tot_fonti_tot', formatEuro(tot_fonti_tot));
            
            // Percentuali fonti
            if (tot_impieghi_tot > 0) {
                setValue('h2_contributo_perc', ((contributo_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_cap_sociale_perc', ((cap_sociale_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_soci_perc', ((finanz_soci_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_riserve_perc', ((riserve_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_ml_perc', ((finanz_ml_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_breve_perc', ((finanz_breve_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                
                const perc_fonti = (tot_fonti_tot / tot_impieghi_tot) * 100;
                setTextValue('h2_tot_fonti_perc', perc_fonti.toFixed(2) + '%');
            }
            
            // BILANCIAMENTO
            const sbilanciamento = tot_fonti_tot - tot_impieghi_tot;
            setTextValue('h2_sbilanciamento', formatEuro(sbilanciamento));
            
            const alertDiv = document.getElementById('alertBilanciamento');
            if (alertDiv) {
                // Mostra solo se sbilanciato E ci sono dati validi inseriti
                const hasDati = (tot_fonti_tot > 0 || tot_impieghi_tot > 0);
                const isValidSbilanciamento = !isNaN(sbilanciamento) && isFinite(sbilanciamento);
                
                if (isValidSbilanciamento && Math.abs(sbilanciamento) > 0.01 && hasDati) {
                    alertDiv.style.display = 'block';
                } else {
                    alertDiv.style.display = 'none';
                }
            }
        }
        
        // ============================================
        // FUNZIONI H3 - SOSTENIBILITÀ
        // ============================================
        function calcolaH3(anno) {
            const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
            
            anni.forEach(function(a) {
                // Ottieni valori
                const fatt = parseFloat(document.getElementById('h3_fatt_' + a).value) || 0;
                const altri = parseFloat(document.getElementById('h3_altri_' + a).value) || 0;
                const mp = parseFloat(document.getElementById('h3_mp_' + a).value) || 0;
                const serv = parseFloat(document.getElementById('h3_serv_' + a).value) || 0;
                const god = parseFloat(document.getElementById('h3_god_' + a).value) || 0;
                const pers = parseFloat(document.getElementById('h3_pers_' + a).value) || 0;
                const amm = parseFloat(document.getElementById('h3_amm_' + a).value) || 0;
                const fin = parseFloat(document.getElementById('h3_fin_' + a).value) || 0;
                const straord = parseFloat(document.getElementById('h3_straord_' + a).value) || 0;
                const imp = parseFloat(document.getElementById('h3_imp_' + a).value) || 0;
                const attivo = parseFloat(document.getElementById('h3_attivo_' + a).value) || 0;
                
                // Calcola Valore Produzione
                const vp = fatt + altri;
                document.getElementById('h3_vp_' + a).value = vp.toFixed(2);
                
                // Calcola MOL
                const mol = vp - mp - serv - god - pers;
                document.getElementById('h3_mol_' + a).value = mol.toFixed(2);
                
                // Calcola Risultato Operativo (EBIT)
                const ro = mol - amm;
                document.getElementById('h3_ro_' + a).value = ro.toFixed(2);
                
                // Calcola Risultato Lordo
                const rl = ro + fin + straord;
                document.getElementById('h3_rl_' + a).value = rl.toFixed(2);
                
                // Calcola Risultato Netto
                const rn = rl - imp;
                document.getElementById('h3_rn_' + a).value = rn.toFixed(2);
                
                // Calcola indici H.4
                // ROI = EBIT / Attivo × 100
                let roi = '';
                if (attivo > 0) {
                    roi = ((ro / attivo) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_roi_' + a).value = roi;
                
                // ROS = EBIT / Fatturato × 100
                let ros = '';
                if (fatt > 0) {
                    ros = ((ro / fatt) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_ros_' + a).value = ros;
                
                // Margine contribuzione = MOL / Fatturato × 100
                let marg = '';
                if (fatt > 0) {
                    marg = ((mol / fatt) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_marg_' + a).value = marg;
            });
        }
        
                
        
        // ============================================
        // UTILITY
        // ============================================
        function formatEuro(value) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            return '€ ' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.').replace('.', ',').replace(/,(\d{2})$/, '.$1');
        }
        
        // ============================================
        // INIZIALIZZAZIONE
        // ============================================
        
        // Auto-save ogni 30 secondi
        setInterval(salvaAutomaticamente, 30000);
        
        // Carica backup all'avvio
        window.addEventListener('load', function() {
            const backup = localStorage.getItem('siciliaEfficienteDomanda');
            if (backup) {
                try {
                    datiDomanda = JSON.parse(backup);
                    caricaDatiFase(1);
                    console.log('✅ Backup automatico caricato');
                } catch (error) {
                    console.error('❌ Errore caricamento backup:', error);
                }
            }
        });
        
        // Mostra/nascondi sezione de minimis in base al regime
        document.addEventListener('change', function(e) {
            if (e.target.name === 'regimeAiuto') {
                const regime = e.target.value;
                const sezioneDeMinimis = document.getElementById('sezioneDeMinimis');
                const sezioneDeMinimisIstanza = document.getElementById('sezioneDeMinimisIstanza');
                
                if (regime === 'deminimis') {
                    if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'block';
                    if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'block';
                } else {
                    if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'none';
                    if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'none';
                }
            }
        });
        
        console.log('✅ Sicilia Efficiente - Applicazione caricata');

// ============================================
        // GESTIONE TABELLE FORMULARIO (FIXED)
        // ============================================
        
        // COSTANTI CONFIGURABILI
         
        
        let preventivoCounter = 0;
        let wpCounter = 0;
        let cronoCounter = 0;

        // --- GESTIONE WORK PACKAGES (WP) ---

        function renderizzaTabellaWP() {
            const tbody = document.getElementById('tabellaWP');
            tbody.innerHTML = ''; 
            
            if (!datiDomanda.workPackages || datiDomanda.workPackages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted"><em>Nessun work package inserito. Usa il bottone qui sotto per aggiungere.</em></td></tr>';
                return;
            }
            
            datiDomanda.workPackages.forEach(wp => {
                renderizzaRigaWP(wp, tbody);
            });
        }

        function renderizzaRigaWP(wp, tbody) {
            const row = tbody.insertRow();
            row.setAttribute('data-id', wp.id);
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" value="${wp.og || ''}" onchange="aggiornaDatiWP(${wp.id}, 'og', this.value)" placeholder="OG1"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.os || ''}" onchange="aggiornaDatiWP(${wp.id}, 'os', this.value)" placeholder="OS1.1"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.wp || ''}" onchange="aggiornaDatiWP(${wp.id}, 'wp', this.value)" placeholder="WP1"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.task || ''}" onchange="aggiornaDatiWP(${wp.id}, 'task', this.value)" placeholder="A1.1"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.deliverable || ''}" onchange="aggiornaDatiWP(${wp.id}, 'deliverable', this.value)" placeholder="D1.1"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.output || ''}" onchange="aggiornaDatiWP(${wp.id}, 'output', this.value)" placeholder="R1.1"></td>
                <td><input type="number" class="form-control form-control-sm" step="0.01" value="${wp.budget || ''}" onchange="aggiornaDatiWP(${wp.id}, 'budget', this.value)" placeholder="0.00"></td>
                <td><input type="text" class="form-control form-control-sm" value="${wp.kpi || ''}" onchange="aggiornaDatiWP(${wp.id}, 'kpi', this.value)" placeholder="KPI"></td>
                <td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaWP(${wp.id})"><i class="fas fa-trash"></i></button></td>
            `;
        }
        
        function aggiornaDatiWP(id, campo, valore) {
            const index = datiDomanda.workPackages.findIndex(wp => wp.id === id);
            if (index !== -1) {
                datiDomanda.workPackages[index][campo] = campo === 'budget' ? parseFloat(valore) : valore;
            }
        }
        
        function aggiungiRigaWP() {
            wpCounter++;
            if (!datiDomanda.workPackages) datiDomanda.workPackages = [];
            
            // Crea oggetto dati
            const nuovoWP = {
                id: wpCounter,
                og: '', os: '', wp: '', task: '', deliverable: '', output: '', budget: 0, kpi: ''
            };
            datiDomanda.workPackages.push(nuovoWP);

            // Renderizza
            renderizzaTabellaWP();
        }
        
        function rimuoviRigaWP(id) {
            if(confirm("Eliminare questo Work Package?")) {
                datiDomanda.workPackages = datiDomanda.workPackages.filter(wp => wp.id !== id);
                renderizzaTabellaWP();
            }
        }

        // --- GESTIONE CRONOPROGRAMMA ---
        
        function renderizzaTabellaCrono() {
            const tbody = document.getElementById('tabellaCrono');
            tbody.innerHTML = '';
            
            if (!datiDomanda.cronoprogramma || datiDomanda.cronoprogramma.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted"><em>Nessuna attività inserita. Usa il bottone qui sotto per aggiungere.</em></td></tr>';
                return;
            }
            
            datiDomanda.cronoprogramma.forEach(c => {
                const row = tbody.insertRow();
                let html = `
                    <td><input type="text" class="form-control form-control-sm" value="${c.wp || ''}" onchange="aggiornaDatiCrono(${c.id}, 'wp', this.value)" placeholder="WP1"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${c.descrizione || ''}" onchange="aggiornaDatiCrono(${c.id}, 'descrizione', this.value)" placeholder="Descrizione"></td>
                `;
                
                // 12 Mesi Checkbox
                for (let m = 0; m < 12; m++) {
                    const isChecked = (c.mesi && c.mesi[m]) ? 'checked' : '';
                    html += `<td class="text-center"><input type="checkbox" ${isChecked} onchange="aggiornaCheckboxCrono(${c.id}, ${m}, this.checked)"></td>`;
                }
                
                html += `<td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaCrono(${c.id})"><i class="fas fa-trash"></i></button></td>`;
                row.innerHTML = html;
            });
        }
        
        function aggiornaDatiCrono(id, campo, valore) {
            const index = datiDomanda.cronoprogramma.findIndex(c => c.id === id);
            if (index !== -1) {
                datiDomanda.cronoprogramma[index][campo] = valore;
            }
        }

        function aggiornaCheckboxCrono(id, meseIndex, checked) {
            const index = datiDomanda.cronoprogramma.findIndex(c => c.id === id);
            if (index !== -1) {
                if (!datiDomanda.cronoprogramma[index].mesi) {
                    datiDomanda.cronoprogramma[index].mesi = [];
                }
                datiDomanda.cronoprogramma[index].mesi[meseIndex] = checked;
            }
        }
        
        function aggiungiRigaCrono() {
            cronoCounter++;
            if (!datiDomanda.cronoprogramma) datiDomanda.cronoprogramma = [];
            
            datiDomanda.cronoprogramma.push({
                id: cronoCounter,
                wp: '', 
                descrizione: '',
                mesi: [false, false, false, false, false, false, false, false, false, false, false, false]
            });
            
            renderizzaTabellaCrono();
        }
        
        function rimuoviRigaCrono(id) {
            if(confirm("Eliminare questa attività dal cronoprogramma?")) {
                datiDomanda.cronoprogramma = datiDomanda.cronoprogramma.filter(c => c.id !== id);
                renderizzaTabellaCrono();
            }
        }

        // --- FUNZIONI DI SUPPORTO E PRECOMPILAZIONE ---

        function compilaAutomaticaWP() {
            // Questa funzione genera solo testo per la textarea "Cronoprogramma" (Sezione E.3)
            // Non popola le tabelle dinamiche per evitare conflitti complessi
            if (!datiDomanda || !datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
                alert('⚠️ ATTENZIONE\n\nInserire prima i preventivi nella Fase 3!');
                return;
            }
            
            const conferma = confirm(
                '🎯 GENERATORE TESTO PIANO DI LAVORO\n\n' +
                'Il sistema genererà una bozza testuale nel campo "E.3 Piano di Lavoro" qui sotto.\n' +
                'Questo NON compilerà le tabelle sopra, ma fornirà una traccia scritta.\n\n' +
                'Procedere?'
            );
            
            if (!conferma) return;
            
            let testo = "PIANO DI LAVORO GENERATO (Bozza)\n\n";
            testo += "OBIETTIVO: Efficientamento energetico tramite interventi mirati.\n\n";
            
            datiDomanda.preventivi.forEach((p, idx) => {
                testo += `WP${idx+1}: Realizzazione intervento "${p.descrizione}"\n`;
                testo += `- Task 1: Ordine fornitore ${p.fornitore}\n`;
                testo += `- Task 2: Installazione e posa in opera\n`;
                testo += `- Task 3: Collaudo e verifica funzionale\n\n`;
            });
            
            testo += "WP Finale: Monitoraggio e rendicontazione dei risultati raggiunti.";
            
            const areaCrono = document.getElementById('cronoprogramma');
            if (areaCrono) {
                areaCrono.value = testo;
                // Aggiorna model
                if (!datiDomanda.formulario) datiDomanda.formulario = {};
                datiDomanda.formulario.cronoprogramma = testo;
            }
        }
        
        function precompilaDatiH2() {
            if (!datiDomanda || !datiDomanda.mol) {
                alert('⚠️ ATTENZIONE\n\nCompletare prima la Fase 2 (MOL e dimensione aziendale)!');
                return;
            }
            
            // FIX: Calcola totale direttamente dai dati preventivi (più sicuro)
            const totaleInv = calcolaTotalePreventivi();
            
            if (totaleInv === 0) {
                alert('⚠️ ATTENZIONE\n\nTotale investimento è zero.\n\nInserisci prima alcuni preventivi nella Fase 3.');
                return;
            }
            
            // Calcola contributo (60% per Sicilia Efficiente, salvo eccezioni gestite altrove)
            const percContributo = calcolaPercentualeContributo(); 
            const contributo = totaleInv * (percContributo / 100);
            const cofinanziamento = totaleInv - contributo;
            
            // Suddividi immateriali/materiali secondo Avviso Par. 4.4.1
            // IMMATERIALI: Software, Spese Tecniche, APE
            // MATERIALI: Cat A/B/C/D (incluse Rinnovabili!), Spese Edili
            let immateriali = 0;
            let materiali = 0;
            
            if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                datiDomanda.preventivi.forEach(function(p) {
                    // Classificazione corretta
                    if (p.categoria === 'cat_software' || 
                        p.categoria === 'cat_tecniche' || 
                        p.categoria === 'cat_ape') {
                        // IMMATERIALI
                        immateriali += parseFloat(p.importo) || 0;
                    } else {
                        // MATERIALI (cat_a, cat_b, cat_c, cat_d, cat_edili)
                        materiali += parseFloat(p.importo) || 0;
                    }
                });
            } else {
                materiali = totaleInv;
            }
            
            // Compila IMPIEGHI
            document.getElementById('h2_inv_immat_anno1').value = immateriali.toFixed(2);
            document.getElementById('h2_inv_immat_tot').value = immateriali.toFixed(2);
            document.getElementById('h2_inv_mat_anno1').value = materiali.toFixed(2);
            document.getElementById('h2_inv_mat_tot').value = materiali.toFixed(2);
            document.getElementById('h2_iva_anno1').value = '0.00';
            document.getElementById('h2_iva_tot').value = '0.00';
            
            // Compila FONTI
            document.getElementById('h2_contributo_anno1').value = contributo.toFixed(2);
            document.getElementById('h2_contributo_tot').value = contributo.toFixed(2);
            document.getElementById('h2_riserve_anno1').value = cofinanziamento.toFixed(2);
            document.getElementById('h2_riserve_tot').value = cofinanziamento.toFixed(2);
            
            // Azzera altri campi per pulizia
            const campiDaAzzerare = [
                'h2_cap_sociale_anno1', 'h2_cap_sociale_tot',
                'h2_finanz_soci_anno1', 'h2_finanz_soci_tot',
                'h2_finanz_ml_anno1', 'h2_finanz_ml_tot',
                'h2_finanz_breve_anno1', 'h2_finanz_breve_tot'
            ];
            campiDaAzzerare.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '0.00';
            });
            
            // Ricalcola i totali della tabella
            calcolaH2();
            
            alert('✅ DATI H.2 PRE-COMPILATI!\n\n' +
                  'Investimento totale: €' + totaleInv.toFixed(2) + '\n' +
                  'Percentuale aiuto: ' + percContributo + '%\n' +
                  'Copertura: Contributo + Riserve (Mezzi propri)\n\n' +
                  'Verifica e personalizza i valori se necessario.');
        }

        // Calcolo Budget Totale (Tabella 3)
        function calcolaBudgetTotale() {
            const voci = ['a', 'b', 'c', 'd', 'e'];
            let totaleAmmissibile = 0;
            let totaleContributo = 0;
            let totaleImpresa = 0;
            
            voci.forEach(voce => {
                const ammissibile = getNumericValue(`budget_${voce}_totale`);
                const intensita = getNumericValue(`budget_${voce}_intensita`);
                
                const contributo = ammissibile * (intensita / 100);
                const costoImpresa = ammissibile - contributo;
                
                setValue(`budget_${voce}_contributo`, contributo.toFixed(2));
                setTextValue(`budget_${voce}_impresa`, formatEuro(costoImpresa));
                
                totaleAmmissibile += ammissibile;
                totaleContributo += contributo;
                totaleImpresa += costoImpresa;
            });
            
            setTextValue('budget_totale_ammissibile', formatEuro(totaleAmmissibile));
            setTextValue('budget_totale_contributo', formatEuro(totaleContributo));
            setTextValue('budget_totale_impresa', formatEuro(totaleImpresa));
            
            const intensitaMedia = totaleAmmissibile > 0 ? (totaleContributo / totaleAmmissibile) * 100 : 0;
            setTextValue('budget_intensita_media', intensitaMedia.toFixed(2) + '%');
            
            // Validazione limiti
            validaLimitiBudget(totaleAmmissibile);
        }
        
        function validaLimitiBudget(totale) {
            const speseEdili = getNumericValue('budget_c_totale');
            const speseTecniche = getNumericValue('budget_d_totale');
            const baseCalcolo = getNumericValue('budget_a_totale') + getNumericValue('budget_b_totale') + speseEdili;
            
            let messaggi = [];
            
            // Validazione min/max investimento
            if (totale < 50000) {
                messaggi.push('⚠️ Investimento inferiore al minimo (€ 50.000)');
            }
            if (totale > 500000) {
                messaggi.push('⚠️ Investimento superiore al massimo (€ 500.000)');
            }
            
            // Validazione 20% spese edili
            const maxEdili = totale * 0.20;
            if (speseEdili > maxEdili) {
                messaggi.push(`⚠️ Spese edili superiori al 20% (max ${formatEuro(maxEdili)})`);
            }
            
            // Validazione 10% spese tecniche
            const maxTecniche = baseCalcolo * 0.10;
            if (speseTecniche > maxTecniche) {
                messaggi.push(`⚠️ Spese tecniche superiori al 10% (max ${formatEuro(maxTecniche)})`);
            }
            
            // Mostra alert se ci sono problemi
            if (messaggi.length > 0) {
                console.warn('Validazione Budget:', messaggi);
            }
        }
        
        // Proietta automaticamente esercizi previsionali H.3
        function proiettaEserciziPrevisionali() {
            // Verifica dati storici
            const fatt_2023 = parseFloat(document.getElementById('h3_fatt_2023').value) || 0;
            const fatt_2024 = parseFloat(document.getElementById('h3_fatt_2024').value) || 0;
            
            if (fatt_2023 === 0 || fatt_2024 === 0) {
                alert('⚠️ ATTENZIONE\n\nInserire prima i dati storici 2023 e 2024!');
                return;
            }
            
            const conferma = confirm(
                '🎯 PROIEZIONE AUTOMATICA TRIENNALE\n\n' +
                'Il sistema proietterà gli anni n+1, n+2, n+3 basandosi su:\n\n' +
                '• Analisi trend storico 2023-2024\n' +
                '• Crescita organica stimata\n' +
                '• Impatto efficientamento energetico:\n' +
                '  - Riduzione costi energetici\n' +
                '  - Ammortamento investimento\n' +
                '  - Miglioramento competitività\n\n' +
                'Procedere?'
            );
            
            if (!conferma) return;
            
            // Calcola tasso crescita storico
            const crescitaFatt = fatt_2024 / fatt_2023;
            
            // Parametri proiezione
            const tassoBase = Math.max(1.03, Math.min(1.08, crescitaFatt));  // 3-8% annuo
            const impattoEfficienza = 0.05;  // 5% risparmio costi energetici
            
            // Ottieni tutti i valori 2024
            const altri_2024 = parseFloat(document.getElementById('h3_altri_2024').value) || 0;
            const mp_2024 = parseFloat(document.getElementById('h3_mp_2024').value) || 0;
            const serv_2024 = parseFloat(document.getElementById('h3_serv_2024').value) || 0;
            const god_2024 = parseFloat(document.getElementById('h3_god_2024').value) || 0;
            const pers_2024 = parseFloat(document.getElementById('h3_pers_2024').value) || 0;
            const amm_2024 = parseFloat(document.getElementById('h3_amm_2024').value) || 0;
            const fin_2024 = parseFloat(document.getElementById('h3_fin_2024').value) || 0;
            const straord_2024 = parseFloat(document.getElementById('h3_straord_2024').value) || 0;
            const imp_2024 = parseFloat(document.getElementById('h3_imp_2024').value) || 0;
            const attivo_2024 = parseFloat(document.getElementById('h3_attivo_2024').value) || 0;
            
            // Calcola ammortamento investimento (10 anni)
            // Calcola totale investimento
            const totaleInvElement = document.getElementById('totaleInvestimenti');
            const totaleInv = totaleInvElement ? parseFloat(totaleInvElement.value) || 0 : calcolaTotalePreventivi();
            
            if (totaleInv === 0) {
                alert('⚠️ ATTENZIONE\n\nTotale investimento è zero.\n\nInserisci prima alcuni preventivi nella Fase 3.');
                return;
            }
            const ammInvestimento = totaleInv / 10;
            
            // PROIETTA n+1
            document.getElementById('h3_fatt_n1').value = (fatt_2024 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n1').value = (altri_2024 * tassoBase).toFixed(2);
            // Costi: crescita moderata con effetto efficienza
            document.getElementById('h3_mp_n1').value = (mp_2024 * tassoBase * (1 - impattoEfficienza * 0.3)).toFixed(2);
            document.getElementById('h3_serv_n1').value = (serv_2024 * tassoBase * (1 - impattoEfficienza * 0.5)).toFixed(2);
            document.getElementById('h3_god_n1').value = (god_2024 * tassoBase).toFixed(2);
            document.getElementById('h3_pers_n1').value = (pers_2024 * 1.02).toFixed(2);  // Crescita moderata
            document.getElementById('h3_amm_n1').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n1').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n1').value = '0.00';
            document.getElementById('h3_imp_n1').value = (imp_2024 * 1.05).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n1').value = (attivo_2024 + totaleInv * 0.3).toFixed(2);
            }
            
            // PROIETTA n+2
            const fatt_n1 = parseFloat(document.getElementById('h3_fatt_n1').value);
            const mp_n1 = parseFloat(document.getElementById('h3_mp_n1').value);
            const serv_n1 = parseFloat(document.getElementById('h3_serv_n1').value);
            
            document.getElementById('h3_fatt_n2').value = (fatt_n1 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n2').value = (altri_2024 * Math.pow(tassoBase, 2)).toFixed(2);
            document.getElementById('h3_mp_n2').value = (mp_n1 * tassoBase * (1 - impattoEfficienza * 0.4)).toFixed(2);
            document.getElementById('h3_serv_n2').value = (serv_n1 * tassoBase * (1 - impattoEfficienza * 0.6)).toFixed(2);
            document.getElementById('h3_god_n2').value = (god_2024 * Math.pow(tassoBase, 2)).toFixed(2);
            document.getElementById('h3_pers_n2').value = (pers_2024 * 1.04).toFixed(2);
            document.getElementById('h3_amm_n2').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n2').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n2').value = '0.00';
            document.getElementById('h3_imp_n2').value = (imp_2024 * 1.10).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n2').value = (attivo_2024 + totaleInv * 0.5).toFixed(2);
            }
            
            // PROIETTA n+3
            const fatt_n2 = parseFloat(document.getElementById('h3_fatt_n2').value);
            const mp_n2 = parseFloat(document.getElementById('h3_mp_n2').value);
            const serv_n2 = parseFloat(document.getElementById('h3_serv_n2').value);
            
            document.getElementById('h3_fatt_n3').value = (fatt_n2 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n3').value = (altri_2024 * Math.pow(tassoBase, 3)).toFixed(2);
            document.getElementById('h3_mp_n3').value = (mp_n2 * tassoBase * (1 - impattoEfficienza * 0.5)).toFixed(2);
            document.getElementById('h3_serv_n3').value = (serv_n2 * tassoBase * (1 - impattoEfficienza * 0.7)).toFixed(2);
            document.getElementById('h3_god_n3').value = (god_2024 * Math.pow(tassoBase, 3)).toFixed(2);
            document.getElementById('h3_pers_n3').value = (pers_2024 * 1.06).toFixed(2);
            document.getElementById('h3_amm_n3').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n3').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n3').value = '0.00';
            document.getElementById('h3_imp_n3').value = (imp_2024 * 1.15).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n3').value = (attivo_2024 + totaleInv * 0.7).toFixed(2);
            }
            
            // Ricalcola tutto
            calcolaH3();
            
            alert('✅ PROIEZIONE COMPLETATA!\n\n' +
                  'Dati proiettati per n+1, n+2, n+3 con:\n' +
                  '• Crescita organica: ' + ((tassoBase - 1) * 100).toFixed(1) + '% annuo\n' +
                  '• Impatto efficientamento: -' + (impattoEfficienza * 100) + '% costi energetici\n' +
                  '• Ammortamento investimento: €' + ammInvestimento.toFixed(2) + '/anno\n\n' +
                  'Verifica e personalizza i valori secondo le tue stime.');
        }
        

    </script>
</body>
</html>
