<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICILIA EFFICIENTE | Suite Gestionale v4.0 (Perfect)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #15803d; /* Green 700 */
            --bg-body: #f3f4f6;
            --sidebar-w: 280px;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-body); height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; background: #fff; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 20px; background: linear-gradient(135deg, #166534, #15803d); color: white; }
        .nav-link-custom { padding: 12px 20px; color: #4b5563; font-weight: 500; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-link-custom:hover { background: #f0fdf4; color: var(--primary); }
        .nav-link-custom.active { background: #dcfce7; color: #14532d; border-left-color: var(--primary); font-weight: 700; }
        
        /* MAIN */
        #main { margin-left: var(--sidebar-w); height: 100vh; overflow-y: auto; padding: 30px; }

        /* CARDS */
        .card-custom { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .card-header-c { padding: 15px 20px; border-bottom: 1px solid #f3f4f6; font-weight: 700; color: #1f2937; background: #fff; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .card-body-c { padding: 20px; }
        
        /* SECTION TITLES */
        .sec-title { font-size: 0.85rem; text-transform: uppercase; color: #6b7280; font-weight: 700; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; }

        /* TABLES */
        .table-input td { padding: 0; }
        .table-input input { width: 100%; border: none; padding: 8px 12px; background: transparent; }
        .table-input input:focus { background: #f0fdf4; outline: none; box-shadow: inset 0 0 0 2px var(--primary); }
        
        /* UTILS */
        .hidden { display: none !important; }
        .text-xs { font-size: 0.75rem; }
    
        
        /* VIEW SECTIONS - Navigation */
        .view-section { display: none; }
        #view-1 { display: block; }
        
        /* PROGRESS BAR */
        .progress-container { display: none; } /* Nascondi per layout pulito */
        
        /* RESULT BOX */
        .result-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .result-item:last-child { border-bottom: none; }
        .result-label { font-weight: 600; color: #4b5563; }
        .result-value { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
    
            .nav-link-custom i { margin-right: 8px; }
        
        /* NASCONDI PROGRESS/STEP INDICATOR */
        .progress-section,
        .step-indicator,
        .progress-container,
        .step-label { 
            display: none !important; 
        }
    
        /* Pulse animation per auto-save indicator */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="brand">
        <h5 class="mb-0 fw-bold"><i class="fa-solid fa-leaf"></i> SICILIA EFFICIENTE</h5>
        <small class="opacity-75">Suite Gestionale v4.0</small>
    </div>
    <div class="flex-grow-1 overflow-auto py-2">
        <div class="nav-link-custom active" onclick="goToStep(1)" id="nav-fase1"><i class="fa-solid fa-address-card me-2"></i> 1. Anagrafica</div>
        <div class="nav-link-custom" onclick="goToStep(2)" id="nav-fase2"><i class="fa-solid fa-calculator me-2"></i> 2. MOL & Asseverazione</div>
        <div class="nav-link-custom" onclick="goToStep(3)" id="nav-fase3"><i class="fa-solid fa-bolt me-2"></i> 3. Diagnosi & Costi</div>
        <div class="nav-link-custom" onclick="goToStep(4)" id="nav-fase4"><i class="fa-regular fa-file-pdf me-2"></i> 4. Istanza 2.1</div>
        <div class="nav-link-custom" onclick="goToStep(5)" id="nav-fase5"><i class="fa-solid fa-book-open me-2"></i> 5. Formulario F</div>
        <div class="nav-link-custom" onclick="goToStep(6)" id="nav-fase6"><i class="fa-solid fa-download me-2"></i> 6. Export</div>
    </div>
    <!-- FOOTER SIDEBAR - GESTIONE PROGETTO
    <div class="border-top" style="background: linear-gradient(135deg, #166534, #15803d); padding: 16px;">
        <div class="d-grid gap-2">
            <button class="btn btn-light btn-sm" onclick="nuovoProgetto()" style="font-weight: 500;">
                <i class="fas fa-file"></i> Nuovo
            </button>
            <button class="btn btn-light btn-sm" onclick="salvaProgettoSuFile()" style="font-weight: 500;">
                <i class="fas fa-save"></i> Salva Progetto
            </button>
            <button class="btn btn-light btn-sm" onclick="caricaProgettoDaFile()" style="font-weight: 500;">
                <i class="fas fa-folder-open"></i> Carica
            </button>
            <button class="btn btn-light btn-sm" onclick="ripristinaDefault()" style="font-weight: 500;">
                <i class="fas fa-undo"></i> Ripristina
            </button>
            <div class="text-center text-white mt-3" style="font-size: 0.75rem; opacity: 0.9;">
                <i class="fas fa-circle text-success" style="font-size: 0.5rem; animation: pulse 2s infinite;"></i> 
                <span class="ms-1">Auto-save attivo (ogni 30s)</span>
            </div>
        </div>-->
    </div>
</div>



<div id="main">

        <!-- Header -->
        <div class="header-section">
            <h1><i class="fas fa-leaf"></i> SICILIA EFFICIENTE</h1>
            <p>Assistente Completo per la Compilazione della Domanda</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">Azione 2.1.2 PR FESR 2021-2027 - Riqualificazione energetica nelle imprese</p>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-section" style="display:none !important;">
            <div class="step-indicator" style="display:none !important;">
                <div class="step-item active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Anagrafica</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">MOL</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Diagnosi</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Istanza</div>
                </div>
                <div class="step-item" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Formulario</div>
                </div>
                <div class="step-item" data-step="6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Export</div>
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content-section">
            <!-- Toolbar -->
            <div class="toolbar">
                <button class="btn btn-sm btn-outline-primary" onclick="nuovoProgetto()">
                    <i class="fas fa-file"></i> Nuovo
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="salvaProgettoSuFile()">
                    <i class="fas fa-save"></i> Salva Progetto
                </button>
                <label class="btn btn-sm btn-outline-info mb-0">
                    <i class="fas fa-folder-open"></i> Carica
                    <input type="file" id="fileCaricaProgetto" accept=".json" style="display:none" onchange="caricaProgettoDaFile(event)">
                </label>
                <button class="btn btn-sm btn-outline-secondary" onclick="ripristinaBackupAutomatico()">
                    <i class="fas fa-history"></i> Ripristina Backup
                </button>
                <span class="ms-auto text-muted small" id="autoSaveStatus">
                    <i class="fas fa-circle text-success"></i> Auto-save attivo
                </span>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 1: DATI ANAGRAFICI E AMMISSIBILITÀ -->
            <!-- ============================================ -->
            <div id="view-1" class="view-section active">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-building"></i> Fase 1: Dati Anagrafici e Ammissibilità</h2>
                <p class="fase-subtitle">Inserimento dati completi dell'impresa e verifica requisiti di ammissibilità</p>
                
                <div class="alert-warning-custom">
                    <strong><i class="fas fa-exclamation-triangle"></i> Requisito Fondamentale:</strong>
                    L'unità produttiva deve essere attiva in Sicilia da almeno 1 anno alla data di presentazione della domanda.
                </div>
                
                <!-- Dati Impresa -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-building"></i> Dati Impresa</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label required">Ragione Sociale</label>
                            <input type="text" class="form-control" id="ragioneSociale" placeholder="Es: Esempio S.r.l.">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required">Partita IVA</label>
                            <input type="text" class="form-control" id="partitaIva" placeholder="IT12345678901" maxlength="13">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="codiceFiscale" placeholder="Codice Fiscale impresa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">PEC</label>
                            <input type="email" class="form-control" id="pec" placeholder="impresa@pec.it">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice ATECO Prevalente</label>
                            <input type="text" class="form-control" id="codiceAteco" placeholder="Es: 25.11.00">
                            <small class="text-muted">Esclusi settori: Agricoltura primaria, Pesca, Tabacco, ecc.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Dimensione Impresa</label>
                            <select class="form-select" id="dimensioneImpresa">
                                <option value="">-- Seleziona --</option>
                                <option value="micro">Microimpresa (< 10 dip., ≤ 2M€)</option>
                                <option value="piccola">Piccola Impresa (< 50 dip., ≤ 10M€)</option>
                                <option value="media">Media Impresa (< 250 dip., ≤ 50M€)</option>
                            </select>
                            <small class="text-muted">Grandi imprese escluse</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label required">Sede Legale (Indirizzo completo)</label>
                            <input type="text" class="form-control" id="sedeLegale" placeholder="Via, Numero Civico, CAP, Comune (Provincia)">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Anno Costituzione</label>
                            <input type="number" class="form-control" id="annoCostituzione" placeholder="Es: 2020" min="1900" max="2026">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Telefono</label>
                            <input type="tel" class="form-control" id="telefono" placeholder="+39 091 1234567">
                        </div>
                    </div>
                </div>
                
                <!-- Legale Rappresentante -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-user-tie"></i> Legale Rappresentante</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Nome</label>
                            <input type="text" class="form-control" id="lrNome" placeholder="Nome">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Cognome</label>
                            <input type="text" class="form-control" id="lrCognome" placeholder="Cognome">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="lrCF" placeholder="RSSMRA80A01H501X" maxlength="16">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Data di Nascita</label>
                            <input type="date" class="form-control" id="lrDataNascita">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Luogo di Nascita</label>
                            <input type="text" class="form-control" id="lrLuogoNascita" placeholder="Comune (Provincia)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Residenza</label>
                            <input type="text" class="form-control" id="lrResidenza" placeholder="Via, Numero, Comune (Provincia)">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label required">Qualità</label>
                            <select class="form-select" id="lrQualita">
                                <option value="">-- Seleziona --</option>
                                <option value="legale">Legale Rappresentante</option>
                                <option value="procuratore">Procuratore Speciale</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Sede dell'Intervento -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> Unità Produttiva Oggetto dell'Intervento</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Indirizzo Completo Unità Produttiva</label>
                        <input type="text" class="form-control" id="indirizzoIntervento" placeholder="Via, Numero Civico, CAP, Comune (Provincia)">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Coordinate Catastali</label>
                            <input type="text" class="form-control" id="coordinateCatastali" placeholder="Foglio, Particella, Sub">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Titolo di Disponibilità</label>
                            <select class="form-select" id="titoloDisponibilita">
                                <option value="">-- Seleziona --</option>
                                <option value="proprieta">Proprietà</option>
                                <option value="affitto">Affitto/Locazione</option>
                                <option value="impegno">Impegno all'acquisto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Estremi Titoli Autorizzativi Edificazione</label>
                        <textarea class="form-control" id="titoliAutorizzativi" rows="2" placeholder="Specificare titoli autorizzativi per l'edificazione"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Certificato di Agibilità</label>
                        <input type="text" class="form-control" id="certificatoAgibilita" placeholder="Estremi certificato di agibilità">
                    </div>
                </div>
                
                <!-- Checklist Requisiti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-tasks"></i> Verifica Requisiti di Ammissibilità</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_unitaAttiva">
                            <label class="form-check-label" for="req_unitaAttiva">
                                <strong>Unità Produttiva Attiva:</strong> L'unità locale è censita come attiva in visura camerale da almeno 1 anno
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_diagnosiEnergetica">
                            <label class="form-check-label" for="req_diagnosiEnergetica">
                                <strong>Diagnosi Energetica:</strong> È disponibile una Diagnosi Energetica ex-ante (UNI CEI EN 16247) basata sui consumi reali degli ultimi 2 anni
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_durc">
                            <label class="form-check-label" for="req_durc">
                                <strong>DURC Regolare:</strong> In regola con gli obblighi contributivi previdenziali e assistenziali
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_antimafia">
                            <label class="form-check-label" for="req_antimafia">
                                <strong>Normativa Antimafia:</strong> Assenza cause ostative antimafia
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_dnsh">
                            <label class="form-check-label" for="req_dnsh">
                                <strong>Principio DNSH:</strong> L'attività non arreca danno significativo all'ambiente (es. no caldaie a gas fossile)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_capacitaEconomica">
                            <label class="form-check-label" for="req_capacitaEconomica">
                                <strong>Capacità Economico-Finanziaria:</strong> Disponibilità Allegato D.1 o D.2 che copre la quota non agevolata
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_capacitaOperativa">
                            <label class="form-check-label" for="req_capacitaOperativa">
                                <strong>Capacità Operativa:</strong> Possesso delle competenze e qualifiche professionali necessarie
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noSanzioni">
                            <label class="form-check-label" for="req_noSanzioni">
                                <strong>Assenza Sanzioni:</strong> Non destinatario di sanzioni interdittive ex D.Lgs. 231/2001
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noDifficolta">
                            <label class="form-check-label" for="req_noDifficolta">
                                <strong>Non in Difficoltà:</strong> Non in condizioni di difficoltà ex art. 2 Reg. 651/2014
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="req_noRevoche">
                            <label class="form-check-label" for="req_noRevoche">
                                <strong>Assenza Revoche:</strong> Non destinatario di revoche negli ultimi 3 anni
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(2)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 2: CALCOLO MOL E DIMENSIONE AZIENDALE -->
            <!-- ============================================ -->
            <div id="view-2" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-calculator"></i> Fase 2: Calcolo MOL e Dimensione Aziendale</h2>
                <p class="fase-subtitle">Dichiarazione sostitutiva MOL e determinazione classe dimensionale (Criterio Ordinatore)</p>
                
                <div class="alert-info-custom">
                    <strong><i class="fas fa-info-circle"></i> Nota Importante:</strong>
                    L'allegato deve essere asseverato da Commercialista/Revisore/CAF e firmato digitalmente.
                </div>
                
                <!-- Dati Contabili MOL -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-file-invoice-dollar"></i> Dati Contabili per Calcolo MOL</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Anno di Riferimento</label>
                            <input type="number" class="form-control" id="annoRiferimento" placeholder="Es: 2024" min="2020" max="2026">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Tipo Documento</label>
                            <select class="form-select" id="tipoDocumento">
                                <option value="">-- Seleziona --</option>
                                <option value="bilancio">Ultimo Bilancio Approvato</option>
                                <option value="unico">Ultima Dichiarazione Unico</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">A) Valore della Produzione (€)</label>
                        <input type="number" class="form-control" id="valoreProduzione" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <h5 class="mt-4 mb-3">Costi della Produzione (Voce B Conto Economico)</h5>
                    
                    <div class="mb-3">
                        <label class="form-label required">Materie prime, sussidiarie, di consumo e merci (€)</label>
                        <input type="number" class="form-control" id="materiePrime" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Costi dei servizi (€)</label>
                        <input type="number" class="form-control" id="costiServizi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Costi godimento beni di terzi (€)</label>
                        <input type="number" class="form-control" id="costiBeniTerzi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Spese per il personale (€)</label>
                        <input type="number" class="form-control" id="spesePersonale" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Variazioni delle rimanenze (€)</label>
                        <input type="number" class="form-control" id="variazioniRimanenze" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                        <small class="text-muted">Inserire con segno algebrico (+ se incremento, - se decremento)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Oneri diversi di gestione (€)</label>
                        <input type="number" class="form-control" id="oneriDiversi" step="0.01" placeholder="0.00" onchange="calcolaMOL()">
                    </div>
                    
                    <div class="result-box">
                        <h4><i class="fas fa-chart-line"></i> MOL (Margine Operativo Lordo) Calcolato</h4>
                        <div class="result-item">
                            <span class="result-label">Formula: Valore Produzione - Costi Produzione</span>
                            <span class="result-value" id="molCalcolato">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Totale Costi Produzione</span>
                            <span class="result-value" id="totaleCosti">€ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Budget Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Budget Progetto</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Costo Totale Investimento (€)</label>
                        <input type="number" class="form-control" id="costoTotaleInvestimento" step="0.01" placeholder="0.00" onchange="calcolaIndicatoreOrdinatore()">
                        <small class="text-muted">Minimo: € 50.000,00 | Massimo: € 500.000,00</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Contributo Richiesto (€)</label>
                        <input type="number" class="form-control" id="contributoRichiesto" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Scelta Regime di Aiuto</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="regimeAiuto" id="regime_deminimis" value="deminimis">
                            <label class="form-check-label" for="regime_deminimis">
                                <strong>De Minimis (Reg. 2023/2831):</strong> Max 60% a fondo perduto (Cap € 300.000 su 3 anni)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="regimeAiuto" id="regime_esenzione" value="esenzione">
                            <label class="form-check-label" for="regime_esenzione">
                                <strong>Esenzione (Reg. 651/2014 Art. 14):</strong> Micro/Piccole: Max 60% | Medie: Max 50%
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Criterio Ordinatore -->
                <div class="punteggio-box">
                    <h4 class="text-center mb-3"><i class="fas fa-trophy"></i> INDICATORE ORDINATORE (Ranking)</h4>
                    <div class="result-item">
                        <span class="result-label">Formula: MOL / Costo Totale Investimento</span>
                        <span class="result-value" id="indicatoreOrdinatore">0,00000</span>
                    </div>
                    <div class="punteggio-totale mt-3" id="punteggioOrdinatore">
                        0,00000
                    </div>
                    <p class="text-center text-muted mb-0">Maggiore è il valore, migliore è la posizione in graduatoria</p>
                </div>
                
                <!-- Dimensione Aziendale -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-chart-bar"></i> Dimensione Aziendale e Parametri Finanziari</h3>
                    
                    <p><strong>Anno di riferimento ultimo bilancio:</strong> <span id="annoRefDimensione">-</span></p>
                    
                    <table class="table table-sm table-bordered table-small">
                        <thead>
                            <tr>
                                <th>Tipologia Impresa</th>
                                <th>N. Occupati (ULA)</th>
                                <th>Fatturato (M€)</th>
                                <th>Totale Bilancio (M€)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Dichiarante</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_dichiarante" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr>
                                <td><strong>Associate</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_associate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr>
                                <td><strong>Collegate</strong></td>
                                <td><input type="number" class="form-control form-control-sm" id="ula_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="fatturato_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                                <td><input type="number" class="form-control form-control-sm" id="bilancio_collegate" step="0.01" placeholder="0.00" onchange="calcolaTotaliDimensione()"></td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>TOTALE</strong></td>
                                <td><strong><span id="totale_ula">0.00</span></strong></td>
                                <td><strong><span id="totale_fatturato">0.00</span></strong></td>
                                <td><strong><span id="totale_bilancio">0.00</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-info mt-3">
                        <strong>Tipo di Impresa:</strong>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_autonoma" value="autonoma">
                            <label class="form-check-label" for="tipo_autonoma">Autonoma</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_associata" value="associata">
                            <label class="form-check-label" for="tipo_associata">Associata</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoImpresa" id="tipo_collegata" value="collegata">
                            <label class="form-check-label" for="tipo_collegata">Collegata</label>
                        </div>
                    </div>
                </div>
                
                <!-- Composizione Sociale -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-users"></i> Composizione Sociale</h3>
                    
                    <button class="btn btn-sm btn-success mb-3" onclick="aggiungiSocio()">
                        <i class="fas fa-plus"></i> Aggiungi Socio
                    </button>
                    
                    <div id="listaSoci">
                        <p class="text-muted">Nessun socio inserito</p>
                    </div>
                </div>
                
                <!-- Aiuti De Minimis (se regime selezionato) -->
                <div class="form-section" id="sezioneDeMinimis" style="display:none;">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Aiuti De Minimis Ricevuti (ultimi 3 anni)</h3>
                    
                    <button class="btn btn-sm btn-primary mb-3" onclick="aggiungiAiuto()">
                        <i class="fas fa-plus"></i> Aggiungi Aiuto
                    </button>
                    
                    <div id="listaAiuti">
                        <p class="text-muted">Nessun aiuto de minimis dichiarato</p>
                    </div>
                    
                    <div class="result-box mt-3">
                        <div class="result-item">
                            <span class="result-label">Totale Aiuti De Minimis Ricevuti (ultimi 3 anni)</span>
                            <span class="result-value" id="totaleDeMinimis">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Contributo Richiesto</span>
                            <span class="result-value" id="contributoRichiestoRiepilogo">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Totale Cumulato</span>
                            <span class="result-value" id="totaleCumulato">€ 0,00</span>
                        </div>
                        <div class="alert alert-warning mt-2 mb-0" id="alertDeMinimis" style="display:none;">
                            <strong>⚠️ ATTENZIONE:</strong> Il totale cumulato supera il massimale di € 300.000!
                        </div>
                    </div>
                </div>
                
                <!-- Professionista Asseverante -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-user-check"></i> Professionista Asseverante</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Tipo Professionista</label>
                            <select class="form-select" id="tipoProfessionista">
                                <option value="">-- Seleziona --</option>
                                <option value="commercialista">Dottore Commercialista</option>
                                <option value="revisore">Revisore Legale</option>
                                <option value="caf">CAF</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Nome e Cognome/Denominazione</label>
                            <input type="text" class="form-control" id="nomeProfessionista" placeholder="Nome completo o denominazione">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Codice Fiscale</label>
                            <input type="text" class="form-control" id="cfProfessionista" placeholder="Codice Fiscale" maxlength="16">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Iscrizione Albo</label>
                            <input type="text" class="form-control" id="iscrizioneAlbo" placeholder="N. iscrizione e sede">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Sede Studio/Ufficio</label>
                        <input type="text" class="form-control" id="sedeProfessionista" placeholder="Indirizzo completo">
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(3)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 3: DIAGNOSI ENERGETICA E PREVENTIVI -->
            <!-- ============================================ -->
            <div id="view-3" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-chart-bar"></i> Fase 3: Diagnosi Energetica & Preventivi</h2>
                <p class="fase-subtitle">Inserimento dati diagnosi energetica e gestione preventivi per categoria</p>
                
                <!-- Dati da Diagnosi -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-thermometer-half"></i> Dati da Diagnosi Energetica (Obbligatori)</h3>
                    
                    <div class="alert-info-custom">
                        <strong><i class="fas fa-info-circle"></i> Importante:</strong>
                        Questi dati derivano dalla Diagnosi Energetica (UNI CEI EN 16247) e sono fondamentali per il calcolo dei punteggi.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">EPgl,nren Ante-operam (kWh/m²a)</label>
                            <input type="number" class="form-control" id="epgl_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">EPgl,nren Post-operam (kWh/m²a)</label>
                            <input type="number" class="form-control" id="epgl_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Emissioni CO2 Ante (t/anno)</label>
                            <input type="number" class="form-control" id="co2_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Emissioni CO2 Post (t/anno)</label>
                            <input type="number" class="form-control" id="co2_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Energia da Rinnovabili (FER) Ante (kWh)</label>
                            <input type="number" class="form-control" id="fer_ante" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Energia da Rinnovabili (FER) Post (kWh)</label>
                            <input type="number" class="form-control" id="fer_post" step="0.01" placeholder="0.00" onchange="calcolaRiduzioniEnergetiche()">
                        </div>
                    </div>
                    
                    <!-- Risultati Calcoli -->
                    <div class="result-box">
                        <h4><i class="fas fa-chart-pie"></i> Riduzioni Calcolate Automaticamente</h4>
                        <div class="result-item">
                            <span class="result-label">Risparmio Energetico EPgl,nren</span>
                            <span class="result-value" id="risparmioEnergetico">0,00%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Riduzione CO2</span>
                            <span class="result-value" id="riduzioneCO2">0,00%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Incremento FER</span>
                            <span class="result-value" id="incrementoFER">0,00%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gestione Preventivi -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-receipt"></i> Gestione Preventivi</h3>
                    
                    <button class="btn btn-success mb-3" onclick="mostraFormPreventivo()">
                        <i class="fas fa-plus"></i> Aggiungi Preventivo
                    </button>
                    
                    <!-- Form Nuovo Preventivo -->
                    <div id="formPreventivo" style="display:none;" class="mb-4 p-3 border rounded bg-light">
                        <h5>Nuovo Preventivo</h5>
                        
                        <div class="mb-3">
                            <label class="form-label required">Categoria</label>
                            <select class="form-select" id="nuovoPreventivo_categoria" onchange="aggiornaHelpCategoria()">
                                <option value="">-- Seleziona Categoria --</option>
                                <option value="cat_a">CATEGORIA A - Efficientamento Processi Produttivi</option>
                                <option value="cat_b">CATEGORIA B - Efficientamento Edifici</option>
                                <option value="cat_c">CATEGORIA C - Sostituzione Macchinari</option>
                                <option value="cat_d">CATEGORIA D - Energie Rinnovabili (Autoconsumo)</option>
                            </select>
                            <small class="text-muted" id="helpCategoria"></small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Descrizione Intervento</label>
                            <textarea class="form-control" id="nuovoPreventivo_descrizione" rows="2" placeholder="Descrizione dettagliata dell'intervento"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Fornitore</label>
                            <input type="text" class="form-control" id="nuovoPreventivo_fornitore" placeholder="Ragione sociale fornitore">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">Importo (€)</label>
                            <input type="number" class="form-control" id="nuovoPreventivo_importo" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="aggiungiPreventivo()">
                                <i class="fas fa-check"></i> Conferma
                            </button>
                            <button class="btn btn-secondary" onclick="nascondiFormPreventivo()">
                                <i class="fas fa-times"></i> Annulla
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista Preventivi -->
                    <div id="listaPreventivi">
                        <p class="text-muted">Nessun preventivo inserito</p>
                    </div>
                    
                    <!-- Totale Preventivi -->
                    <div class="result-box">
                        <h4><i class="fas fa-calculator"></i> Riepilogo Spese per Categoria</h4>
                        <div class="result-item">
                            <span class="result-label">Categoria A - Processi Produttivi</span>
                            <span class="result-value" id="totale_cat_a">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria B - Edifici</span>
                            <span class="result-value" id="totale_cat_b">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria C - Macchinari</span>
                            <span class="result-value" id="totale_cat_c">€ 0,00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Categoria D - Rinnovabili</span>
                            <span class="result-value" id="totale_cat_d">€ 0,00</span>
                        </div>
                        <hr>
                        <div class="result-item">
                            <span class="result-label"><strong>TOTALE INVESTIMENTI</strong></span>
                            <span class="result-value" id="totaleInvestimenti" style="font-size:1.3rem;">€ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Spese Accessorie -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-tools"></i> Spese Accessorie</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Opere Murarie/Edili (€)</label>
                            <input type="number" class="form-control" id="opereMurarie" step="0.01" placeholder="0.00" onchange="validaSpeseAccessorie()">
                            <small class="text-muted">Max 20% del totale investimenti</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Spese Tecniche (€)</label>
                            <input type="number" class="form-control" id="speseTecniche" step="0.01" placeholder="0.00" onchange="validaSpeseAccessorie()">
                            <small class="text-muted">Progettazione, Diagnosi, APE, Sicurezza - Max 10% del totale</small>
                        </div>
                    </div>
                    
                    <div id="alertSpeseAccessorie"></div>
                </div>
                
                <!-- Validazione Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-check-double"></i> Validazione Automatica Progetto</h3>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_riduzioneCO2" style="color:#6c757d;"></i>
                            <span><strong>Riduzione CO2:</strong> ≥ 30% rispetto all'ex-ante?</span>
                            <span class="ms-auto badge bg-secondary" id="badge_riduzioneCO2">Da verificare</span>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_risparmioEnergetico" style="color:#6c757d;"></i>
                            <span><strong>Risparmio Energetico:</strong> Miglioramento verificato?</span>
                            <span class="ms-auto badge bg-secondary" id="badge_risparmioEnergetico">Da verificare</span>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle me-2" id="icon_caldaieFossili" style="color:#28a745;"></i>
                            <span><strong>Caldaie Fossili:</strong> Assenti nel progetto?</span>
                            <span class="ms-auto badge bg-success" id="badge_caldaieFossili">Conforme</span>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(4)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 4: ISTANZA DI FINANZIAMENTO -->
            <!-- ============================================ -->
            <div id="view-4" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-signature"></i> Fase 4: Istanza di Finanziamento (Allegato 2.1.A)</h2>
                <p class="fase-subtitle">Dichiarazioni obbligatorie ai sensi dell'Art. 47 DPR 445/2000</p>
                
                <div class="alert-danger-custom">
                    <strong><i class="fas fa-exclamation-triangle"></i> Attenzione:</strong>
                    Le dichiarazioni devono essere confermate sotto la propria responsabilità. False dichiarazioni comportano sanzioni penali ex art. 76 DPR 445/2000.
                </div>
                
                <!-- Marca da Bollo -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-stamp"></i> Marca da Bollo</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Numero Marca da Bollo</label>
                            <input type="text" class="form-control" id="numeroMarcaBollo" placeholder="Numero identificativo marca">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Data Annullamento</label>
                            <input type="date" class="form-control" id="dataMarcaBollo">
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Importo:</strong> € 16,00 - La marca da bollo deve essere annullata e allegata
                    </div>
                </div>
                
                <!-- DICHIARAZIONI PRINCIPALI -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-list-check"></i> Dichiarazioni Principali</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_requisiti">
                            <label class="form-check-label" for="dich_requisiti">
                                <strong>1. Requisiti di Ammissibilità:</strong> Disporre dei requisiti di ammissibilità di cui ai parr. 2.1 e 2.2 dell'Avviso
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_durc">
                            <label class="form-check-label" for="dich_durc">
                                <strong>2. DURC:</strong> Essere in regola con gli obblighi relativi al pagamento dei contributi previdenziali e assistenziali (DURC regolare)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_antimafia">
                            <label class="form-check-label" for="dich_antimafia">
                                <strong>3. Antimafia:</strong> Essere in regola con la normativa antimafia
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_capacitaEconomica">
                            <label class="form-check-label" for="dich_capacitaEconomica">
                                <strong>4. Capacità Economico-Finanziaria:</strong> Possedere la capacità economico-finanziaria documentata mediante Allegato D.1 o D.2
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_sostenibilita">
                            <label class="form-check-label" for="dich_sostenibilita">
                                <strong>5. Sostenibilità Finanziaria:</strong> Disporre delle risorse per coprire i costi di gestione e manutenzione (ex art. 73.2, lett. d) Reg. UE 2021/1060)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_capacitaOperativa">
                            <label class="form-check-label" for="dich_capacitaOperativa">
                                <strong>6. Capacità Operativa:</strong> Possedere capacità operativa e amministrativa necessaria alla realizzazione dell'intervento
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noSanzioni">
                            <label class="form-check-label" for="dich_noSanzioni">
                                <strong>7. Assenza Sanzioni:</strong> Possedere la capacità di contrarre con la P.A. (non destinatario di sanzioni interdittive ex art. 9 D.Lgs. 231/2001)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_sedeSicilia">
                            <label class="form-check-label" for="dich_sedeSicilia">
                                <strong>8. Sede in Sicilia:</strong> Avere sede o unità produttiva locale nel territorio regionale (o comunicare l'apertura al primo pagamento)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_ateco">
                            <label class="form-check-label" for="dich_ateco">
                                <strong>9. Codice ATECO:</strong> Esercitare un'attività con codice ATECO ammissibile (non escluso da Reg. 2023/2831 e Reg. 2021/1058)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_iscrizione">
                            <label class="form-check-label" for="dich_iscrizione">
                                <strong>10. Iscrizioni:</strong> Essere regolarmente iscritto a CCIAA/REA/Albo professionale/Gestione INPS (secondo fattispecie)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDifficolta">
                            <label class="form-check-label" for="dich_noDifficolta">
                                <strong>11. Non in Difficoltà:</strong> Non trovarsi in condizioni di difficoltà ex art. 2, punto 18 Reg. 651/2014
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noCollegamento">
                            <label class="form-check-label" for="dich_noCollegamento">
                                <strong>12. Assenza Collegamento:</strong> Non risultare associato o collegato con altra impresa richiedente nell'aggregazione
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noRevoche">
                            <label class="form-check-label" for="dich_noRevoche">
                                <strong>13. Assenza Revoche:</strong> Non destinatario di revoche negli ultimi 3 anni per violazioni gravi
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noCondanne">
                            <label class="form-check-label" for="dich_noCondanne">
                                <strong>14. Assenza Condanne:</strong> Non condannato con sentenza passata in giudicato per reati gravi in danno dello Stato
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_contrattiLavoro">
                            <label class="form-check-label" for="dich_contrattiLavoro">
                                <strong>15. Contratti di Lavoro:</strong> Osservare gli obblighi dei contratti collettivi e rispettare le normative su sicurezza, pari opportunità, tutela ambiente
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_urbanistica">
                            <label class="form-check-label" for="dich_urbanistica">
                                <strong>16. Normativa Urbanistica:</strong> Rispettare le vigenti normative urbanistiche e di tutela paesaggistica
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDoppioFinanziamento">
                            <label class="form-check-label" for="dich_noDoppioFinanziamento">
                                <strong>17. No Doppio Finanziamento:</strong> Non avere usufruito di altri finanziamenti pubblici per le stesse spese
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_impresaAttiva">
                            <label class="form-check-label" for="dich_impresaAttiva">
                                <strong>18. Impresa Attiva:</strong> Essere impresa attiva al momento della presentazione della domanda
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_36mesi">
                            <label class="form-check-label" for="dich_36mesi">
                                <strong>19. Anzianità:</strong> Essere costituita come impresa da almeno 36 mesi
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_noDelocalizzazione">
                            <label class="form-check-label" for="dich_noDelocalizzazione">
                                <strong>20. No Delocalizzazione:</strong> Non avere delocalizzato nei 2 anni precedenti e impegno a non delocalizzare nei 2 anni successivi
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Dichiarazioni Specifiche De Minimis -->
                <div class="form-section" id="sezioneDeMinimisIstanza" style="display:none;">
                    <h3 class="form-section-title"><i class="fas fa-euro-sign"></i> Dichiarazioni De Minimis</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_consapevoleDeMinimis">
                            <label class="form-check-label" for="dich_consapevoleDeMinimis">
                                <strong>Consapevolezza Reg. 2023/2831:</strong> Preso atto del Regolamento UE n. 2023/2831 "de minimis"
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dich_impresaUnica">
                            <label class="form-check-label" for="dich_impresaUnica">
                                <strong>Impresa Unica:</strong> Dichiarazione su imprese collegate a monte e a valle nell'ambito del concetto di "impresa unica"
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Impegni -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-handshake"></i> Impegni</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_cumulo">
                            <label class="form-check-label" for="imp_cumulo">
                                <strong>No Cumulo:</strong> Impegno a non cumulare il presente aiuto con altri aiuti di Stato (es. Credito d'imposta ZES) per le stesse spese
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_dnsh">
                            <label class="form-check-label" for="imp_dnsh">
                                <strong>DNSH:</strong> Impegno al rispetto del principio "Non arrecare danno significativo" (Do No Significant Harm)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="imp_climateProofing">
                            <label class="form-check-label" for="imp_climateProofing">
                                <strong>Climate Proofing:</strong> Verifica di resilienza climatica effettuata per investimenti con vita utile superiore a 5 anni
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Riepilogo Domanda -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-file-alt"></i> Riepilogo Domanda</h3>
                    
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Impresa:</strong></td>
                            <td><span id="recap_ragioneSociale">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>P.IVA:</strong></td>
                            <td><span id="recap_partitaIva">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>Dimensione:</strong></td>
                            <td><span id="recap_dimensione">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>Investimento Totale:</strong></td>
                            <td><span id="recap_investimento">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Contributo Richiesto:</strong></td>
                            <td><span id="recap_contributo">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Regime Aiuto:</strong></td>
                            <td><span id="recap_regime">-</span></td>
                        </tr>
                        <tr>
                            <td><strong>MOL:</strong></td>
                            <td><span id="recap_mol">€ 0,00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Indicatore Ordinatore:</strong></td>
                            <td><span id="recap_ordinatore">0,00000</span></td>
                        </tr>
                    </table>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(3)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(5)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 5: FORMULARIO DI PROGETTO (Allegato F) -->
            <!-- ============================================ -->
            <div id="view-5" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-alt"></i> Fase 5: Formulario di Progetto (Allegato F)</h2>
                <p class="fase-subtitle">Descrizione completa del programma di investimenti e calcolo punteggi tecnici</p>
                
                <!-- SEZIONE A: Informazioni Generali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Sezione A - Informazioni Generali</h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label required">1.1 Titolo del Progetto</label>
                            <input type="text" class="form-control" id="titoloProgetto" placeholder="Inserire titolo descrittivo del progetto">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">1.2 Acronimo</label>
                            <input type="text" class="form-control" id="acronimoProgetto" placeholder="Es: EFFI-2025">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">1.3 Durata Progetto (mesi)</label>
                            <input type="number" class="form-control" id="durataProgetto" min="1" max="24" placeholder="Max 24 mesi">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">1.4 Costo Totale Ammissibile (€)</label>
                            <input type="number" class="form-control" id="costoTotaleFormulario" step="0.01" readonly>
                            <small class="text-muted">Calcolato automaticamente dai preventivi</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">1.7 Breve Presentazione Soggetto Proponente (Mission e Attività)</label>
                        <textarea class="form-control" id="missionAttivita" rows="4" placeholder="Descrivere brevemente mission aziendale e principali attività"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE B: Descrizione Soggetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-building"></i> Sezione B - Descrizione Soggetto Proponente</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">Descrivere sinteticamente l'attività economica svolta</label>
                        <textarea class="form-control" id="attivitaEconomica" rows="4" placeholder="Settore di attività, prodotti/servizi offerti, mercati di riferimento"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE C: Fabbisogni Energetici -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-fire"></i> Sezione C - Fabbisogni di Efficientamento Energetico</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">C.1 Contestualizzazione dei Fabbisogni</label>
                        <textarea class="form-control" id="contestualizzazioneFabbisogni" rows="5" placeholder="Descrivere: 1) Unità produttiva interessata e titoli autorizzativi; 2) Attuali modalità di approvvigionamento energetico; 3) Stato dell'arte innovazioni tecnologiche nel settore; 4) Principali fabbisogni di efficientamento"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">C.2 Descrizione Obiettivi Perseguiti</label>
                        <textarea class="form-control" id="obiettiviPerseguiti" rows="5" placeholder="Descrivere e quantificare: 1) Contributo alla riduzione emissioni CO2; 2) Riduzione consumi energetici ed eventuale passaggio di classe; 3) Incremento energia da FER; 4) Impatti attesi sull'attività economica; 5) Vantaggio competitivo"></textarea>
                    </div>
                    
                    <h5 class="mt-4">Obiettivi Specifici Interventi</h5>
                    
                    <p class="text-muted mb-3">Selezionare tutti gli obiettivi pertinenti al progetto. Questa sezione deve descrivere in modo chiaro e dettagliato le finalità specifiche degli interventi previsti.</p>
                    
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <strong class="d-block mb-2">a) Riqualificazione energetica impianti produttivi e/o per l'erogazione di servizi:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_rifasamento">
                                <label class="form-check-label" for="obiettivo_rifasamento">
                                    Rifasamento elettrico
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_motori">
                                <label class="form-check-label" for="obiettivo_motori">
                                    Motori, pompe, inverter, compressori ad alta efficienza
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_coibentazioni">
                                <label class="form-check-label" for="obiettivo_coibentazioni">
                                    Coibentazioni compatibili con le esigenze produttive
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_recuperoCalore">
                                <label class="form-check-label" for="obiettivo_recuperoCalore">
                                    Recupero calore da processi produttivi
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_vapore">
                                <label class="form-check-label" for="obiettivo_vapore">
                                    Ottimizzazione ciclo vapore
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_caldaie">
                                <label class="form-check-label" for="obiettivo_caldaie">
                                    Caldaie a gas condensazione / Pompe di calore
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_buildingAutomation">
                                <label class="form-check-label" for="obiettivo_buildingAutomation">
                                    Building automation e sistemi di controllo smart
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <strong class="d-block mb-2">b) Riqualificazione energetica edifici aziendali:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_cappotto">
                                <label class="form-check-label" for="obiettivo_cappotto">
                                    Isolamento involucro (cappotto termico)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_serramenti">
                                <label class="form-check-label" for="obiettivo_serramenti">
                                    Sostituzione serramenti e infissi
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_led">
                                <label class="form-check-label" for="obiettivo_led">
                                    Efficientamento illuminazione (LED)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_climatizzazionePassiva">
                                <label class="form-check-label" for="obiettivo_climatizzazionePassiva">
                                    Sistemi di climatizzazione passiva
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <strong class="d-block mb-2">c) Impianti FER (Fonti Energia Rinnovabile) per autoconsumo:</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_fotovoltaico">
                                <label class="form-check-label" for="obiettivo_fotovoltaico">
                                    Fotovoltaico con/senza sistema di accumulo
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_solarTermico">
                                <label class="form-check-label" for="obiettivo_solarTermico">
                                    Solare termico / Solare termodinamico
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="obiettivo_cogenerazione">
                                <label class="form-check-label" for="obiettivo_cogenerazione">
                                    Cogenerazione / Trigenerazione
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- SEZIONE D: Sistemi Monitoraggio Attuali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-chart-line"></i> Sezione D - Attuali Sistemi di Monitoraggio</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">D.1 Strutture e Strumenti Attuali per Monitoraggio Consumi</label>
                        <textarea class="form-control" id="struttureMonitoraggio" rows="3" placeholder="Descrivere eventuali sistemi già disponibili per monitoraggio consumi energetici ed emissioni CO2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">D.2 Figure Professionali (Energy Manager/EGE)</label>
                        <textarea class="form-control" id="figureEnergyManager" rows="3" placeholder="Indicare presenza Energy Manager/EGE con certificazioni e descrivere modalità di monitoraggio/razionalizzazione"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE E: Descrizione Progetto -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-tasks"></i> Sezione E - Descrizione Dettagliata Progetto</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">E.1 Descrizione Tecnica Interventi</label>
                        <textarea class="form-control" id="descrizioneTecnica" rows="6" placeholder="Descrivere dettagliatamente il processo di implementazione delle soluzioni tecnologiche per ciascun obiettivo, con evidenza delle fasi principali e risultati attesi"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">E.2 Maturità Progettuale (Cantierabilità)</label>
                        <textarea class="form-control" id="maturitaProgettuale" rows="4" placeholder="Descrivere iter amministrativo necessario, titoli autorizzativi richiesti e tempistiche conseguimento/rilascio"></textarea>
                        
                        <div class="mt-3">
                            <label class="form-label required">Stato Autorizzativo</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_immediata" value="15" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_immediata">
                                    <strong>Cantierabilità Immediata</strong> (SCIA/CILA/Nessuna autorizzazione) - <span class="text-success">15 Punti</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_60gg" value="8" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_60gg">
                                    <strong>Ottenibile in 60 gg</strong> - <span class="text-warning">8 Punti</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cantierabilita" id="cant_90gg" value="3" onchange="calcolaPunteggi()">
                                <label class="form-check-label" for="cant_90gg">
                                    <strong>Ottenibile in 90 gg</strong> - <span class="text-danger">3 Punti</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                                        
                    
                    <!-- SEZIONE E.3: PIANO DI LAVORO E CRONOPROGRAMMA -->
                    <div class="mb-3">
                        <h5><i class="fas fa-tasks"></i> E.3 Piano di Lavoro e Cronoprogramma</h5>
                        <p class="text-muted">Dettagliare il piano di lavoro con obiettivi, work package, deliverable e milestone temporali</p>
                    </div>
                    
                    <!-- <div class="mb-3">
                                    <button type="button" class="btn btn-success" onclick="compilaAutomaticaWP()">
                                        <i class="fas fa-magic"></i> Genera Automaticamente Piano di Lavoro e Cronoprogramma
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-info-circle"></i> Il sistema genererà automaticamente WP e cronoprogramma basandosi sui preventivi inseriti nella Fase 3
                                    </small>
                                </div>
                                
                                <h6 class="fw-bold mb-3 mt-4">TABELLA 1: PIANO DI LAVORO -->
                    <h5 class="mt-4 mb-3">Tabella 1 - Piano di Lavoro</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Ob. Gen.</th>
                                    <th>Ob. Spec.</th>
                                    <th>WP</th>
                                    <th>Azioni/Task</th>
                                    <th>Deliverable</th>
                                    <th>Output/Risultati Attesi</th>
                                    <th>Budget Allocato (€)</th>
                                    <th>Indicatori (KPI)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabellaWP">
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        <em>Nessun work package inserito. Usa il bottone qui sotto per aggiungere.</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="aggiungiRigaWP()">
                            <i class="fas fa-plus"></i> Aggiungi Work Package
                        </button>
                    </div>
                    
                    <!-- TABELLA 2: CRONOPROGRAMMA -->
                    <h5 class="mt-4 mb-3">Tabella 2 - Cronoprogramma</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>WP/Task</th>
                                    <th>M1</th>
                                    <th>M2</th>
                                    <th>M3</th>
                                    <th>M4</th>
                                    <th>M5</th>
                                    <th>M6</th>
                                    <th>M7</th>
                                    <th>M8</th>
                                    <th>M9</th>
                                    <th>M10</th>
                                    <th>M11</th>
                                    <th>M12</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabellaCrono">
                                <tr>
                                    <td colspan="14" class="text-center text-muted">
                                        <em>Nessuna attività inserita. Usa il bottone qui sotto per aggiungere.</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="aggiungiRigaCrono()">
                            <i class="fas fa-plus"></i> Aggiungi Attività
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Legenda Milestones</label>
                        <textarea class="form-control" id="legendaMilestones" rows="3" placeholder="1. Milestone 1: Descrizione&#10;2. Milestone 2: Descrizione&#10;..."></textarea>
                    </div>

<div class="mb-3">
                        <label class="form-label">E.3 Piano di Lavoro e Cronoprogramma</label>
                        <textarea class="form-control" id="cronoprogramma" rows="4" placeholder="Descrivere piano di lavoro con WP/Task e milestones associate"></textarea>
                    </div>
                </div>
                
                <!-- SEZIONE F: Monitoraggio Post-Investimento -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-cogs"></i> Sezione F - Gestione Monitoraggio e Manutenzione Post-Investimento</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">F.1 Sistema di Monitoraggio Previsto</label>
                        <textarea class="form-control" id="sistemaMonitoraggio" rows="4" placeholder="Descrivere: 1) Struttura organizzativa responsabile; 2) Sistemi di misurazione consumi da installare; 3) Processi raccolta dati e reporting; 4) Procedure manutenzione impianti"></textarea>
                    </div>
                    
                    <h5 class="mt-4">Sistemi Smart/IoT Previsti (CdV_4 - Max 6 pt)</h5>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema1" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema1">
                            Sistema di monitoraggio base (es. sensori temperatura/umidità) - 1 pt
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema2" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema2">
                            Sistema IoT avanzato (es. building automation, gestione carichi) - +2 pt se combinato
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mon_sistema3" onchange="calcolaPunteggi()">
                        <label class="form-check-label" for="mon_sistema3">
                            Sistema recupero/accumulo energia (es. batterie, accumulo termico) - Totale 6 pt se tutti presenti
                        </label>
                    </div>
                    
                    <div class="result-box mt-3">
                        <div class="result-item">
                            <span class="result-label">Punteggio Monitoraggio (Criterio 4)</span>
                            <span class="result-value" id="p_monitoraggio">0 pt</span>
                        </div>
                    </div>
                </div>
                
                <!-- SEZIONE G: Criteri Premiali -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-trophy"></i> Sezione G - Criteri Premiali (Max 6 pt)</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">G.1 Energy Manager/EGE con Certificazioni</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prem_energyManager" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="prem_energyManager">
                                Presenza Energy Manager/EGE certificato (es. SECEM/FIRE, UNI CEI 11339:2023) o ISO 50001 - <strong>+3 pt</strong>
                            </label>
                        </div>
                        <textarea class="form-control mt-2" id="dettagliEnergyManager" rows="2" placeholder="Se sì, riportare estremi identificativi e qualificazioni/certificazioni"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">G.2 Sistemi Avanzati di Misura Consumi</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prem_sistemiMisura" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="prem_sistemiMisura">
                                Sistemi avanzati con sensori intelligenti, IoT, AI per ottimizzazione automatica - <strong>+3 pt</strong>
                            </label>
                        </div>
                        <textarea class="form-control mt-2" id="dettagliSistemiMisura" rows="2" placeholder="Se sì, descrivere i sistemi avanzati da implementare"></textarea>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-item">
                            <span class="result-label">Punteggio Premialità Totale</span>
                            <span class="result-value" id="p_premialita">0 pt</span>
                        </div>
                    </div>
                </div>
                
                <!-- SEZIONE H: Budget e Criteri di Valutazione -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-calculator"></i> Sezione H - Budget e Punteggi Tecnici</h3>
                    
                    <div class="mb-3">
                        <label class="form-label required">H.1 Illustrazione Budget per Categorie di Spesa</label>
                        <textarea class="form-control" id="illustrazioneBudget" rows="4" placeholder="Illustrare il budget con puntuale indicazione prospetto analitico costi in coerenza con preventivi allegati"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">H.2 Piano Coperture Finanziarie</label>
                        <textarea class="form-control" id="pianoCoperture" rows="3" placeholder="Dettagliare fonti di finanziamento: contributo richiesto, cofinanziamenti, altre fonti con importi e percentuali"></textarea>
                    </div>
                    
                                        
                    <!-- TABELLA 3: PIANO FINANZIARIO INVESTIMENTI -->
                    <h5 class="mt-4 mb-3">Tabella 3 - Piano Finanziario degli Investimenti</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%;">Tipologia di Spesa</th>
                                    <th>Costo Totale Ammissibile (€)</th>
                                    <th>Contributo Richiesto (€)</th>
                                    <th>Intensità Aiuto (%)</th>
                                    <th>Costo Impresa (€)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>a.</strong> Acquisto attrezzature, impianti, componenti, sistemi, software e macchinari (inclusa messa in opera)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_a_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_a_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>b.</strong> Acquisto software dedicato gestione, controllo e programmazione processo produttivo</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_b_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_b_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>c.</strong> Spese edili e impianti generali (strettamente necessarie, max 20% del totale)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_c_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_c_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>d.</strong> Spese tecniche (diagnosi obbligatoria, progettazione, DL, collaudo, sicurezza - max 10%)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_d_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_d_impresa">€ 0,00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>e.</strong> APE ex-ante e APE a ultimazione lavori (obbligatorio)</td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_totale" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_contributo" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control form-control-sm" id="budget_e_intensita" step="0.01" onchange="calcolaBudgetTotale()"></td>
                                    <td><span id="budget_e_impresa">€ 0,00</span></td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>TOTALE</strong></td>
                                    <td><strong><span id="budget_totale_ammissibile">€ 0,00</span></strong></td>
                                    <td><strong><span id="budget_totale_contributo">€ 0,00</span></strong></td>
                                    <td><strong><span id="budget_intensita_media">0,00%</span></strong></td>
                                    <td><strong><span id="budget_totale_impresa">€ 0,00</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <strong><i class="fas fa-info-circle"></i> Limiti:</strong>
                        <ul class="mb-0">
                            <li>Investimento minimo: € 50.000 | Massimo: € 500.000</li>
                            <li>Spese edili (voce c): Max 20% del totale ammissibile</li>
                            <li>Spese tecniche (voce d): Max 10% del totale voci a+b+c</li>
                            <li>Intensità aiuto: De Minimis max 60% | Esenzione Micro/Piccole 60%, Medie 50%</li>
                        </ul>
                    </div>

                                        <!-- H.2 PIANO DELLE COPERTURE FINANZIARIE -->
                    <h5 class="mt-4 mb-3"><i class="fas fa-coins"></i> H.2 Piano delle Coperture Finanziarie</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Dettaglio fonti di finanziamento</label>
                        <textarea class="form-control" id="fontiFinanziamento" rows="3" placeholder="Dettagliare le fonti di finanziamento: contributo richiesto, cofinanziamenti bancari, mezzi propri, ecc."></textarea>
                    </div>
                            <div class="mb-4">
                                <button type="button" class="btn btn-info" onclick="precompilaDatiH2()">
                                    <i class="fas fa-magic"></i> Pre-compila con dati del progetto
                                </button>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle"></i> Compila automaticamente Impieghi e Fonti basandosi sui dati inseriti nelle fasi precedenti
                                </small>
                            </div>

                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> <strong>IMPORTANTE:</strong> Il totale delle FONTI deve essere uguale al totale degli IMPIEGHI
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 50%;">Prospetto "Impieghi/Fonti"</th>
                                    <th style="width: 20%;">Anno 1 (€)</th>
                                    <th style="width: 15%;">Totale (€)</th>
                                    <th style="width: 15%;">% sul totale</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- IMPIEGHI -->
                                <tr class="table-secondary">
                                    <td colspan="4"><strong>IMPIEGHI (fabbisogni finanziari)</strong></td>
                                </tr>
                                <tr>
                                    <td>Programma di investimento</td>
                                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Investimenti immateriali</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_immat_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Investimenti materiali</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_mat_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• IVA sugli investimenti</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_iva_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>A - TOTALE PROGRAMMA DI INVESTIMENTO</strong></td>
                                    <td><strong><span id="h2_tot_impieghi_anno1">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_impieghi_tot">€ 0,00</span></strong></td>
                                    <td><strong>100%</strong></td>
                                </tr>
                                
                                <!-- FONTI -->
                                <tr class="table-secondary">
                                    <td colspan="4"><strong>FONTI (coperture finanziarie)</strong></td>
                                </tr>
                                <tr>
                                    <td>Contributo pubblico richiesto</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_contributo_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_tot" readonly style="background:#f8f9fa"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td><strong>Cofinanziamento proprio:</strong></td>
                                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Incremento Capitale Sociale</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_cap_sociale_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento soci</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_soci_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Utilizzo riserve</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_riserve_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento m/l termine</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_ml_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">• Finanziamento breve termine</td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_anno1" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_tot" step="0.01" onchange="calcolaH2()"></td>
                                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_breve_perc" readonly style="background:#f8f9fa"></td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>B - TOTALE FONTI</strong></td>
                                    <td><strong><span id="h2_tot_fonti_anno1">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_fonti_tot">€ 0,00</span></strong></td>
                                    <td><strong><span id="h2_tot_fonti_perc">0%</span></strong></td>
                                </tr>
                                
                                <!-- VERIFICA BILANCIAMENTO -->
                                <tr class="table-info">
                                    <td><strong>VERIFICA BILANCIAMENTO (B - A)</strong></td>
                                    <td colspan="3"><strong><span id="h2_sbilanciamento">€ 0,00</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="alertBilanciamento" class="alert alert-danger mt-2" style="display:none;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ATTENZIONE:</strong> FONTI e IMPIEGHI non sono bilanciati!
                    </div>

                    
                    <!-- H.3 STRATEGIA DI SOSTENIBILITÀ ECONOMICO-FINANZIARIA -->
                    <div class="card-custom">
                        <div class="card-header-c">
                            <span><i class="fas fa-chart-line"></i> H.3 Strategia di Sostenibilità Economico-Finanziaria</span>
                        </div>
                        <div class="card-body-c">
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Descrizione strategia di sostenibilità</label>
                                <textarea class="form-control" id="strategiaSostenibilita" rows="3" placeholder="Descrivere le modalità con cui l'impresa intende assicurare la sostenibilità economico-finanziaria nel medio-lungo termine post-investimento"></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                                <h6 class="mb-0 fw-bold">Proiezioni Triennali (Conto Economico Previsionale)</h6>
                                <button class="btn btn-success btn-sm" onclick="proiettaEserciziPrevisionali()">
                                    <i class="fas fa-magic"></i> Proietta Auto n+1, n+2, n+3
                                </button>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> <strong>Proiezione Automatica:</strong> Analizza i dati storici 2023-2024, calcola tassi di crescita, aggiunge l'impatto dell'efficientamento energetico e proietta i 3 anni futuri con effetti crescenti.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" style="font-size:0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width:28%;">Voce Conto Economico</th>
                                            <th style="width:14%;" class="text-center">2023 (€)</th>
                                            <th style="width:14%;" class="text-center">2024 (€)</th>
                                            <th style="width:14%; background:#d1fae5;" class="text-center">Anno n+1</th>
                                            <th style="width:14%; background:#d1fae5;" class="text-center">Anno n+2</th>
                                            <th style="width:16%; background:#d1fae5;" class="text-center">Anno n+3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="fw-bold">Fatturato/Ricavi vendite</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fatt_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Altri ricavi/entrate</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_altri_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td class="fw-bold">Valore della Produzione</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_2023" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_2024" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n1" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n2" readonly style="background:#dcfce7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_vp_n3" readonly style="background:#dcfce7;"></td>
                                        </tr>
                                        <tr>
                                            <td>Consumo MP (acquisti ± Var. rimanenze)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_mp_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Servizi</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_serv_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Godimento beni di terzi</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_god_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>Personale</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_pers_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td class="fw-bold">MOL (EBITDA)</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_2023" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_2024" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n1" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n2" readonly style="background:#bfdbfe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_mol_n3" readonly style="background:#bfdbfe;"></td>
                                        </tr>
                                        <tr>
                                            <td>Ammortamenti</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_amm_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td class="fw-bold">Risultato Operativo (EBIT)</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_2023" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_2024" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n1" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n2" readonly style="background:#fef3c7;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_ro_n3" readonly style="background:#fef3c7;"></td>
                                        </tr>
                                        <tr>
                                            <td>(±) Gestione Finanziaria</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_fin_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr>
                                            <td>(±) Gestione Straordinaria</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_straord_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-light">
                                            <td class="fw-bold">Risultato Lordo</td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_2023" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_2024" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n1" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n2" readonly style="background:#f9fafb;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h3_rl_n3" readonly style="background:#f9fafb;"></td>
                                        </tr>
                                        <tr>
                                            <td>Imposte e tasse (-)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_2023" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_2024" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n1" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n2" step="0.01" onchange="calcolaH3()"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_imp_n3" step="0.01" onchange="calcolaH3()"></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td class="fw-bold">Risultato Netto</td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_2023" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_2024" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n1" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n2" readonly style="background:#d1fae5;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h3_rn_n3" readonly style="background:#d1fae5;"></td>
                                        </tr>
                                        <tr class="table-info">
                                            <td class="fw-bold">Totale Attivo (Capitale Investito)</td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_2023" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_2024" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n1" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n2" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                            <td><input type="number" class="form-control form-control-sm text-end" id="h3_attivo_n3" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i> <strong>Totale Attivo:</strong> Inserire il valore totale dell'attivo patrimoniale per ciascun anno. Questo valore è necessario per il calcolo del ROI (Return on Investment = EBIT / Totale Attivo × 100).
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- H.4 ANALISI PER INDICI -->
                    <div class="card-custom mt-4">
                        <div class="card-header-c">
                            <span><i class="fas fa-chart-bar"></i> H.4 Analisi per Indici (Calcolati Automaticamente)</span>
                        </div>
                        <div class="card-body-c">
                            
                            <div class="alert alert-success">
                                <i class="fas fa-magic"></i> <strong>Calcolo Automatico:</strong> Gli indici vengono calcolati automaticamente dai dati inseriti in H.3. Il sistema aggiorna i valori ad ogni modifica.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" style="font-size:0.9rem;">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="width:32%;">Indicatore</th>
                                            <th class="text-center">2023</th>
                                            <th class="text-center">2024</th>
                                            <th class="text-center">Anno n+1</th>
                                            <th class="text-center">Anno n+2</th>
                                            <th class="text-center">Anno n+3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ROI (Return on Investment)</strong><br><small class="text-muted">Formula: EBIT / Totale Attivo × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_2023" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_2024" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n1" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n2" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_roi_n3" readonly style="background:#dbeafe;"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>ROS (Return on Sales)</strong><br><small class="text-muted">Formula: EBIT / Fatturato × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_2023" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_2024" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n1" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n2" readonly style="background:#dbeafe;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end fw-bold" id="h4_ros_n3" readonly style="background:#dbeafe;"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Margine di Contribuzione %</strong><br><small class="text-muted">Formula: MOL / Fatturato × 100</small></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_2023" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_2024" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n1" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n2" readonly style="background:#f3f4f6;"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="h4_marg_n3" readonly style="background:#f3f4f6;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="alert alert-light border">
                                        <h6 class="fw-bold">💡 Interpretazione ROI</h6>
                                        <ul class="small mb-0">
                                            <li><strong>&gt; 10%:</strong> Ottimo rendimento del capitale</li>
                                            <li><strong>5-10%:</strong> Buon rendimento</li>
                                            <li><strong>&lt; 5%:</strong> Rendimento da migliorare</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-light border">
                                        <h6 class="fw-bold">💡 Interpretazione ROS</h6>
                                        <ul class="small mb-0">
                                            <li><strong>&gt; 15%:</strong> Marginalità elevata</li>
                                            <li><strong>5-15%:</strong> Marginalità media</li>
                                            <li><strong>&lt; 5%:</strong> Marginalità bassa</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
<!-- CALCOLO PUNTEGGI AUTOMATICO -->
                    <h5 class="mt-4 mb-3">Punteggi Tecnici Calcolati Automaticamente</h5>
                    
                    <!-- Criterio 1: Fabbisogni Energetici (Max 50 pt) -->
                    <div class="punteggio-box">
                        <h5>Criterio 1 - Fabbisogni Energetici (Max 50 pt)</h5>
                        
                        <div class="result-item">
                            <span class="result-label">P1 - Risparmio EPgl,nren (<span id="p1_riduzione_val">0%</span>)</span>
                            <span class="result-value" id="p1_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">0 pt se <30%; 5 pt se 30-35%; 10 pt se 35-40%; 15 pt se >40%</small>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P2 - Materiali CAM</span>
                            <span class="result-value" id="p2_punteggio">0 pt</span>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="checkbox" id="p2_cam" onchange="calcolaPunteggi()">
                            <label class="form-check-label" for="p2_cam">
                                Uso materiali conformi Criteri Ambientali Minimi (5 pt)
                            </label>
                        </div>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P3 - Riduzione CO2 (<span id="p3_riduzione_val">0%</span>)</span>
                            <span class="result-value" id="p3_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">0 pt se <30%; 10 pt se 30-40%; 20 pt se >40%</small>
                        
                        <div class="result-item mt-2">
                            <span class="result-label">P4 - Incremento FER (<span id="p4_incremento_val">0%</span>)</span>
                            <span class="result-value" id="p4_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">Max 10 pt se >40%</small>
                        
                        <hr>
                        <div class="result-item">
                            <span class="result-label"><strong>Totale Criterio 1</strong></span>
                            <span class="result-value" id="totale_criterio1">0 pt / 50 pt</span>
                        </div>
                    </div>
                    
                    <!-- Criterio 2: Costi/Benefici (Max 29 pt) -->
                    <div class="punteggio-box">
                        <h5>Criterio 2 - Rapporto Costi/Benefici (Max 29 pt)</h5>
                        
                        <div class="result-item">
                            <span class="result-label">P5 - Indice Costo Efficacia (<span id="p5_indice_val">0</span>)</span>
                            <span class="result-value" id="p5_punteggio">0 pt</span>
                        </div>
                        <small class="text-muted d-block">Formula: Costo Intervento / (EPgl ante - EPgl post)</small>
                        <small class="text-muted d-block">Max 29 pt se indice < 3; 20 pt se <5; 10 pt se <7</small>
                    </div>
                    
                    <!-- Criterio 3: già calcolato sopra (Cantierabilità Max 15 pt) -->
                    
                    <!-- Criterio 4: già calcolato sopra (Monitoraggio Max 6 pt) -->
                    
                    <!-- Premialità: già calcolata sopra (Max 6 pt) -->
                </div>
                
                <!-- PUNTEGGIO TOTALE FINALE -->
                <div class="punteggio-box" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                    <h3 class="text-center mb-3" style="color: white;"><i class="fas fa-medal"></i> PUNTEGGIO TECNICO TOTALE</h3>
                    <div class="punteggio-totale" style="color: white; font-size: 3rem;" id="punteggioTotale">
                        0 / 100
                    </div>
                    <p class="text-center mb-0 mt-2" style="color: white;">
                        Soglia minima ammissibilità: <strong>50 punti</strong>
                    </p>
                    <div class="text-center mt-3">
                        <span class="badge" id="badgeAmmissibilita" style="font-size: 1rem; padding: 10px 20px; background: white; color: #2ecc71;">
                            Da valutare
                        </span>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(4)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-primary btn-navigation" onclick="goToStep(6)">
                        Avanti <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ============================================ -->
            <!-- FASE 6: EXPORT E CHECKLIST DOCUMENTALE -->
            <!-- ============================================ -->
            <div id="view-6" class="view-section">
                <h2 class="mb-4 fw-bold text-dark"><i class="fas fa-file-export"></i> Fase 6: Checklist Documentale ed Export</h2>
                <p class="fase-subtitle">Controllo finale e generazione automatica documenti prima dell'invio</p>
                
                <!-- Checklist Documenti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-folder-open"></i> Documenti Obbligatori da Caricare su Piattaforma</h3>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_domanda">
                            <label class="form-check-label" for="doc_domanda">
                                <strong>1. Domanda (Allegato 2.1.A)</strong> firmata digitalmente dal legale rappresentante
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_mol">
                            <label class="form-check-label" for="doc_mol">
                                <strong>2. Allegato C (DSAN MOL)</strong> asseverato da Commercialista/Revisore/CAF e firmato digitalmente
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_capacita">
                            <label class="form-check-label" for="doc_capacita">
                                <strong>3. Allegato D.1 o D.2 (Capacità Finanziaria)</strong> attestazione banca o dichiarazione revisore
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_diagnosi">
                            <label class="form-check-label" for="doc_diagnosi">
                                <strong>4. Diagnosi Energetica</strong> (UNI CEI EN 16247) firmata da EGE/ESCO + Ricevuta trasmissione ENEA
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_ape">
                            <label class="form-check-label" for="doc_ape">
                                <strong>5. APE Ex-Ante e Simulazione Ex-Post</strong> (per interventi su edifici)
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_preventivi">
                            <label class="form-check-label" for="doc_preventivi">
                                <strong>6. Preventivi e Computi Metrici</strong> firmati da tecnico abilitato
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_formulario">
                            <label class="form-check-label" for="doc_formulario">
                                <strong>7. Formulario (Allegato F)</strong> descrittivo del programma investimenti
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_dnsh">
                            <label class="form-check-label" for="doc_dnsh">
                                <strong>8. Allegato G (DNSH)</strong> Dichiarazione + Checklist climatiche
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_perizia">
                            <label class="form-check-label" for="doc_perizia">
                                <strong>9. Perizia Asseverata</strong> conformità immobile e titolo disponibilità
                            </label>
                        </div>
                    </div>
                    
                    <div class="checklist-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="doc_bollo">
                            <label class="form-check-label" for="doc_bollo">
                                <strong>10. Marca da Bollo</strong> € 16,00 annullata
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Riepilogo Finale Completo -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-clipboard-check"></i> Riepilogo Finale Domanda</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary">Dati Impresa</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Ragione Sociale:</strong></td><td><span id="final_ragioneSociale">-</span></td></tr>
                                <tr><td><strong>P.IVA:</strong></td><td><span id="final_partitaIva">-</span></td></tr>
                                <tr><td><strong>Dimensione:</strong></td><td><span id="final_dimensione">-</span></td></tr>
                                <tr><td><strong>ATECO:</strong></td><td><span id="final_ateco">-</span></td></tr>
                                <tr><td><strong>Sede Intervento:</strong></td><td><span id="final_sedIntervento">-</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary">Dati Economici</h5>
                            <table class="table table-sm">
                                <tr><td><strong>MOL:</strong></td><td><span id="final_mol">€ 0,00</span></td></tr>
                                <tr><td><strong>Investimento:</strong></td><td><span id="final_investimento">€ 0,00</span></td></tr>
                                <tr><td><strong>Contributo:</strong></td><td><span id="final_contributo">€ 0,00</span></td></tr>
                                <tr><td><strong>Regime Aiuto:</strong></td><td><span id="final_regime">-</span></td></tr>
                                <tr><td><strong>Indicatore Ordinatore:</strong></td><td><span id="final_ordinatore">0,00000</span></td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-success">Performance Energetiche</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Risparmio Energetico:</strong></td><td class="text-success"><strong><span id="final_risparmio">0,00%</span></strong></td></tr>
                                <tr><td><strong>Riduzione CO2:</strong></td><td class="text-success"><strong><span id="final_co2">0,00%</span></strong></td></tr>
                                <tr><td><strong>Incremento FER:</strong></td><td class="text-success"><strong><span id="final_fer">0,00%</span></strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-success">Punteggio Tecnico</h5>
                            <table class="table table-sm">
                                <tr><td><strong>Punteggio Totale:</strong></td><td><span id="final_punteggio" class="text-primary fs-4">0 / 100</span></td></tr>
                                <tr><td><strong>Ammissibilità:</strong></td><td><span id="final_ammissibilita">-</span></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Export Documenti -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-download"></i> Generazione Automatica Documenti</h3>
                    
                    <div class="alert-success-custom">
                        <strong><i class="fas fa-magic"></i> Documenti Generati Automaticamente:</strong>
                        L'applicazione compilerà automaticamente tutti i documenti ufficiali con i dati inseriti.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    <h5 class="card-title">Allegato 2.1.A</h5>
                                    <p class="card-text">Domanda di Finanziamento con tutte le dichiarazioni</p>
                                    <button class="btn btn-danger" onclick="esportaDomandaPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Allegato F</h5>
                                    <p class="card-text">Formulario Completo del Progetto</p>
                                    <button class="btn btn-primary" onclick="esportaFormularioPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card-custom h-100">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-pdf fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Allegato C (DSAN)</h5>
                                    <p class="card-text">Dichiarazione MOL per Criterio Ordinatore</p>
                                    <button class="btn btn-warning" onclick="esportaDSANPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Budget Excel</h5>
                                    <p class="card-text">Quadro economico dettagliato</p>
                                    <button class="btn btn-success" onclick="esportaExcel()">
                                        <i class="fas fa-file-excel"></i> Genera Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body-c text-center">
                                    <i class="fas fa-file-alt fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Riepilogo Completo</h5>
                                    <p class="card-text">Documento riepilogativo PDF</p>
                                    <button class="btn btn-info" onclick="esportaRiepilogoPDF()">
                                        <i class="fas fa-file-pdf"></i> Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert-success-custom mt-4">
                    <h5><i class="fas fa-check-circle"></i> Domanda Completata!</h5>
                    <p class="mb-0">
                        Verifica che tutti i documenti siano pronti e procedi con il caricamento sulla piattaforma ufficiale della Regione Siciliana.
                        Ricordati di salvare il progetto per conservare tutti i dati inseriti.
                    </p>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline-secondary btn-navigation" onclick="goToStep(5)">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                    <button class="btn btn-success btn-navigation" onclick="finalizza()">
                        <i class="fas fa-flag-checkered"></i> Finalizza
                    </button>
                </div>
            </div>
            
        </div>
    
</div>


</div>

    <script>
        // ============================================
        // STATO GLOBALE APPLICAZIONE
        // ============================================
        let datiDomanda = {
            anagrafica: {},
            legaleRappresentante: {},
            unitaProduttiva: {},
            mol: {},
            dimensioneAziendale: {},
            soci: [],
            aiutiDeMinimis: [],
            professionista: {},
            diagnosi: {},
            preventivi: [],
            istanza: {},
            formulario: {},
            export: {}
        };
        
        let currentStep = 1;
        
        // ============================================
        // NAVIGAZIONE TRA LE FASI
        // ============================================
        function goToStep(step) {
            // Nascondi tutte le view
            document.querySelectorAll('.view-section').forEach(function(view) {
                view.style.display = 'none';
            });
            
            // Rimuovi active da tutti i nav
            document.querySelectorAll('.nav-link-custom').forEach(function(nav) {
                nav.classList.remove('active');
            });
            
            // Mostra la view selezionata
            var viewTarget = document.getElementById('view-' + step);
            if (viewTarget) {
                viewTarget.style.display = 'block';
            }
            
            // Attiva nav corrispondente
            var navTarget = document.getElementById('nav-fase' + step);
            if (navTarget) {
                navTarget.classList.add('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Salva e carica dati se le funzioni esistono
            if (typeof salvaDatiFase === 'function') {
                try { salvaDatiFase(step); } catch(e) {}
            }
            if (typeof caricaDatiFase === 'function') {
                try { caricaDatiFase(step); } catch(e) {}
            }
        }
        
        // ============================================
        // SALVATAGGIO E CARICAMENTO DATI
        // ============================================
        function salvaDatiFase(fase) {
            try {
                switch(fase) {
                    case 1: // Anagrafica
                        datiDomanda.anagrafica = {
                            ragioneSociale: getValue('ragioneSociale'),
                            partitaIva: getValue('partitaIva'),
                            codiceFiscale: getValue('codiceFiscale'),
                            pec: getValue('pec'),
                            codiceAteco: getValue('codiceAteco'),
                            dimensioneImpresa: getValue('dimensioneImpresa'),
                            sedeLegale: getValue('sedeLegale'),
                            annoCostituzione: getValue('annoCostituzione'),
                            telefono: getValue('telefono')
                        };
                        
                        datiDomanda.legaleRappresentante = {
                            nome: getValue('lrNome'),
                            cognome: getValue('lrCognome'),
                            cf: getValue('lrCF'),
                            dataNascita: getValue('lrDataNascita'),
                            luogoNascita: getValue('lrLuogoNascita'),
                            residenza: getValue('lrResidenza'),
                            qualita: getValue('lrQualita')
                        };
                        
                        datiDomanda.unitaProduttiva = {
                            indirizzo: getValue('indirizzoIntervento'),
                            coordinate: getValue('coordinateCatastali'),
                            titolo: getValue('titoloDisponibilita'),
                            titoliAutorizzativi: getValue('titoliAutorizzativi'),
                            agibilita: getValue('certificatoAgibilita')
                        };
                        break;
                        
                    case 2: // MOL
                        datiDomanda.mol = {
                            annoRiferimento: getValue('annoRiferimento'),
                            tipoDocumento: getValue('tipoDocumento'),
                            valoreProduzione: getNumericValue('valoreProduzione'),
                            materiePrime: getNumericValue('materiePrime'),
                            costiServizi: getNumericValue('costiServizi'),
                            costiBeniTerzi: getNumericValue('costiBeniTerzi'),
                            spesePersonale: getNumericValue('spesePersonale'),
                            variazioniRimanenze: getNumericValue('variazioniRimanenze'),
                            oneriDiversi: getNumericValue('oneriDiversi'),
                            costoTotaleInvestimento: getNumericValue('costoTotaleInvestimento'),
                            contributoRichiesto: getNumericValue('contributoRichiesto'),
                            regimeAiuto: getRadioValue('regimeAiuto')
                        };
                        
                        datiDomanda.dimensioneAziendale = {
                            ula_dichiarante: getNumericValue('ula_dichiarante'),
                            fatturato_dichiarante: getNumericValue('fatturato_dichiarante'),
                            bilancio_dichiarante: getNumericValue('bilancio_dichiarante'),
                            ula_associate: getNumericValue('ula_associate'),
                            fatturato_associate: getNumericValue('fatturato_associate'),
                            bilancio_associate: getNumericValue('bilancio_associate'),
                            ula_collegate: getNumericValue('ula_collegate'),
                            fatturato_collegate: getNumericValue('fatturato_collegate'),
                            bilancio_collegate: getNumericValue('bilancio_collegate'),
                            tipoImpresa: getRadioValue('tipoImpresa')
                        };
                        
                        datiDomanda.professionista = {
                            tipo: getValue('tipoProfessionista'),
                            nome: getValue('nomeProfessionista'),
                            cf: getValue('cfProfessionista'),
                            iscrizione: getValue('iscrizioneAlbo'),
                            sede: getValue('sedeProfessionista')
                        };
                        break;
                        
                    case 3: // Diagnosi
                        datiDomanda.diagnosi = {
                            epgl_ante: getNumericValue('epgl_ante'),
                            epgl_post: getNumericValue('epgl_post'),
                            co2_ante: getNumericValue('co2_ante'),
                            co2_post: getNumericValue('co2_post'),
                            fer_ante: getNumericValue('fer_ante'),
                            fer_post: getNumericValue('fer_post'),
                            opereMurarie: getNumericValue('opereMurarie'),
                            speseTecniche: getNumericValue('speseTecniche')
                        };
                        break;
                        
                    case 4: // Istanza
                        datiDomanda.istanza = {
                            numeroMarcaBollo: getValue('numeroMarcaBollo'),
                            dataMarcaBollo: getValue('dataMarcaBollo')
                        };
                        break;
                        
                    case 5: // Formulario
                        datiDomanda.formulario = {
                            titoloProgetto: getValue('titoloProgetto'),
                            acronimoProgetto: getValue('acronimoProgetto'),
                            durataProgetto: getValue('durataProgetto'),
                            missionAttivita: getValue('missionAttivita'),
                            attivitaEconomica: getValue('attivitaEconomica'),
                            contestualizzazioneFabbisogni: getValue('contestualizzazioneFabbisogni'),
                            obiettiviPerseguiti: getValue('obiettiviPerseguiti'),
                            struttureMonitoraggio: getValue('struttureMonitoraggio'),
                            figureEnergyManager: getValue('figureEnergyManager'),
                            descrizioneTecnica: getValue('descrizioneTecnica'),
                            maturitaProgettuale: getValue('maturitaProgettuale'),
                            cronoprogramma: getValue('cronoprogramma'),
                            sistemaMonitoraggio: getValue('sistemaMonitoraggio'),
                            illustrazioneBudget: getValue('illustrazioneBudget'),
                            pianoCoperture: getValue('pianoCoperture'),
                            dettagliEnergyManager: getValue('dettagliEnergyManager'),
                            dettagliSistemiMisura: getValue('dettagliSistemiMisura'),
                            cantierabilita: getRadioValue('cantierabilita')
                        };
                        break;
                }
            } catch (error) {
                console.error('Errore salvataggio fase:', error);
            }
        }
        
        function caricaDatiFase(fase) {
            try {
                switch(fase) {
                    case 1:
                        if (datiDomanda.anagrafica) {
                            setValue('ragioneSociale', datiDomanda.anagrafica.ragioneSociale);
                            setValue('partitaIva', datiDomanda.anagrafica.partitaIva);
                            setValue('codiceFiscale', datiDomanda.anagrafica.codiceFiscale);
                            setValue('pec', datiDomanda.anagrafica.pec);
                            setValue('codiceAteco', datiDomanda.anagrafica.codiceAteco);
                            setValue('dimensioneImpresa', datiDomanda.anagrafica.dimensioneImpresa);
                            setValue('sedeLegale', datiDomanda.anagrafica.sedeLegale);
                            setValue('annoCostituzione', datiDomanda.anagrafica.annoCostituzione);
                            setValue('telefono', datiDomanda.anagrafica.telefono);
                        }
                        
                        if (datiDomanda.legaleRappresentante) {
                            setValue('lrNome', datiDomanda.legaleRappresentante.nome);
                            setValue('lrCognome', datiDomanda.legaleRappresentante.cognome);
                            setValue('lrCF', datiDomanda.legaleRappresentante.cf);
                            setValue('lrDataNascita', datiDomanda.legaleRappresentante.dataNascita);
                            setValue('lrLuogoNascita', datiDomanda.legaleRappresentante.luogoNascita);
                            setValue('lrResidenza', datiDomanda.legaleRappresentante.residenza);
                            setValue('lrQualita', datiDomanda.legaleRappresentante.qualita);
                        }
                        
                        if (datiDomanda.unitaProduttiva) {
                            setValue('indirizzoIntervento', datiDomanda.unitaProduttiva.indirizzo);
                            setValue('coordinateCatastali', datiDomanda.unitaProduttiva.coordinate);
                            setValue('titoloDisponibilita', datiDomanda.unitaProduttiva.titolo);
                            setValue('titoliAutorizzativi', datiDomanda.unitaProduttiva.titoliAutorizzativi);
                            setValue('certificatoAgibilita', datiDomanda.unitaProduttiva.agibilita);
                        }
                        break;
                        
                    case 2:
                        if (datiDomanda.mol) {
                            setValue('annoRiferimento', datiDomanda.mol.annoRiferimento);
                            setValue('tipoDocumento', datiDomanda.mol.tipoDocumento);
                            setValue('valoreProduzione', datiDomanda.mol.valoreProduzione);
                            setValue('materiePrime', datiDomanda.mol.materiePrime);
                            setValue('costiServizi', datiDomanda.mol.costiServizi);
                            setValue('costiBeniTerzi', datiDomanda.mol.costiBeniTerzi);
                            setValue('spesePersonale', datiDomanda.mol.spesePersonale);
                            setValue('variazioniRimanenze', datiDomanda.mol.variazioniRimanenze);
                            setValue('oneriDiversi', datiDomanda.mol.oneriDiversi);
                            setValue('costoTotaleInvestimento', datiDomanda.mol.costoTotaleInvestimento);
                            setValue('contributoRichiesto', datiDomanda.mol.contributoRichiesto);
                            setRadioValue('regimeAiuto', datiDomanda.mol.regimeAiuto);
                            calcolaMOL();
                            calcolaIndicatoreOrdinatore();
                        }
                        
                        if (datiDomanda.dimensioneAziendale) {
                            setValue('ula_dichiarante', datiDomanda.dimensioneAziendale.ula_dichiarante);
                            setValue('fatturato_dichiarante', datiDomanda.dimensioneAziendale.fatturato_dichiarante);
                            setValue('bilancio_dichiarante', datiDomanda.dimensioneAziendale.bilancio_dichiarante);
                            setValue('ula_associate', datiDomanda.dimensioneAziendale.ula_associate);
                            setValue('fatturato_associate', datiDomanda.dimensioneAziendale.fatturato_associate);
                            setValue('bilancio_associate', datiDomanda.dimensioneAziendale.bilancio_associate);
                            setValue('ula_collegate', datiDomanda.dimensioneAziendale.ula_collegate);
                            setValue('fatturato_collegate', datiDomanda.dimensioneAziendale.fatturato_collegate);
                            setValue('bilancio_collegate', datiDomanda.dimensioneAziendale.bilancio_collegate);
                            setRadioValue('tipoImpresa', datiDomanda.dimensioneAziendale.tipoImpresa);
                            calcolaTotaliDimensione();
                        }
                        break;
                        
                    case 3:
                        if (datiDomanda.diagnosi) {
                            setValue('epgl_ante', datiDomanda.diagnosi.epgl_ante);
                            setValue('epgl_post', datiDomanda.diagnosi.epgl_post);
                            setValue('co2_ante', datiDomanda.diagnosi.co2_ante);
                            setValue('co2_post', datiDomanda.diagnosi.co2_post);
                            setValue('fer_ante', datiDomanda.diagnosi.fer_ante);
                            setValue('fer_post', datiDomanda.diagnosi.fer_post);
                            setValue('opereMurarie', datiDomanda.diagnosi.opereMurarie);
                            setValue('speseTecniche', datiDomanda.diagnosi.speseTecniche);
                            calcolaRiduzioniEnergetiche();
                        }
                        aggiornaListaPreventivi();
                        break;
                        
                    case 4:
                        if (datiDomanda.istanza) {
                            setValue('numeroMarcaBollo', datiDomanda.istanza.numeroMarcaBollo);
                            setValue('dataMarcaBollo', datiDomanda.istanza.dataMarcaBollo);
                        }
                        aggiornaRiepilogoFase4();
                        break;
                        
                    case 5:
                        if (datiDomanda.formulario) {
                            setValue('titoloProgetto', datiDomanda.formulario.titoloProgetto);
                            setValue('acronimoProgetto', datiDomanda.formulario.acronimoProgetto);
                            setValue('durataProgetto', datiDomanda.formulario.durataProgetto);
                            setValue('missionAttivita', datiDomanda.formulario.missionAttivita);
                            setValue('attivitaEconomica', datiDomanda.formulario.attivitaEconomica);
                            setValue('contestualizzazioneFabbisogni', datiDomanda.formulario.contestualizzazioneFabbisogni);
                            setValue('obiettiviPerseguiti', datiDomanda.formulario.obiettiviPerseguiti);
                            setValue('struttureMonitoraggio', datiDomanda.formulario.struttureMonitoraggio);
                            setValue('figureEnergyManager', datiDomanda.formulario.figureEnergyManager);
                            setValue('descrizioneTecnica', datiDomanda.formulario.descrizioneTecnica);
                            setValue('maturitaProgettuale', datiDomanda.formulario.maturitaProgettuale);
                            setValue('cronoprogramma', datiDomanda.formulario.cronoprogramma);
                            setValue('sistemaMonitoraggio', datiDomanda.formulario.sistemaMonitoraggio);
                            setValue('illustrazioneBudget', datiDomanda.formulario.illustrazioneBudget);
                            setValue('pianoCoperture', datiDomanda.formulario.pianoCoperture);
                            setValue('dettagliEnergyManager', datiDomanda.formulario.dettagliEnergyManager);
                            setValue('dettagliSistemiMisura', datiDomanda.formulario.dettagliSistemiMisura);
                            setRadioValue('cantierabilita', datiDomanda.formulario.cantierabilita);
                        }
                        
                        // Aggiorna anche costo totale dal riepilogo preventivi
                        const totaleInv = datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0);
                        setValue('costoTotaleFormulario', totaleInv.toFixed(2));
                        
                        calcolaPunteggi();
                        break;
                        
                    case 6:
                        aggiornaRiepilogoFinale();
                        break;
                }
            } catch (error) {
                console.error('Errore caricamento fase:', error);
            }
        }
        
        // Helper functions
        function getValue(id) {
            const elem = document.getElementById(id);
            return elem ? elem.value : '';
        }
        
        function getNumericValue(id) {
            const elem = document.getElementById(id);
            return elem ? (parseFloat(elem.value) || 0) : 0;
        }
        
        function getCheckValue(id) {
            const elem = document.getElementById(id);
            return elem ? elem.checked : false;
        }
        
        function getRadioValue(name) {
            const elem = document.querySelector(`input[name="${name}"]:checked`);
            return elem ? elem.value : '';
        }
        
        function setValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.value = value || '';
        }
        
        function setCheckValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.checked = !!value;
        }
        
        function setRadioValue(name, value) {
            const elem = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (elem) elem.checked = true;
        }
        
        function setTextValue(id, value) {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = value || '';
        }
        
        // ============================================
        // CALCOLI AUTOMATICI
        // ============================================
        function calcolaMOL() {
            const valore = getNumericValue('valoreProduzione');
            const materie = getNumericValue('materiePrime');
            const servizi = getNumericValue('costiServizi');
            const beniTerzi = getNumericValue('costiBeniTerzi');
            const personale = getNumericValue('spesePersonale');
            const variazioni = getNumericValue('variazioniRimanenze');
            const oneri = getNumericValue('oneriDiversi');
            
            const totaleCosti = materie + servizi + beniTerzi + personale + variazioni + oneri;
            const mol = valore - totaleCosti;
            
            setTextValue('molCalcolato', formatEuro(mol));
            setTextValue('totaleCosti', formatEuro(totaleCosti));
            
            // Aggiorna anche indicatore ordinatore
            calcolaIndicatoreOrdinatore();
        }
        
        function calcolaIndicatoreOrdinatore() {
            const valore = getNumericValue('valoreProduzione');
            const materie = getNumericValue('materiePrime');
            const servizi = getNumericValue('costiServizi');
            const beniTerzi = getNumericValue('costiBeniTerzi');
            const personale = getNumericValue('spesePersonale');
            const variazioni = getNumericValue('variazioniRimanenze');
            const oneri = getNumericValue('oneriDiversi');
            
            const mol = valore - (materie + servizi + beniTerzi + personale + variazioni + oneri);
            const costo = getNumericValue('costoTotaleInvestimento');
            
            if (costo === 0) {
                setTextValue('indicatoreOrdinatore', '0,00000');
                setTextValue('punteggioOrdinatore', '0,00000');
                return;
            }
            
            const indicatore = mol / costo;
            const formattato = indicatore.toFixed(5).replace('.', ',');
            
            setTextValue('indicatoreOrdinatore', formattato);
            setTextValue('punteggioOrdinatore', formattato);
        }
        
        function calcolaTotaliDimensione() {
            const ula_dich = getNumericValue('ula_dichiarante');
            const ula_ass = getNumericValue('ula_associate');
            const ula_coll = getNumericValue('ula_collegate');
            
            const fatt_dich = getNumericValue('fatturato_dichiarante');
            const fatt_ass = getNumericValue('fatturato_associate');
            const fatt_coll = getNumericValue('fatturato_collegate');
            
            const bil_dich = getNumericValue('bilancio_dichiarante');
            const bil_ass = getNumericValue('bilancio_associate');
            const bil_coll = getNumericValue('bilancio_collegate');
            
            setTextValue('totale_ula', (ula_dich + ula_ass + ula_coll).toFixed(2));
            setTextValue('totale_fatturato', (fatt_dich + fatt_ass + fatt_coll).toFixed(2));
            setTextValue('totale_bilancio', (bil_dich + bil_ass + bil_coll).toFixed(2));
            
            // Aggiorna anche anno di riferimento
            const anno = getValue('annoRiferimento');
            if (anno) {
                setTextValue('annoRefDimensione', '31/12/' + anno);
            }
        }
        
        function calcolaRiduzioniEnergetiche() {
            const epgl_ante = getNumericValue('epgl_ante');
            const epgl_post = getNumericValue('epgl_post');
            const co2_ante = getNumericValue('co2_ante');
            const co2_post = getNumericValue('co2_post');
            const fer_ante = getNumericValue('fer_ante');
            const fer_post = getNumericValue('fer_post');
            
            // Risparmio energetico
            let risparmioEnergetico = 0;
            if (epgl_ante > 0) {
                risparmioEnergetico = ((epgl_ante - epgl_post) / epgl_ante) * 100;
            }
            
            // Riduzione CO2
            let riduzioneCO2 = 0;
            if (co2_ante > 0) {
                riduzioneCO2 = ((co2_ante - co2_post) / co2_ante) * 100;
            }
            
            // Incremento FER
            let incrementoFER = 0;
            if (fer_ante > 0) {
                incrementoFER = ((fer_post - fer_ante) / fer_ante) * 100;
            } else if (fer_post > 0) {
                incrementoFER = 100;
            }
            
            setTextValue('risparmioEnergetico', risparmioEnergetico.toFixed(2) + '%');
            setTextValue('riduzioneCO2', riduzioneCO2.toFixed(2) + '%');
            setTextValue('incrementoFER', incrementoFER.toFixed(2) + '%');
            
            // Validazione
            validaProgetto(risparmioEnergetico, riduzioneCO2);
            
            // Aggiorna punteggi se in fase 5
            if (currentStep >= 5) {
                calcolaPunteggi();
            }
        }
        
        function validaProgetto(risparmio, riduzioneCO2) {
            // Validazione riduzione CO2
            const iconCO2 = document.getElementById('icon_riduzioneCO2');
            const badgeCO2 = document.getElementById('badge_riduzioneCO2');
            
            if (riduzioneCO2 >= 30) {
                iconCO2.style.color = '#28a745';
                badgeCO2.className = 'ms-auto badge bg-success';
                badgeCO2.textContent = '✓ Conforme';
            } else {
                iconCO2.style.color = '#dc3545';
                badgeCO2.className = 'ms-auto badge bg-danger';
                badgeCO2.textContent = '✗ Non conforme (<30%)';
            }
            
            // Validazione risparmio energetico
            const iconResp = document.getElementById('icon_risparmioEnergetico');
            const badgeResp = document.getElementById('badge_risparmioEnergetico');
            
            if (risparmio > 0) {
                iconResp.style.color = '#28a745';
                badgeResp.className = 'ms-auto badge bg-success';
                badgeResp.textContent = '✓ Verificato';
            } else {
                iconResp.style.color = '#dc3545';
                badgeResp.className = 'ms-auto badge bg-danger';
                badgeResp.textContent = '✗ Non verificato';
            }
        }
        
        
        function calcolaPunteggi() {
            const epgl_ante = getNumericValue('epgl_ante');
            const epgl_post = getNumericValue('epgl_post');
            const co2_ante = getNumericValue('co2_ante');
            const co2_post = getNumericValue('co2_post');
            const fer_ante = getNumericValue('fer_ante');
            const fer_post = getNumericValue('fer_post');
            
            // Calcolo riduzioni
            const risparmioEPgl = epgl_ante > 0 ? ((epgl_ante - epgl_post) / epgl_ante) * 100 : 0;
            const riduzioneCO2 = co2_ante > 0 ? ((co2_ante - co2_post) / co2_ante) * 100 : 0;
            const incrementoFER = fer_ante > 0 ? ((fer_post - fer_ante) / fer_ante) * 100 : (fer_post > 0 ? 100 : 0);
            
            // P1 - Risparmio EPgl
            let p1 = 0;
            if (risparmioEPgl >= 40) p1 = 15;
            else if (risparmioEPgl >= 35) p1 = 10;
            else if (risparmioEPgl >= 30) p1 = 5;
            
            setTextValue('p1_riduzione_val', risparmioEPgl.toFixed(2) + '%');
            setTextValue('p1_punteggio', p1 + ' pt');
            
            // P3 - Riduzione CO2
            let p3 = 0;
            if (riduzioneCO2 >= 40) p3 = 20;
            else if (riduzioneCO2 >= 30) p3 = 10;
            
            setTextValue('p3_riduzione_val', riduzioneCO2.toFixed(2) + '%');
            setTextValue('p3_punteggio', p3 + ' pt');
            
            // P4 - Incremento FER
            let p4 = 0;
            if (incrementoFER >= 40) p4 = 10;
            
            setTextValue('p4_incremento_val', incrementoFER.toFixed(2) + '%');
            setTextValue('p4_punteggio', p4 + ' pt');
            
            // P2 - CAM
            const p2 = getCheckValue('p2_cam') ? 5 : 0;
            setTextValue('p2_punteggio', p2 + ' pt');
            
            // Totale Criterio 1
            const totCrit1 = p1 + p2 + p3 + p4;
            setTextValue('totale_criterio1', totCrit1 + ' pt / 50 pt');
            
            // P5 - Costo Efficacia
            const costoIntervento = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            const risparmioAssoluto = epgl_ante - epgl_post;
            const indiceCosto = risparmioAssoluto > 0 ? costoIntervento / risparmioAssoluto : 9999;
            
            let p5 = 0;
            if (indiceCosto < 3) p5 = 29;
            else if (indiceCosto < 5) p5 = 20;
            else if (indiceCosto < 7) p5 = 10;
            
            setTextValue('p5_indice_val', indiceCosto.toFixed(2));
            setTextValue('p5_punteggio', p5 + ' pt');
            
            // Cantierabilità
            const cant = parseInt(getRadioValue('cantierabilita')) || 0;
            
            // Monitoraggio
            const mon1 = getCheckValue('mon_sistema1');
            const mon2 = getCheckValue('mon_sistema2');
            const mon3 = getCheckValue('mon_sistema3');
            const numSistemi = [mon1, mon2, mon3].filter(Boolean).length;
            const pMon = numSistemi === 3 ? 6 : (numSistemi === 2 ? 3 : (numSistemi === 1 ? 1 : 0));
            setTextValue('p_monitoraggio', pMon + ' pt');
            
            // Premialità
            const premEM = getCheckValue('prem_energyManager') ? 3 : 0;
            const premSM = getCheckValue('prem_sistemiMisura') ? 3 : 0;
            const pPrem = premEM + premSM;
            setTextValue('p_premialita', pPrem + ' pt');
            
            // TOTALE
            const totale = totCrit1 + p5 + cant + pMon + pPrem;
            setTextValue('punteggioTotale', totale + ' / 100');
            
            // Badge ammissibilità
            const badgeAmm = document.getElementById('badgeAmmissibilita');
            if (totale >= 50) {
                badgeAmm.style.background = '#28a745';
                badgeAmm.style.color = 'white';
                badgeAmm.textContent = '✓ AMMISSIBILE (≥ 50 punti)';
            } else {
                badgeAmm.style.background = '#dc3545';
                badgeAmm.style.color = 'white';
                badgeAmm.textContent = '✗ NON AMMISSIBILE (< 50 punti)';
            }
        }
        
        // ============================================
        // GESTIONE PREVENTIVI
        // ============================================
        function mostraFormPreventivo() {
            document.getElementById('formPreventivo').style.display = 'block';
        }
        
        function nascondiFormPreventivo() {
            document.getElementById('formPreventivo').style.display = 'none';
            setValue('nuovoPreventivo_categoria', '');
            setValue('nuovoPreventivo_descrizione', '');
            setValue('nuovoPreventivo_fornitore', '');
            setValue('nuovoPreventivo_importo', '');
            setTextValue('helpCategoria', '');
        }
        
        function aggiornaHelpCategoria() {
            const categoria = getValue('nuovoPreventivo_categoria');
            const help = {
                'cat_a': 'Es: Motori alta efficienza, inverter, recupero calore, building automation',
                'cat_b': 'Es: Cappotto termico, infissi, relamping LED, schermature solari',
                'cat_c': 'Deve essere "nuovo e più efficiente", NO mera sostituzione tecnologica',
                'cat_d': 'Es: Fotovoltaico, Solare termico - SOLO se combinato con Cat. A o B'
            };
            setTextValue('helpCategoria', help[categoria] || '');
        }
        
        function aggiungiPreventivo() {
            const categoria = getValue('nuovoPreventivo_categoria');
            const descrizione = getValue('nuovoPreventivo_descrizione');
            const fornitore = getValue('nuovoPreventivo_fornitore');
            const importo = getNumericValue('nuovoPreventivo_importo');
            
            if (!categoria || !descrizione || !fornitore || importo <= 0) {
                alert('Compilare tutti i campi del preventivo!');
                return;
            }
            
            // Validazione Categoria D
            if (categoria === 'cat_d') {
                const hasAorB = datiDomanda.preventivi.some(p => 
                    p.categoria === 'cat_a' || p.categoria === 'cat_b'
                );
                
                if (!hasAorB) {
                    alert('⚠️ ATTENZIONE!\n\nLa Categoria D (Energie Rinnovabili) è ammissibile SOLO se combinata con interventi di Categoria A o B.\n\nInserisci prima almeno un preventivo di Categoria A o B.');
                    return;
                }
            }
            
            // Aggiungi preventivo
            if (!datiDomanda.preventivi) datiDomanda.preventivi = [];
            
            datiDomanda.preventivi.push({
                id: Date.now(),
                categoria: categoria,
                descrizione: descrizione,
                fornitore: fornitore,
                importo: importo
            });
            
            aggiornaListaPreventivi();
            nascondiFormPreventivo();
            salvaAutomaticamente();
        }
        
        function rimuoviPreventivo(id) {
            if (confirm('Rimuovere questo preventivo?')) {
                datiDomanda.preventivi = datiDomanda.preventivi.filter(p => p.id !== id);
                aggiornaListaPreventivi();
                salvaAutomaticamente();
            }
        }
        
        function aggiornaListaPreventivi() {
            const container = document.getElementById('listaPreventivi');
            
            if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun preventivo inserito</p>';
                aggiornaTotaliPreventivi();
                return;
            }
            
            let html = '';
            datiDomanda.preventivi.forEach(prev => {
                const categoriaNome = {
                    'cat_a': 'CATEGORIA A - Processi Produttivi',
                    'cat_b': 'CATEGORIA B - Edifici',
                    'cat_c': 'CATEGORIA C - Macchinari',
                    'cat_d': 'CATEGORIA D - Rinnovabili'
                }[prev.categoria];
                
                const categoriaColor = {
                    'cat_a': 'primary',
                    'cat_b': 'success',
                    'cat_c': 'warning',
                    'cat_d': 'info'
                }[prev.categoria];
                
                html += `
                    <div class="preventivo-item">
                        <div class="preventivo-header">
                            <span class="badge badge-categoria bg-${categoriaColor}">${categoriaNome}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="rimuoviPreventivo(${prev.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="mb-1"><strong>${prev.descrizione}</strong></p>
                        <p class="mb-1"><small>Fornitore: ${prev.fornitore}</small></p>
                        <p class="mb-0 text-primary"><strong>${formatEuro(prev.importo)}</strong></p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            aggiornaTotaliPreventivi();
        }
        
        function aggiornaTotaliPreventivi() {
            let totali = { cat_a: 0, cat_b: 0, cat_c: 0, cat_d: 0 };
            
            if (datiDomanda.preventivi) {
                datiDomanda.preventivi.forEach(prev => {
                    totali[prev.categoria] = (totali[prev.categoria] || 0) + prev.importo;
                });
            }
            
            setTextValue('totale_cat_a', formatEuro(totali.cat_a));
            setTextValue('totale_cat_b', formatEuro(totali.cat_b));
            setTextValue('totale_cat_c', formatEuro(totali.cat_c));
            setTextValue('totale_cat_d', formatEuro(totali.cat_d));
            
            const totale = totali.cat_a + totali.cat_b + totali.cat_c + totali.cat_d;
            setTextValue('totaleInvestimenti', formatEuro(totale));
            
            // Aggiorna anche il costo totale in Fase 2
            setValue('costoTotaleInvestimento', totale.toFixed(2));
            calcolaIndicatoreOrdinatore();
        }
        
        function validaSpeseAccessorie() {
            const totale = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            const murarie = getNumericValue('opereMurarie');
            const tecniche = getNumericValue('speseTecniche');
            
            const alertDiv = document.getElementById('alertSpeseAccessorie');
            let messages = [];
            
            const maxMurarie = totale * 0.2;
            if (murarie > maxMurarie) {
                messages.push(`⚠️ Opere Murarie: importo superiore al 20% (max ${formatEuro(maxMurarie)})`);
            }
            
            const maxTecniche = totale * 0.1;
            if (tecniche > maxTecniche) {
                messages.push(`⚠️ Spese Tecniche: importo superiore al 10% (max ${formatEuro(maxTecniche)})`);
            }
            
            if (messages.length > 0) {
                alertDiv.innerHTML = `<div class="alert alert-warning">${messages.join('<br>')}</div>`;
            } else {
                alertDiv.innerHTML = '';
            }
        }
        
        // ============================================
        // GESTIONE SOCI E AIUTI DE MINIMIS
        // ============================================
        function aggiungiSocio() {
            const id = Date.now();
            if (!datiDomanda.soci) datiDomanda.soci = [];
            
            datiDomanda.soci.push({
                id: id,
                nome: '',
                sede: '',
                cf: '',
                quotaPartecipazione: 0,
                quotaVoto: 0
            });
            
            aggiornaListaSoci();
        }
        
        function rimuoviSocio(id) {
            datiDomanda.soci = datiDomanda.soci.filter(s => s.id !== id);
            aggiornaListaSoci();
        }
        
        function aggiornaListaSoci() {
            const container = document.getElementById('listaSoci');
            
            if (!datiDomanda.soci || datiDomanda.soci.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun socio inserito</p>';
                return;
            }
            
            let html = '<table class="table table-sm table-bordered">';
            html += '<thead><tr><th>Nome/Denominazione</th><th>Sede</th><th>CF/P.IVA</th><th>%Part.</th><th>%Voto</th><th></th></tr></thead><tbody>';
            
            datiDomanda.soci.forEach((socio, index) => {
                html += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.nome}" onchange="datiDomanda.soci[${index}].nome=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.sede}" onchange="datiDomanda.soci[${index}].sede=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${socio.cf}" onchange="datiDomanda.soci[${index}].cf=this.value"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${socio.quotaPartecipazione}" onchange="datiDomanda.soci[${index}].quotaPartecipazione=parseFloat(this.value)"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${socio.quotaVoto}" onchange="datiDomanda.soci[${index}].quotaVoto=parseFloat(this.value)"></td>
                        <td><button class="btn btn-sm btn-danger" onclick="rimuoviSocio(${socio.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function aggiungiAiuto() {
            const id = Date.now();
            if (!datiDomanda.aiutiDeMinimis) datiDomanda.aiutiDeMinimis = [];
            
            datiDomanda.aiutiDeMinimis.push({
                id: id,
                ente: '',
                normativa: '',
                data: '',
                importo: 0
            });
            
            aggiornaListaAiuti();
        }
        
        function rimuoviAiuto(id) {
            datiDomanda.aiutiDeMinimis = datiDomanda.aiutiDeMinimis.filter(a => a.id !== id);
            aggiornaListaAiuti();
        }
        
        function aggiornaListaAiuti() {
            const container = document.getElementById('listaAiuti');
            
            if (!datiDomanda.aiutiDeMinimis || datiDomanda.aiutiDeMinimis.length === 0) {
                container.innerHTML = '<p class="text-muted">Nessun aiuto de minimis dichiarato</p>';
                aggiornaTotaleDeMinimis();
                return;
            }
            
            let html = '<table class="table table-sm table-bordered">';
            html += '<thead><tr><th>Ente Erogante</th><th>Normativa</th><th>Data</th><th>Importo €</th><th></th></tr></thead><tbody>';
            
            datiDomanda.aiutiDeMinimis.forEach((aiuto, index) => {
                html += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" value="${aiuto.ente}" onchange="datiDomanda.aiutiDeMinimis[${index}].ente=this.value"></td>
                        <td><input type="text" class="form-control form-control-sm" value="${aiuto.normativa}" onchange="datiDomanda.aiutiDeMinimis[${index}].normativa=this.value"></td>
                        <td><input type="date" class="form-control form-control-sm" value="${aiuto.data}" onchange="datiDomanda.aiutiDeMinimis[${index}].data=this.value"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${aiuto.importo}" onchange="datiDomanda.aiutiDeMinimis[${index}].importo=parseFloat(this.value);aggiornaTotaleDeMinimis()"></td>
                        <td><button class="btn btn-sm btn-danger" onclick="rimuoviAiuto(${aiuto.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            aggiornaTotaleDeMinimis();
        }
        
        function aggiornaTotaleDeMinimis() {
            const totale = datiDomanda.aiutiDeMinimis ? datiDomanda.aiutiDeMinimis.reduce((sum, a) => sum + (a.importo || 0), 0) : 0;
            const contributo = getNumericValue('contributoRichiesto');
            const cumulato = totale + contributo;
            
            setTextValue('totaleDeMinimis', formatEuro(totale));
            setTextValue('contributoRichiestoRiepilogo', formatEuro(contributo));
            setTextValue('totaleCumulato', formatEuro(cumulato));
            
            const alertDiv = document.getElementById('alertDeMinimis');
            if (cumulato > 300000) {
                alertDiv.style.display = 'block';
            } else {
                alertDiv.style.display = 'none';
            }
        }
        
        // ============================================
        // RIEPILOGO FASI
        // ============================================
        function aggiornaRiepilogoFase4() {
            setTextValue('recap_ragioneSociale', datiDomanda.anagrafica?.ragioneSociale || '-');
            setTextValue('recap_partitaIva', datiDomanda.anagrafica?.partitaIva || '-');
            
            const dim = datiDomanda.anagrafica?.dimensioneImpresa || '';
            const dimNome = {
                'micro': 'Microimpresa',
                'piccola': 'Piccola Impresa',
                'media': 'Media Impresa'
            }[dim] || '-';
            setTextValue('recap_dimensione', dimNome);
            
            const totInv = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            setTextValue('recap_investimento', formatEuro(totInv));
            
            const contributo = getNumericValue('contributoRichiesto');
            setTextValue('recap_contributo', formatEuro(contributo));
            
            const regime = datiDomanda.mol?.regimeAiuto || '';
            const regimeNome = {
                'deminimis': 'De Minimis (Max 60%)',
                'esenzione': 'Esenzione (Art. 14)'
            }[regime] || '-';
            setTextValue('recap_regime', regimeNome);
            
            const valore = datiDomanda.mol?.valoreProduzione || 0;
            const costi = (datiDomanda.mol?.materiePrime || 0) + (datiDomanda.mol?.costiServizi || 0) + 
                         (datiDomanda.mol?.costiBeniTerzi || 0) + (datiDomanda.mol?.spesePersonale || 0) + 
                         (datiDomanda.mol?.variazioniRimanenze || 0) + (datiDomanda.mol?.oneriDiversi || 0);
            const mol = valore - costi;
            setTextValue('recap_mol', formatEuro(mol));
            
            const ordinatore = totInv > 0 ? (mol / totInv).toFixed(5).replace('.', ',') : '0,00000';
            setTextValue('recap_ordinatore', ordinatore);
        }
        
        function aggiornaRiepilogoFinale() {
            // Dati impresa
            setTextValue('final_ragioneSociale', datiDomanda.anagrafica?.ragioneSociale || '-');
            setTextValue('final_partitaIva', datiDomanda.anagrafica?.partitaIva || '-');
            
            const dim = datiDomanda.anagrafica?.dimensioneImpresa || '';
            const dimNome = {
                'micro': 'Microimpresa',
                'piccola': 'Piccola',
                'media': 'Media'
            }[dim] || '-';
            setTextValue('final_dimensione', dimNome);
            
            setTextValue('final_ateco', datiDomanda.anagrafica?.codiceAteco || '-');
            setTextValue('final_sedIntervento', datiDomanda.unitaProduttiva?.indirizzo || '-');
            
            // Dati economici
            const valore = datiDomanda.mol?.valoreProduzione || 0;
            const costi = (datiDomanda.mol?.materiePrime || 0) + (datiDomanda.mol?.costiServizi || 0) + 
                         (datiDomanda.mol?.costiBeniTerzi || 0) + (datiDomanda.mol?.spesePersonale || 0) + 
                         (datiDomanda.mol?.variazioniRimanenze || 0) + (datiDomanda.mol?.oneriDiversi || 0);
            const mol = valore - costi;
            setTextValue('final_mol', formatEuro(mol));
            
            const totInv = datiDomanda.preventivi ? datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0) : 0;
            setTextValue('final_investimento', formatEuro(totInv));
            
            const contributo = datiDomanda.mol?.contributoRichiesto || 0;
            setTextValue('final_contributo', formatEuro(contributo));
            
            const regime = datiDomanda.mol?.regimeAiuto || '';
            const regimeNome = {
                'deminimis': 'De Minimis',
                'esenzione': 'Esenzione'
            }[regime] || '-';
            setTextValue('final_regime', regimeNome);
            
            const ordinatore = totInv > 0 ? (mol / totInv).toFixed(5).replace('.', ',') : '0,00000';
            setTextValue('final_ordinatore', ordinatore);
            
            // Performance
            const epgl_ante = datiDomanda.diagnosi?.epgl_ante || 0;
            const epgl_post = datiDomanda.diagnosi?.epgl_post || 0;
            const risparmio = epgl_ante > 0 ? ((epgl_ante - epgl_post) / epgl_ante) * 100 : 0;
            setTextValue('final_risparmio', risparmio.toFixed(2) + '%');
            
            const co2_ante = datiDomanda.diagnosi?.co2_ante || 0;
            const co2_post = datiDomanda.diagnosi?.co2_post || 0;
            const ridCO2 = co2_ante > 0 ? ((co2_ante - co2_post) / co2_ante) * 100 : 0;
            setTextValue('final_co2', ridCO2.toFixed(2) + '%');
            
            const fer_ante = datiDomanda.diagnosi?.fer_ante || 0;
            const fer_post = datiDomanda.diagnosi?.fer_post || 0;
            const incFER = fer_ante > 0 ? ((fer_post - fer_ante) / fer_ante) * 100 : (fer_post > 0 ? 100 : 0);
            setTextValue('final_fer', incFER.toFixed(2) + '%');
            
            // Punteggio
            calcolaPunteggi();
            const punteggioText = document.getElementById('punteggioTotale').textContent;
            setTextValue('final_punteggio', punteggioText);
            
            const punteggio = parseInt(punteggioText) || 0;
            const ammText = punteggio >= 50 ? 
                '<span class="badge bg-success">✓ AMMISSIBILE</span>' :
                '<span class="badge bg-danger">✗ NON AMMISSIBILE</span>';
            document.getElementById('final_ammissibilita').innerHTML = ammText;
        }
        
        
        // ============================================
        // EXPORT PDF
        // ============================================
        function esportaDomandaPDF() {
            alert('📄 Generazione PDF Domanda (Allegato 2.1.A)\n\nLa funzione genererà il PDF della domanda completa con tutte le dichiarazioni.\n\nIn questa versione, usa la funzione "Stampa" del browser e salva come PDF.');
            window.print();
        }
        
        function esportaFormularioPDF() {
            alert('📄 Generazione PDF Formulario (Allegato F)\n\nLa funzione genererà il PDF del formulario completo del progetto.\n\nIn questa versione, usa la funzione "Stampa" del browser e salva come PDF.');
            window.print();
        }
        
        function esportaDSANPDF() {
            alert('📄 Generazione PDF DSAN (Allegato C)\n\nLa funzione genererà il PDF della dichiarazione MOL.\n\nIn questa versione, usa la funzione "Stampa" del browser e salva come PDF.');
            window.print();
        }
        
        function esportaRiepilogoPDF() {
            alert('📄 Generazione PDF Riepilogo Completo\n\nIn questa versione, usa la funzione "Stampa" del browser e salva come PDF.');
            window.print();
        }
        
        function esportaExcel() {
            alert('📊 Generazione Excel Budget\n\nLa funzione genererà un file Excel con il quadro economico dettagliato.\n\nFunzionalità in sviluppo.');
        }
        
        // ============================================
        // SALVATAGGIO/CARICAMENTO PROGETTO
        // ============================================
        function salvaProgettoSuFile() {
            salvaDatiFase(currentStep);
            
            const nomeProgetto = datiDomanda.anagrafica?.ragioneSociale || 'Progetto_SiciliaEfficiente';
            
            const progetto = {
                metadata: {
                    applicazione: 'Sicilia Efficiente',
                    versione: '1.0',
                    nomeProgetto: nomeProgetto,
                    dataSalvataggio: new Date().toISOString(),
                    faseCorrente: currentStep
                },
                datiDomanda: datiDomanda
            };
            
            const json = JSON.stringify(progetto, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nomeProgetto.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            alert('✅ Progetto salvato con successo!');
        }
        
        function caricaProgettoDaFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const progetto = JSON.parse(e.target.result);
                    
                    if (!progetto.metadata || progetto.metadata.applicazione !== 'Sicilia Efficiente') {
                        alert('❌ File non valido!\n\nQuesto non sembra essere un progetto Sicilia Efficiente.');
                        return;
                    }
                    
                    const conferma = confirm(
                        '📂 CARICAMENTO PROGETTO\n\n' +
                        'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                        'P.IVA: ' + (progetto.datiDomanda?.anagrafica?.partitaIva || 'N/D') + '\n' +
                        'Salvato il: ' + new Date(progetto.metadata.dataSalvataggio).toLocaleString('it-IT') + '\n' +
                        'Fase: ' + progetto.metadata.faseCorrente + '\n\n' +
                        'Tutti i dati correnti verranno sovrascritti.\n\nContinuare?'
                    );
                    
                    if (!conferma) return;
                    
                    datiDomanda = progetto.datiDomanda;
                    const faseSalvata = progetto.metadata.faseCorrente || 1;
                    goToStep(faseSalvata);
                    
                    alert('✅ Progetto caricato con successo!');
                    
                } catch (error) {
                    alert('❌ Errore nel caricamento del file:\n\n' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function nuovoProgetto() {
            if (confirm('⚠️ ATTENZIONE\n\nCreare un nuovo progetto cancellerà tutti i dati correnti.\n\nContinuare?')) {
                datiDomanda = {
                    anagrafica: {},
                    legaleRappresentante: {},
                    unitaProduttiva: {},
                    mol: {},
                    dimensioneAziendale: {},
                    soci: [],
                    aiutiDeMinimis: [],
                    professionista: {},
                    diagnosi: {},
                    preventivi: [],
                    istanza: {},
                    formulario: {},
                    export: {}
                };
                
                localStorage.removeItem('siciliaEfficienteDomanda');
                goToStep(1);
                
                alert('✅ Nuovo progetto creato');
            }
        }
        
        function ripristinaBackupAutomatico() {
            const backup = localStorage.getItem('siciliaEfficienteDomanda');
            
            if (!backup) {
                alert('ℹ️ Nessun backup automatico trovato');
                return;
            }
            
            try {
                const lastSave = localStorage.getItem('siciliaEfficienteLastSave');
                const dataMsg = lastSave ? 
                    '\n\nUltimo salvataggio: ' + new Date(lastSave).toLocaleString('it-IT') : '';
                
                const conferma = confirm(
                    '💾 RIPRISTINO BACKUP AUTOMATICO' + dataMsg + '\n\n' +
                    'Tutti i dati correnti verranno sovrascritti.\n\nContinuare?'
                );
                
                if (!conferma) return;
                
                datiDomanda = JSON.parse(backup);
                goToStep(currentStep);
                
                alert('✅ Backup ripristinato con successo!');
                
            } catch (error) {
                alert('❌ Errore nel ripristino del backup:\n\n' + error.message);
            }
        }
        
        function salvaAutomaticamente() {
            try {
                salvaDatiFase(currentStep);
                localStorage.setItem('siciliaEfficienteDomanda', JSON.stringify(datiDomanda));
                localStorage.setItem('siciliaEfficienteLastSave', new Date().toISOString());
                console.log('💾 Auto-save:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('❌ Errore auto-save:', error);
            }
        }
        
        function finalizza() {
            salvaDatiFase(6);
            
            const completezza = verificaCompletezza();
            
            let msg = '🎉 PROGETTO FINALIZZATO\n\n';
            msg += 'Impresa: ' + (datiDomanda.anagrafica?.ragioneSociale || 'N/D') + '\n';
            msg += 'P.IVA: ' + (datiDomanda.anagrafica?.partitaIva || 'N/D') + '\n';
            msg += 'Investimento: ' + formatEuro(datiDomanda.preventivi ? datiDomanda.preventivi.reduce((s,p) => s + p.importo, 0) : 0) + '\n\n';
            msg += 'Completezza: ' + completezza.percentuale + '%\n';
            
            if (completezza.campiMancanti.length > 0) {
                msg += '\n⚠️ Campi mancanti:\n' + completezza.campiMancanti.slice(0,5).join('\n');
                if (completezza.campiMancanti.length > 5) {
                    msg += '\n... e altri ' + (completezza.campiMancanti.length - 5) + ' campi';
                }
            }
            
            msg += '\n\n✅ Ricordati di:\n';
            msg += '1. Salvare il progetto\n';
            msg += '2. Esportare PDF e Excel\n';
            msg += '3. Preparare i documenti richiesti\n';
            msg += '4. Caricare sulla piattaforma ufficiale';
            
            alert(msg);
        }
        
        function verificaCompletezza() {
            const campiMancanti = [];
            let totCampi = 0;
            let campiCompilati = 0;
            
            // Verifica Fase 1
            const f1Fields = ['ragioneSociale', 'partitaIva', 'codiceAteco', 'dimensioneImpresa'];
            totCampi += f1Fields.length;
            f1Fields.forEach(field => {
                if (datiDomanda.anagrafica?.[field]) campiCompilati++;
                else campiMancanti.push('Fase 1: ' + field);
            });
            
            // Verifica Fase 2
            totCampi += 2;
            if (datiDomanda.mol?.valoreProduzione) campiCompilati++;
            else campiMancanti.push('Fase 2: MOL');
            
            if (datiDomanda.mol?.costoTotaleInvestimento) campiCompilati++;
            else campiMancanti.push('Fase 2: Costo investimento');
            
            // Verifica Fase 3
            totCampi += 2;
            if (datiDomanda.diagnosi?.epgl_ante) campiCompilati++;
            else campiMancanti.push('Fase 3: Diagnosi energetica');
            
            if (datiDomanda.preventivi?.length > 0) campiCompilati++;
            else campiMancanti.push('Fase 3: Preventivi');
            
            const percentuale = Math.round((campiCompilati / totCampi) * 100);
            
            return {
                percentuale: percentuale,
                campiMancanti: campiMancanti
            };
        }
        

        // ============================================
        // FUNZIONI H2 - PIANO COPERTURE FINANZIARIE
        // ============================================
        function calcolaH2() {
            // IMPIEGHI
            const inv_immat_anno1 = getNumericValue('h2_inv_immat_anno1');
            const inv_immat_tot = getNumericValue('h2_inv_immat_tot');
            const inv_mat_anno1 = getNumericValue('h2_inv_mat_anno1');
            const inv_mat_tot = getNumericValue('h2_inv_mat_tot');
            const iva_anno1 = getNumericValue('h2_iva_anno1');
            const iva_tot = getNumericValue('h2_iva_tot');
            
            const tot_impieghi_anno1 = inv_immat_anno1 + inv_mat_anno1 + iva_anno1;
            const tot_impieghi_tot = inv_immat_tot + inv_mat_tot + iva_tot;
            
            setTextValue('h2_tot_impieghi_anno1', formatEuro(tot_impieghi_anno1));
            setTextValue('h2_tot_impieghi_tot', formatEuro(tot_impieghi_tot));
            
            // Percentuali impieghi
            if (tot_impieghi_tot > 0) {
                setValue('h2_inv_immat_perc', ((inv_immat_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_inv_mat_perc', ((inv_mat_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_iva_perc', ((iva_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
            }
            
            // FONTI
            const contributo_anno1 = getNumericValue('h2_contributo_anno1');
            const contributo_tot = contributo_anno1; // Di solito uguale
            setValue('h2_contributo_tot', contributo_tot.toFixed(2));
            
            const cap_sociale_anno1 = getNumericValue('h2_cap_sociale_anno1');
            const cap_sociale_tot = getNumericValue('h2_cap_sociale_tot');
            const finanz_soci_anno1 = getNumericValue('h2_finanz_soci_anno1');
            const finanz_soci_tot = getNumericValue('h2_finanz_soci_tot');
            const riserve_anno1 = getNumericValue('h2_riserve_anno1');
            const riserve_tot = getNumericValue('h2_riserve_tot');
            const finanz_ml_anno1 = getNumericValue('h2_finanz_ml_anno1');
            const finanz_ml_tot = getNumericValue('h2_finanz_ml_tot');
            const finanz_breve_anno1 = getNumericValue('h2_finanz_breve_anno1');
            const finanz_breve_tot = getNumericValue('h2_finanz_breve_tot');
            
            const tot_fonti_anno1 = contributo_anno1 + cap_sociale_anno1 + finanz_soci_anno1 + 
                                    riserve_anno1 + finanz_ml_anno1 + finanz_breve_anno1;
            const tot_fonti_tot = contributo_tot + cap_sociale_tot + finanz_soci_tot + 
                                  riserve_tot + finanz_ml_tot + finanz_breve_tot;
            
            setTextValue('h2_tot_fonti_anno1', formatEuro(tot_fonti_anno1));
            setTextValue('h2_tot_fonti_tot', formatEuro(tot_fonti_tot));
            
            // Percentuali fonti
            if (tot_impieghi_tot > 0) {
                setValue('h2_contributo_perc', ((contributo_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_cap_sociale_perc', ((cap_sociale_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_soci_perc', ((finanz_soci_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_riserve_perc', ((riserve_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_ml_perc', ((finanz_ml_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                setValue('h2_finanz_breve_perc', ((finanz_breve_tot / tot_impieghi_tot) * 100).toFixed(2) + '%');
                
                const perc_fonti = (tot_fonti_tot / tot_impieghi_tot) * 100;
                setTextValue('h2_tot_fonti_perc', perc_fonti.toFixed(2) + '%');
            }
            
            // BILANCIAMENTO
            const sbilanciamento = tot_fonti_tot - tot_impieghi_tot;
            setTextValue('h2_sbilanciamento', formatEuro(sbilanciamento));
            
            const alertDiv = document.getElementById('alertBilanciamento');
            if (Math.abs(sbilanciamento) > 0.01) {
                if (alertDiv) alertDiv.style.display = 'block';
            } else {
                if (alertDiv) alertDiv.style.display = 'none';
            }
        }
        
        // ============================================
        // FUNZIONI H3 - SOSTENIBILITÀ
        // ============================================
        function calcolaH3(anno) {
            const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
            
            anni.forEach(function(a) {
                // Ottieni valori
                const fatt = parseFloat(document.getElementById('h3_fatt_' + a).value) || 0;
                const altri = parseFloat(document.getElementById('h3_altri_' + a).value) || 0;
                const mp = parseFloat(document.getElementById('h3_mp_' + a).value) || 0;
                const serv = parseFloat(document.getElementById('h3_serv_' + a).value) || 0;
                const god = parseFloat(document.getElementById('h3_god_' + a).value) || 0;
                const pers = parseFloat(document.getElementById('h3_pers_' + a).value) || 0;
                const amm = parseFloat(document.getElementById('h3_amm_' + a).value) || 0;
                const fin = parseFloat(document.getElementById('h3_fin_' + a).value) || 0;
                const straord = parseFloat(document.getElementById('h3_straord_' + a).value) || 0;
                const imp = parseFloat(document.getElementById('h3_imp_' + a).value) || 0;
                const attivo = parseFloat(document.getElementById('h3_attivo_' + a).value) || 0;
                
                // Calcola Valore Produzione
                const vp = fatt + altri;
                document.getElementById('h3_vp_' + a).value = vp.toFixed(2);
                
                // Calcola MOL
                const mol = vp - mp - serv - god - pers;
                document.getElementById('h3_mol_' + a).value = mol.toFixed(2);
                
                // Calcola Risultato Operativo (EBIT)
                const ro = mol - amm;
                document.getElementById('h3_ro_' + a).value = ro.toFixed(2);
                
                // Calcola Risultato Lordo
                const rl = ro + fin + straord;
                document.getElementById('h3_rl_' + a).value = rl.toFixed(2);
                
                // Calcola Risultato Netto
                const rn = rl - imp;
                document.getElementById('h3_rn_' + a).value = rn.toFixed(2);
                
                // Calcola indici H.4
                // ROI = EBIT / Attivo × 100
                let roi = '';
                if (attivo > 0) {
                    roi = ((ro / attivo) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_roi_' + a).value = roi;
                
                // ROS = EBIT / Fatturato × 100
                let ros = '';
                if (fatt > 0) {
                    ros = ((ro / fatt) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_ros_' + a).value = ros;
                
                // Margine contribuzione = MOL / Fatturato × 100
                let marg = '';
                if (fatt > 0) {
                    marg = ((mol / fatt) * 100).toFixed(2) + '%';
                }
                document.getElementById('h4_marg_' + a).value = marg;
            });
        }
        
        function calcolaIndiciH3() {
            const ebit_n3 = parseFloat(getValue('h3_EBIT_n3').replace(/[€.,]/g, '')) || 0;
            const fatturato_n3 = getNumericValue('h3_A_n3');
            
            // Usa investimento totale dai preventivi
            const investimento = datiDomanda.preventivi ? 
                datiDomanda.preventivi.reduce((s,p) => s + p.importo, 0) : 0;
            
            // ROI = EBIT / Investimento × 100
            const roi = investimento > 0 ? (ebit_n3 / investimento) * 100 : 0;
            setTextValue('h3_roi', roi.toFixed(2) + '%');
            
            // ROS = EBIT / Fatturato × 100
            const ros = fatturato_n3 > 0 ? (ebit_n3 / fatturato_n3) * 100 : 0;
            setTextValue('h3_ros', ros.toFixed(2) + '%');
            
            // CAGR Fatturato
            const fatt_2024 = getNumericValue('h3_A_2024');
            if (fatt_2024 > 0 && fatturato_n3 > 0) {
                const cagr_fatt = (Math.pow(fatturato_n3 / fatt_2024, 1/3) - 1) * 100;
                setTextValue('h3_cagr_fatt', cagr_fatt.toFixed(2) + '%');
            }
            
            // CAGR EBIT
            const ebit_2024_str = getValue('h3_EBIT_2024').replace(/[€.,]/g, '');
            const ebit_2024 = parseFloat(ebit_2024_str) || 0;
            if (ebit_2024 > 0 && ebit_n3 > 0) {
                const cagr_ebit = (Math.pow(ebit_n3 / ebit_2024, 1/3) - 1) * 100;
                setTextValue('h3_cagr_ebit', cagr_ebit.toFixed(2) + '%');
            }
        }
        
        // ============================================
        // UTILITY
        // ============================================
        function formatEuro(value) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            return '€ ' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.').replace('.', ',').replace(/,(\d{2})$/, '.$1');
        }
        
        // ============================================
        // INIZIALIZZAZIONE
        // ============================================
        
        // Auto-save ogni 30 secondi
        setInterval(salvaAutomaticamente, 30000);
        
        // Carica backup all'avvio
        window.addEventListener('load', function() {
            const backup = localStorage.getItem('siciliaEfficienteDomanda');
            if (backup) {
                try {
                    datiDomanda = JSON.parse(backup);
                    caricaDatiFase(1);
                    console.log('✅ Backup automatico caricato');
                } catch (error) {
                    console.error('❌ Errore caricamento backup:', error);
                }
            }
        });
        
        // Mostra/nascondi sezione de minimis in base al regime
        document.addEventListener('change', function(e) {
            if (e.target.name === 'regimeAiuto') {
                const regime = e.target.value;
                const sezioneDeMinimis = document.getElementById('sezioneDeMinimis');
                const sezioneDeMinimisIstanza = document.getElementById('sezioneDeMinimisIstanza');
                
                if (regime === 'deminimis') {
                    if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'block';
                    if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'block';
                } else {
                    if (sezioneDeMinimis) sezioneDeMinimis.style.display = 'none';
                    if (sezioneDeMinimisIstanza) sezioneDeMinimisIstanza.style.display = 'none';
                }
            }
        });
        
        console.log('✅ Sicilia Efficiente - Applicazione caricata');

        // ============================================
        // GESTIONE TABELLE FORMULARIO
        // ============================================
        
        // Tabella Work Package
        let wpCounter = 0;
        
        function aggiungiRigaWP() {
            wpCounter++;
            const tbody = document.getElementById('tabellaWP');
            
            // Rimuovi placeholder se presente
            if (tbody.rows.length === 1 && tbody.rows[0].cells.length === 1) {
                tbody.innerHTML = '';
            }
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_og" placeholder="OG1"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_os" placeholder="OS1.1"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_wp" placeholder="WP1"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_task" placeholder="A1.1"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_deliverable" placeholder="D1.1"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_output" placeholder="R1.1"></td>
                <td><input type="number" class="form-control form-control-sm" id="wp${wpCounter}_budget" step="0.01" placeholder="0.00"></td>
                <td><input type="text" class="form-control form-control-sm" id="wp${wpCounter}_kpi" placeholder="KPI 1.1"></td>
                <td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaWP(this)"><i class="fas fa-trash"></i></button></td>
            `;
            
            if (!datiDomanda.workPackages) datiDomanda.workPackages = [];
            datiDomanda.workPackages.push({
                id: wpCounter,
                og: '', os: '', wp: '', task: '', deliverable: '', output: '', budget: 0, kpi: ''
            });
        }
        
        function rimuoviRigaWP(btn) {
            const row = btn.closest('tr');
            const tbody = document.getElementById('tabellaWP');
            row.remove();
            
            if (tbody.rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <em>Nessun work package inserito. Usa il bottone qui sotto per aggiungere.</em>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Tabella Cronoprogramma
        let cronoCounter = 0;
        
        function aggiungiRigaCrono() {
            cronoCounter++;
            const tbody = document.getElementById('tabellaCrono');
            
            // Rimuovi placeholder se presente
            if (tbody.rows.length === 1 && tbody.rows[0].cells.length === 1) {
                tbody.innerHTML = '';
            }
            
            const row = tbody.insertRow();
            let html = `<td><input type="text" class="form-control form-control-sm" id="crono${cronoCounter}_nome" placeholder="WP1/Task1"></td>`;
            
            for (let m = 1; m <= 12; m++) {
                html += `<td class="text-center"><input type="checkbox" id="crono${cronoCounter}_m${m}"></td>`;
            }
            
            html += `<td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaCrono(this)"><i class="fas fa-trash"></i></button></td>`;
            row.innerHTML = html;
            
            if (!datiDomanda.cronoprogramma) datiDomanda.cronoprogramma = [];
            datiDomanda.cronoprogramma.push({
                id: cronoCounter,
                nome: '',
                mesi: [false, false, false, false, false, false, false, false, false, false, false, false]
            });
        }
        
        function rimuoviRigaCrono(btn) {
            const row = btn.closest('tr');
            const tbody = document.getElementById('tabellaCrono');
            row.remove();
            
            if (tbody.rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center text-muted">
                            <em>Nessuna attività inserita. Usa il bottone qui sotto per aggiungere.</em>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Calcolo Budget Totale (Tabella 3)
        function calcolaBudgetTotale() {
            const voci = ['a', 'b', 'c', 'd', 'e'];
            let totaleAmmissibile = 0;
            let totaleContributo = 0;
            let totaleImpresa = 0;
            
            voci.forEach(voce => {
                const ammissibile = getNumericValue(`budget_${voce}_totale`);
                const intensita = getNumericValue(`budget_${voce}_intensita`);
                
                const contributo = ammissibile * (intensita / 100);
                const costoImpresa = ammissibile - contributo;
                
                setValue(`budget_${voce}_contributo`, contributo.toFixed(2));
                setTextValue(`budget_${voce}_impresa`, formatEuro(costoImpresa));
                
                totaleAmmissibile += ammissibile;
                totaleContributo += contributo;
                totaleImpresa += costoImpresa;
            });
            
            setTextValue('budget_totale_ammissibile', formatEuro(totaleAmmissibile));
            setTextValue('budget_totale_contributo', formatEuro(totaleContributo));
            setTextValue('budget_totale_impresa', formatEuro(totaleImpresa));
            
            const intensitaMedia = totaleAmmissibile > 0 ? (totaleContributo / totaleAmmissibile) * 100 : 0;
            setTextValue('budget_intensita_media', intensitaMedia.toFixed(2) + '%');
            
            // Validazione limiti
            validaLimitiBudget(totaleAmmissibile);
        }
        
        function validaLimitiBudget(totale) {
            const speseEdili = getNumericValue('budget_c_totale');
            const speseTecniche = getNumericValue('budget_d_totale');
            const baseCalcolo = getNumericValue('budget_a_totale') + getNumericValue('budget_b_totale') + speseEdili;
            
            let messaggi = [];
            
            // Validazione min/max investimento
            if (totale < 50000) {
                messaggi.push('⚠️ Investimento inferiore al minimo (€ 50.000)');
            }
            if (totale > 500000) {
                messaggi.push('⚠️ Investimento superiore al massimo (€ 500.000)');
            }
            
            // Validazione 20% spese edili
            const maxEdili = totale * 0.20;
            if (speseEdili > maxEdili) {
                messaggi.push(`⚠️ Spese edili superiori al 20% (max ${formatEuro(maxEdili)})`);
            }
            
            // Validazione 10% spese tecniche
            const maxTecniche = baseCalcolo * 0.10;
            if (speseTecniche > maxTecniche) {
                messaggi.push(`⚠️ Spese tecniche superiori al 10% (max ${formatEuro(maxTecniche)})`);
            }
            
            // Mostra alert se ci sono problemi
            if (messaggi.length > 0) {
                console.warn('Validazione Budget:', messaggi);
            }
        }

    

        // INIZIALIZZAZIONE AL CARICAMENTO PAGINA
        window.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sicilia Efficiente caricato');
            
            // Mostra view-1 e attiva nav-fase1
            goToStep(1);
            
            // Carica dati salvati se esistono
            if (typeof caricaDatiSalvati === 'function') {
                try { caricaDatiSalvati(); } catch(e) {}
            }
            
            // Avvia auto-save se esiste
            if (typeof salvaAutomaticamente === 'function') {
                setInterval(salvaAutomaticamente, 30000); // ogni 30 secondi
            }
        });
    
        
        // ========== FUNZIONI AUTO-GENERAZIONE DA DIGIT ==========
        
        // Genera automaticamente Piano di Lavoro e Cronoprogramma
        function compilaAutomaticaWP() {
            if (!datiDomanda || !datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
                alert('⚠️ ATTENZIONE\n\nInserire prima i preventivi nella Fase 3!');
                return;
            }
            
            const conferma = confirm(
                '🎯 COMPILAZIONE AUTOMATICA PIANO DI LAVORO\n\n' +
                'Il sistema genererà:\n' +
                '• Work Packages (WP) basati sui preventivi inseriti\n' +
                '• Cronoprogramma distribuito su 12 mesi\n' +
                '• Deliverable e milestone\n' +
                '• KPI di realizzazione\n\n' +
                'Procedere?'
            );
            
            if (!conferma) return;
            
            // Analizza preventivi per tipologia
            const categoriePresenti = {};
            let totaleInv = 0;
            
            datiDomanda.preventivi.forEach(function(p) {
                const cat = p.categoria || 'a';
                if (!categoriePresenti[cat]) {
                    categoriePresenti[cat] = [];
                }
                categoriePresenti[cat].push(p);
                totaleInv += p.importo || 0;
            });
            
            // GENERA PIANO DI LAVORO
            let pianoLavoro = 'OBIETTIVO GENERALE | OBIETTIVO SPECIFICO | WP | AZIONI/TASK | DELIVERABLE | OUTPUT/RISULTATI | BUDGET | KPI\n\n';
            
            pianoLavoro += 'OG1: Efficientamento energetico dell\'impresa | ';
            
            // WP0: Diagnosi energetica
            pianoLavoro += 'OS0: Analizzare lo stato energetico attuale | WP0: Diagnosi Energetica | ';
            pianoLavoro += 'A0.1: Audit energetico ex-ante, A0.2: Identificazione interventi | ';
            pianoLavoro += 'D0.1: Report diagnosi energetica | R0.1: Baseline energetico definito | ';
            pianoLavoro += '€ 1.500 | KPI0: Diagnosi completata\n\n';
            
            // WP per categorie spesa
            let wpNum = 1;
            
            if (categoriePresenti['a'] && categoriePresenti['a'].length > 0) {
                const budgetA = categoriePresenti['a'].reduce(function(sum, p) { return sum + (p.importo || 0); }, 0);
                pianoLavoro += 'OS1: Riqualificare impianti produttivi | WP' + wpNum + ': Efficientamento Impianti | ';
                pianoLavoro += 'A1.1: Installazione nuovi macchinari, A1.2: Rifasamento elettrico, A1.3: Testing | ';
                pianoLavoro += 'D1.1: Impianti installati, D1.2: Certificazioni tecniche | ';
                pianoLavoro += 'R1.1: Impianti ad alta efficienza operativi | €' + budgetA.toFixed(2) + ' | ';
                pianoLavoro += 'KPI1: Riduzione consumi ≥30%\n\n';
                wpNum++;
            }
            
            if (categoriePresenti['b'] && categoriePresenti['b'].length > 0) {
                const budgetB = categoriePresenti['b'].reduce(function(sum, p) { return sum + (p.importo || 0); }, 0);
                pianoLavoro += 'OS2: Riqualificare involucro edilizio | WP' + wpNum + ': Efficientamento Edifici | ';
                pianoLavoro += 'A2.1: Cappotto termico, A2.2: Serramenti, A2.3: Illuminazione LED | ';
                pianoLavoro += 'D2.1: Lavori completati, D2.2: APE migliorato | ';
                pianoLavoro += 'R2.1: Edificio ad alte prestazioni energetiche | €' + budgetB.toFixed(2) + ' | ';
                pianoLavoro += 'KPI2: Classe energetica migliorata\n\n';
                wpNum++;
            }
            
            if (categoriePresenti['c'] && categoriePresenti['c'].length > 0) {
                const budgetC = categoriePresenti['c'].reduce(function(sum, p) { return sum + (p.importo || 0); }, 0);
                pianoLavoro += 'OS3: Installare FER per autoconsumo | WP' + wpNum + ': Impianti Rinnovabili | ';
                pianoLavoro += 'A3.1: Installazione fotovoltaico, A3.2: Sistema accumulo, A3.3: Allaccio rete | ';
                pianoLavoro += 'D3.1: Impianto FV operativo, D3.2: Autorizzazioni | ';
                pianoLavoro += 'R3.1: Autoconsumo energia rinnovabile | €' + budgetC.toFixed(2) + ' | ';
                pianoLavoro += 'KPI3: % autoconsumo ≥40%\n\n';
                wpNum++;
            }
            
            // WP Finale: Monitoraggio
            pianoLavoro += 'OS4: Monitorare e ottimizzare | WP' + wpNum + ': Monitoraggio & Ottimizzazione | ';
            pianoLavoro += 'A4.1: Sistema monitoraggio, A4.2: Formazione personale, A4.3: Report periodici | ';
            pianoLavoro += 'D4.1: Dashboard operativa, D4.2: Personale formato | ';
            pianoLavoro += 'R4.1: Controllo continuo dei consumi | €2.000 | ';
            pianoLavoro += 'KPI4: Report mensili pubblicati\n';
            
            // GENERA CRONOPROGRAMMA
            let cronoprogramma = 'WP | DESCRIZIONE | INIZIO | FINE | MILESTONE\n\n';
            cronoprogramma += 'WP0 | Diagnosi Energetica | M1 | M1 | M1: Diagnosi completata\n';
            
            const mesiPerWP = Math.floor(10 / wpNum);  // Distribuisci 10 mesi
            let meseCorrente = 2;
            
            for (let i = 1; i <= wpNum; i++) {
                const inizio = meseCorrente;
                const fine = Math.min(meseCorrente + mesiPerWP - 1, 11);
                cronoprogramma += 'WP' + i + ' | Implementazione Fase ' + i + ' | M' + inizio + ' | M' + fine + ' | M' + fine + ': Fase ' + i + ' completata\n';
                meseCorrente = fine + 1;
            }
            
            cronoprogramma += 'WP' + (wpNum + 1) + ' | Monitoraggio continuo | M2 | M12 | M12: Sistema a regime';
            
            // Inserisci nei campi
            document.getElementById('pianoLavoroMatrice').value = pianoLavoro;
            document.getElementById('cronoprogrammaDettaglio').value = cronoprogramma;
            
            alert('✅ PIANO DI LAVORO GENERATO!\n\n' +
                  'WP creati: ' + (wpNum + 1) + '\n' +
                  'Budget totale: €' + totaleInv.toFixed(2) + '\n\n' +
                  'Personalizza il contenuto secondo le tue esigenze.');
        }
        
        // Pre-compila H.2 Piano Coperture Finanziarie
        function precompilaDatiH2() {
            if (!datiDomanda || !datiDomanda.economia) {
                alert('⚠️ ATTENZIONE\n\nCompletare prima la Fase 2 (MOL e dimensione aziendale)!');
                return;
            }
            
            // Ottieni dati
            const totaleInv = parseFloat(document.getElementById('totaleInvestimento').value) || 0;
            
            if (totaleInv === 0) {
                alert('⚠️ ATTENZIONE\n\nInserire prima i preventivi nella Fase 3!');
                return;
            }
            
            // Calcola contributo (60% per Sicilia Efficiente)
            const contributo = totaleInv * 0.60;
            const cofinanziamento = totaleInv - contributo;
            
            // Suddividi immateriali/materiali
            let immateriali = 0;
            let materiali = 0;
            
            if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                datiDomanda.preventivi.forEach(function(p) {
                    // Categoria d (tecniche) e e (APE) sono immateriali
                    if (p.categoria === 'd' || p.categoria === 'e') {
                        immateriali += p.importo || 0;
                    } else {
                        materiali += p.importo || 0;
                    }
                });
            } else {
                // Default: tutto materiali
                materiali = totaleInv;
            }
            
            // Compila IMPIEGHI
            document.getElementById('h2_inv_immat_anno1').value = immateriali.toFixed(2);
            document.getElementById('h2_inv_immat_tot').value = immateriali.toFixed(2);
            document.getElementById('h2_inv_mat_anno1').value = materiali.toFixed(2);
            document.getElementById('h2_inv_mat_tot').value = materiali.toFixed(2);
            document.getElementById('h2_inv_iva_anno1').value = '0.00';
            document.getElementById('h2_inv_iva_tot').value = '0.00';
            
            // Compila FONTI
            document.getElementById('h2_contributo_anno1').value = contributo.toFixed(2);
            document.getElementById('h2_contributo_tot').value = contributo.toFixed(2);
            document.getElementById('h2_riserve_anno1').value = cofinanziamento.toFixed(2);
            document.getElementById('h2_riserve_tot').value = cofinanziamento.toFixed(2);
            
            // Azzera altri campi
            document.getElementById('h2_capitale_anno1').value = '0.00';
            document.getElementById('h2_capitale_tot').value = '0.00';
            document.getElementById('h2_soci_anno1').value = '0.00';
            document.getElementById('h2_soci_tot').value = '0.00';
            document.getElementById('h2_finml_anno1').value = '0.00';
            document.getElementById('h2_finml_tot').value = '0.00';
            document.getElementById('h2_finbr_anno1').value = '0.00';
            document.getElementById('h2_finbr_tot').value = '0.00';
            
            // Ricalcola
            calcolaH2();
            
            alert('✅ DATI H.2 PRE-COMPILATI!\n\n' +
                  'Investimento totale: €' + totaleInv.toFixed(2) + '\n' +
                  '├─ Immateriali: €' + immateriali.toFixed(2) + '\n' +
                  '└─ Materiali: €' + materiali.toFixed(2) + '\n\n' +
                  'Copertura finanziaria:\n' +
                  '├─ Contributo 60%: €' + contributo.toFixed(2) + '\n' +
                  '└─ Riserve 40%: €' + cofinanziamento.toFixed(2) + '\n\n' +
                  'Verifica e personalizza i valori.');
        }
        
        // Proietta automaticamente esercizi previsionali H.3
        function proiettaEserciziPrevisionali() {
            // Verifica dati storici
            const fatt_2023 = parseFloat(document.getElementById('h3_fatt_2023').value) || 0;
            const fatt_2024 = parseFloat(document.getElementById('h3_fatt_2024').value) || 0;
            
            if (fatt_2023 === 0 || fatt_2024 === 0) {
                alert('⚠️ ATTENZIONE\n\nInserire prima i dati storici 2023 e 2024!');
                return;
            }
            
            const conferma = confirm(
                '🎯 PROIEZIONE AUTOMATICA TRIENNALE\n\n' +
                'Il sistema proietterà gli anni n+1, n+2, n+3 basandosi su:\n\n' +
                '• Analisi trend storico 2023-2024\n' +
                '• Crescita organica stimata\n' +
                '• Impatto efficientamento energetico:\n' +
                '  - Riduzione costi energetici\n' +
                '  - Ammortamento investimento\n' +
                '  - Miglioramento competitività\n\n' +
                'Procedere?'
            );
            
            if (!conferma) return;
            
            // Calcola tasso crescita storico
            const crescitaFatt = fatt_2024 / fatt_2023;
            
            // Parametri proiezione
            const tassoBase = Math.max(1.03, Math.min(1.08, crescitaFatt));  // 3-8% annuo
            const impattoEfficienza = 0.05;  // 5% risparmio costi energetici
            
            // Ottieni tutti i valori 2024
            const altri_2024 = parseFloat(document.getElementById('h3_altri_2024').value) || 0;
            const mp_2024 = parseFloat(document.getElementById('h3_mp_2024').value) || 0;
            const serv_2024 = parseFloat(document.getElementById('h3_serv_2024').value) || 0;
            const god_2024 = parseFloat(document.getElementById('h3_god_2024').value) || 0;
            const pers_2024 = parseFloat(document.getElementById('h3_pers_2024').value) || 0;
            const amm_2024 = parseFloat(document.getElementById('h3_amm_2024').value) || 0;
            const fin_2024 = parseFloat(document.getElementById('h3_fin_2024').value) || 0;
            const straord_2024 = parseFloat(document.getElementById('h3_straord_2024').value) || 0;
            const imp_2024 = parseFloat(document.getElementById('h3_imp_2024').value) || 0;
            const attivo_2024 = parseFloat(document.getElementById('h3_attivo_2024').value) || 0;
            
            // Calcola ammortamento investimento (10 anni)
            const totaleInv = parseFloat(document.getElementById('totaleInvestimento').value) || 0;
            const ammInvestimento = totaleInv / 10;
            
            // PROIETTA n+1
            document.getElementById('h3_fatt_n1').value = (fatt_2024 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n1').value = (altri_2024 * tassoBase).toFixed(2);
            // Costi: crescita moderata con effetto efficienza
            document.getElementById('h3_mp_n1').value = (mp_2024 * tassoBase * (1 - impattoEfficienza * 0.3)).toFixed(2);
            document.getElementById('h3_serv_n1').value = (serv_2024 * tassoBase * (1 - impattoEfficienza * 0.5)).toFixed(2);
            document.getElementById('h3_god_n1').value = (god_2024 * tassoBase).toFixed(2);
            document.getElementById('h3_pers_n1').value = (pers_2024 * 1.02).toFixed(2);  // Crescita moderata
            document.getElementById('h3_amm_n1').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n1').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n1').value = '0.00';
            document.getElementById('h3_imp_n1').value = (imp_2024 * 1.05).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n1').value = (attivo_2024 + totaleInv * 0.3).toFixed(2);
            }
            
            // PROIETTA n+2
            const fatt_n1 = parseFloat(document.getElementById('h3_fatt_n1').value);
            const mp_n1 = parseFloat(document.getElementById('h3_mp_n1').value);
            const serv_n1 = parseFloat(document.getElementById('h3_serv_n1').value);
            
            document.getElementById('h3_fatt_n2').value = (fatt_n1 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n2').value = (altri_2024 * Math.pow(tassoBase, 2)).toFixed(2);
            document.getElementById('h3_mp_n2').value = (mp_n1 * tassoBase * (1 - impattoEfficienza * 0.4)).toFixed(2);
            document.getElementById('h3_serv_n2').value = (serv_n1 * tassoBase * (1 - impattoEfficienza * 0.6)).toFixed(2);
            document.getElementById('h3_god_n2').value = (god_2024 * Math.pow(tassoBase, 2)).toFixed(2);
            document.getElementById('h3_pers_n2').value = (pers_2024 * 1.04).toFixed(2);
            document.getElementById('h3_amm_n2').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n2').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n2').value = '0.00';
            document.getElementById('h3_imp_n2').value = (imp_2024 * 1.10).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n2').value = (attivo_2024 + totaleInv * 0.5).toFixed(2);
            }
            
            // PROIETTA n+3
            const fatt_n2 = parseFloat(document.getElementById('h3_fatt_n2').value);
            const mp_n2 = parseFloat(document.getElementById('h3_mp_n2').value);
            const serv_n2 = parseFloat(document.getElementById('h3_serv_n2').value);
            
            document.getElementById('h3_fatt_n3').value = (fatt_n2 * tassoBase).toFixed(2);
            document.getElementById('h3_altri_n3').value = (altri_2024 * Math.pow(tassoBase, 3)).toFixed(2);
            document.getElementById('h3_mp_n3').value = (mp_n2 * tassoBase * (1 - impattoEfficienza * 0.5)).toFixed(2);
            document.getElementById('h3_serv_n3').value = (serv_n2 * tassoBase * (1 - impattoEfficienza * 0.7)).toFixed(2);
            document.getElementById('h3_god_n3').value = (god_2024 * Math.pow(tassoBase, 3)).toFixed(2);
            document.getElementById('h3_pers_n3').value = (pers_2024 * 1.06).toFixed(2);
            document.getElementById('h3_amm_n3').value = (amm_2024 + ammInvestimento).toFixed(2);
            document.getElementById('h3_fin_n3').value = fin_2024.toFixed(2);
            document.getElementById('h3_straord_n3').value = '0.00';
            document.getElementById('h3_imp_n3').value = (imp_2024 * 1.15).toFixed(2);
            if (attivo_2024 > 0) {
                document.getElementById('h3_attivo_n3').value = (attivo_2024 + totaleInv * 0.7).toFixed(2);
            }
            
            // Ricalcola tutto
            calcolaH3();
            
            alert('✅ PROIEZIONE COMPLETATA!\n\n' +
                  'Dati proiettati per n+1, n+2, n+3 con:\n' +
                  '• Crescita organica: ' + ((tassoBase - 1) * 100).toFixed(1) + '% annuo\n' +
                  '• Impatto efficientamento: -' + (impattoEfficienza * 100) + '% costi energetici\n' +
                  '• Ammortamento investimento: €' + ammInvestimento.toFixed(2) + '/anno\n\n' +
                  'Verifica e personalizza i valori secondo le tue stime.');
        }
        

    </script>
</body>
</html>
